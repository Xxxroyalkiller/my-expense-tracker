<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        .app-card {
            background-color: #ffffff;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* shadow-md */
            padding: 1.5rem; /* p-6 */
            margin-bottom: 1.5rem; /* mb-6 */
        }
        .btn-primary {
            @apply bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50;
        }
        .btn-secondary {
            @apply bg-gray-200 text-gray-800 px-5 py-2 rounded-lg hover:bg-gray-300 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50;
        }
        .btn-danger {
            @apply bg-red-600 text-white px-5 py-2 rounded-lg hover:bg-red-700 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50;
        }
        .app-input {
            @apply w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500;
        }
        .app-select {
            @apply w-full p-3 border border-gray-300 rounded-lg bg-white appearance-none focus:ring-blue-500 focus:border-blue-500;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='none'%3e%3cpath d='M7 7l3-3 3 3m0 6l-3 3-3-3' stroke='%239CA3AF' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
        }
        .app-table {
            @apply min-w-full divide-y divide-gray-200;
        }
        .app-table th {
            @apply px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider;
        }
        .app-table td {
            @apply px-6 py-4 whitespace-nowrap text-sm text-gray-900;
        }
        .section-header {
            @apply text-3xl font-extrabold text-gray-900 mb-6;
        }
        .sub-section-header {
            @apply text-xl font-semibold text-gray-800 mb-4;
        }
        .message-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .message {
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            color: white;
            font-weight: 500;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            min-width: 250px;
            max-width: 350px;
        }
        .message.show {
            opacity: 1;
            transform: translateY(0);
        }
        .message-success { background-color: #4CAF50; }
        .message-error { background-color: #f44336; }
        .message-info { background-color: #2196F3; }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            color: white;
            font-size: 1.5rem;
            flex-direction: column;
            gap: 10px;
            pointer-events: all; /* Allow interaction with overlay */
        }
        .loading-spinner {
            border: 8px solid #f3f3f3; /* Light grey */
            border-top: 8px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .profile-dropdown-container {
            position: relative;
            display: inline-block;
        }

        .profile-button {
            background-color: #eff6ff; /* blue-50 */
            color: #1d4ed8; /* blue-700 */
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.25rem;
            cursor: pointer;
            border: 2px solid #93c5fd; /* blue-300 */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }

        .profile-button:hover {
            background-color: #dbeafe; /* blue-100 */
            border-color: #60a5fa; /* blue-400 */
        }

        .profile-picture {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .profile-dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: white;
            min-width: 250px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 0.5rem;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .profile-dropdown-content.show {
            display: block;
        }

        .dropdown-item {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: black;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .dropdown-item:hover {
            background-color: #f1f1f1;
        }
        
        .avatar-small {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #bfdbfe; /* blue-200 */
            color: #1e40af; /* blue-800 */
            font-weight: bold;
            font-size: 0.875rem;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: #fff;
            padding: 2.5rem; /* p-10 */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
            position: relative;
            width: 90%;
            max-width: 600px;
            max-height: 90vh; /* Limit height for scrollable content */
            overflow-y: auto; /* Enable scrolling for content that overflows */
        }

        .modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 2rem;
            color: #9ca3af; /* gray-400 */
            cursor: pointer;
            line-height: 1;
        }
        .modal-close-btn:hover {
            color: #6b7280; /* gray-500 */
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-spinner"></div>
        <p id="loadingMessage" class="text-xl font-semibold mt-4">Loading...</p>
    </div>

    <div id="messageContainer" class="message-container"></div>

    <div id="loginScreen" class="bg-white p-8 rounded-xl shadow-md w-full max-w-md text-center">
        <h1 class="text-3xl font-bold mb-6 text-gray-900">Welcome to Expense Tracker</h1>
        <p class="text-gray-600 mb-8">Sign in to manage your expenses.</p>
        <button id="googleSignInBtn" class="w-full bg-blue-600 text-white py-3 rounded-lg flex items-center justify-center gap-3 hover:bg-blue-700 transition duration-300 mb-4">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon" class="w-6 h-6">
            Sign in with Google
        </button>
        <button id="guestSignInBtn" class="w-full bg-gray-200 text-gray-800 py-3 rounded-lg flex items-center justify-center gap-3 hover:bg-gray-300 transition duration-300">
            <i class="fas fa-user text-gray-600"></i>
            Continue as Guest
        </button>
    </div>

    <div id="mainAppContainer" class="hidden w-full max-w-6xl">
        <div class="app-card flex flex-col md:flex-row items-center justify-between">
            <h1 class="text-4xl font-bold text-gray-900 section-header md:text-left mb-4 md:mb-0">Expense Tracker</h1>

            <div class="flex flex-col items-center md:items-start gap-2 mb-4 md:mb-0">
                <label for="currentDatasetSelect" class="text-sm font-medium text-gray-600">Current Dataset:</label>
                <div class="flex items-center gap-2">
                    <select id="currentDatasetSelect" class="app-input app-select px-4 py-2 rounded-lg text-lg font-semibold w-auto">
                        </select>
                    <button id="manageDatasetsBtn" class="btn-secondary p-2 rounded-full text-gray-700 hover:text-gray-900">
                        <i class="fas fa-cog"></i> </button>
                </div>
                <p id="currentDatasetDescription" class="text-gray-500 text-sm mt-1 text-center md:text-left hidden"></p>
            </div>
            <div class="profile-dropdown-container">
                <button id="profileButton" class="profile-button">
                    <img id="profilePicture" class="profile-picture hidden" alt="Profile Picture">
                    <span id="profileIconText">G</span>
                </button>
                <div id="profileDropdownContent" class="profile-dropdown-content">
                    <div class="dropdown-item">
                        <img id="avatarPicture" class="avatar-small hidden" alt="Avatar">
                        <span id="avatarInitial" class="avatar-small">G</span>
                        <span id="mainAppUserInfo" class="font-semibold text-gray-800">Guest User</span>
                    </div>
                    <hr class="border-gray-200 my-1">
                    <a href="#" id="settingsLink" class="dropdown-item">
                        <i class="fas fa-cog w-5"></i> Settings
                    </a>
                    <a href="#" id="signOutBtn" class="dropdown-item text-red-600 hover:bg-red-50">
                        <i class="fas fa-sign-out-alt w-5"></i> Sign Out
                    </a>
                </div>
            </div>
        </div>

        <div class="app-card">
            <h2 class="sub-section-header">Add New Expense</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="expenseDate" class="block text-sm font-medium text-gray-600 mb-1">Date</label>
                    <input type="date" id="expenseDate" class="app-input">
                </div>
                <div>
                    <label for="expenseCategory" class="block text-sm font-medium text-gray-600 mb-1">Category</label>
                    <input type="text" id="expenseCategory" placeholder="e.g., Groceries, Transport" class="app-input">
                </div>
                <div class="md:col-span-2">
                    <label for="expenseDescription" class="block text-sm font-medium text-gray-600 mb-1">Description</label>
                    <input type="text" id="expenseDescription" placeholder="e.g., Weekly shopping, Uber ride" class="app-input">
                </div>
                <div>
                    <label for="expenseAmount" class="block text-sm font-medium text-gray-600 mb-1">Amount (CAD)</label>
                    <input type="number" id="expenseAmount" placeholder="e.g., 50.00" step="0.01" class="app-input">
                </div>
                <div>
                    <label for="paymentMethod" class="block text-sm font-medium text-gray-600 mb-1">Payment Method</label>
                    <input type="text" id="paymentMethod" placeholder="e.g., Credit Card, Cash" class="app-input">
                </div>
                <div>
                    <label for="paidBy" class="block text-sm font-medium text-gray-600 mb-1">Paid By</label>
                    <input type="text" id="paidBy" placeholder="e.g., John, Jane" class="app-input">
                </div>
                <div class="flex items-center mt-3">
                    <input type="checkbox" id="hasBill" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label for="hasBill" class="ml-2 block text-sm text-gray-900">Has Bill?</label>
                </div>
                <div id="billTypeContainer" class="hidden">
                    <label for="billType" class="block text-sm font-medium text-gray-600 mb-1">Bill Type</label>
                    <input type="text" id="billType" placeholder="e.g., Digital, Physical" class="app-input">
                </div>
            </div>
            <button id="addExpenseBtn" class="btn-primary w-full">Add Expense</button>
        </div>

        <div class="app-card grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <h2 class="sub-section-header">Monthly Expenditure</h2>
                <canvas id="monthlyChart"></canvas>
            </div>
            <div>
                <h2 class="sub-section-header">Expenses by Category</h2>
                <canvas id="categoryChart"></canvas>
            </div>
        </div>

        <div class="app-card">
            <h2 class="sub-section-header">Upload Expenses from Excel</h2>
            <p class="text-gray-700 mb-4">Upload an Excel file (.xlsx, .xls) containing your expenses. Ensure your file has columns like 'Date', 'Category', 'Description', 'Amount', 'Payment Method', 'Paid By', 'Has Bill?', and 'Bill Type'.</p>
            <div class="flex flex-col md:flex-row items-center gap-4">
                <input type="file" id="excelUploadInput" accept=".xlsx, .xls" class="app-input flex-grow">
                <button id="uploadExcelBtn" class="btn-primary w-full md:w-auto mt-3 md:mt-0">
                    Upload Expenses
                </button>
            </div>
            <div id="uploadStatus" class="mt-4 p-3 text-sm rounded-lg hidden"></div>
        </div>

        <div class="app-card">
            <h2 class="sub-section-header">Export Data</h2>
            <div class="flex flex-col md:flex-row items-center gap-4">
                <button id="exportAllDataBtn" class="btn-secondary w-full md:w-auto">
                    Export All Data (Current Dataset)
                </button>
                <div class="flex-grow">
                    <label for="monthSelect" class="sr-only">Select Month</label>
                    <select id="monthSelect" class="app-select">
                        <option value="">Select Month</option>
                    </select>
                </div>
                <button id="downloadExcelBtn" class="btn-primary w-full md:w-auto mt-3 md:mt-0">
                    Download Monthly Data
                </button>
            </div>
        </div>

        <div class="app-card">
            <h2 class="sub-section-header">Your Expenses</h2>

            <div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <h3 class="text-lg font-semibold mb-3 text-gray-800">Filter Expenses</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div>
                        <label for="filterCategory" class="block text-sm font-medium text-gray-600 mb-1">Filter by Category</label>
                        <select id="filterCategory" class="app-input app-select">
                            <option value="">All Categories</option>
                            </select>
                    </div>
                    <div>
                        <label for="filterPaymentMethod" class="block text-sm font-medium text-gray-600 mb-1">Filter by Payment Method</label>
                        <select id="filterPaymentMethod" class="app-input app-select">
                            <option value="">All Methods</option>
                            </select>
                    </div>
                    <div class="col-span-full md:col-span-1">
                        <label class="block text-sm font-medium text-gray-600 mb-1">View Data From</label>
                        <div class="flex items-center space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="dataSourceFilter" value="" checked class="form-radio h-4 w-4 text-blue-600">
                                <span class="ml-2 text-gray-700">All Sources</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="dataSourceFilter" value="manual" class="form-radio h-4 w-4 text-blue-600">
                                <span class="ml-2 text-gray-700">Manual Entry</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="dataSourceFilter" value="uploaded" class="form-radio h-4 w-4 text-blue-600">
                                <span class="ml-2 text-gray-700">Uploaded File</span>
                            </label>
                        </div>
                    </div>
                    <div class="col-span-full md:col-span-1 flex justify-start md:justify-end">
                        <button id="clearFiltersBtn" class="btn-secondary w-full md:w-auto">Clear All Filters</button>
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto rounded-xl border border-gray-200 table-container">
                <table class="app-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Category</th>
                            <th>Description</th>
                            <th>Amount (CAD)</th>
                            <th>Amount (AED)</th>
                            <th>Amount (INR)</th>
                            <th>Payment Method</th>
                            <th>Paid By</th>
                            <th>Has Bill?</th>
                            <th>Bill Type</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="expenseTableBody" class="divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
            <div class="mt-6 p-4 bg-blue-50 rounded-lg text-blue-800 font-semibold text-lg flex justify-between items-center">
                <span>Total Expenditure (CAD):</span>
                <span id="totalExpenditureSpan">C$0.00</span>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button id="closeSettingsModal" class="modal-close-btn">&times;</button>
            <h2 class="section-header text-2xl mb-6">Settings</h2>
            <div class="mb-4">
                <label for="defaultCurrencySelect" class="block text-sm font-medium text-gray-700 mb-2">Default Display Currency:</label>
                <select id="defaultCurrencySelect" class="app-select">
                    <option value="CAD">CAD - Canadian Dollar</option>
                    <option value="AED">AED - United Arab Emirates Dirham</option>
                    <option value="INR">INR - Indian Rupee</option>
                </select>
            </div>
            <button id="saveSettingsBtn" class="btn-primary w-full">Save Settings</button>
        </div>
    </div>

    <div id="datasetModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button id="closeDatasetModal" class="modal-close-btn">&times;</button>
            <h2 class="section-header text-2xl mb-6">Manage Datasets</h2>
            <div class="space-y-6">
                <div>
                    <h3 class="sub-section-header text-xl mb-2">Create New Dataset</h3>
                    <label for="newDatasetName" class="block text-sm font-medium text-gray-600 mb-1">Dataset Name</label>
                    <input type="text" id="newDatasetName" placeholder="e.g., Summer Vacation 2024" class="app-input mb-3">
                    <label for="newDatasetDescription" class="block text-sm font-medium text-gray-600 mb-1">Description (Optional)</label>
                    <textarea id="newDatasetDescription" placeholder="e.g., Expenses for my trip to Hawaii" class="app-input resize-y min-h-[60px] mb-4"></textarea>
                    <button id="createDatasetBtn" class="btn-primary w-full">Create Dataset</button>
                </div>

                <hr class="border-gray-200">

                <div>
                    <h3 class="sub-section-header text-xl mb-2">Your Datasets</h3>
                    <ul id="datasetsList" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                        <li class="p-3 bg-gray-50 rounded-lg flex items-center justify-between">
                            <span>Loading datasets...</span>
                        </li>
                    </ul>
                    <p id="noDatasetsMessage" class="text-gray-500 mt-2 hidden">You haven't created any datasets yet.</p>
                </div>
            </div>
            <button id="doneDatasetBtn" class="btn-primary w-full mt-8">Done</button>
        </div>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, setDoc, getDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Your Firebase configuration
        // Replace with your actual Firebase project configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA_x5ENsCsHpcdYxgxi1a3vPs_vUR6Hkts",
  authDomain: "my-expenese-tracker.firebaseapp.com",
  projectId: "my-expenese-tracker",
  storageBucket: "my-expenese-tracker.firebasestorage.app",
  messagingSenderId: "466782350290",
  appId: "466782350290-0cljann4p9h7oqnboark3a5bj6ruilu0.apps.googleusercontent.com",
  measurementId: "G-1CF1ZNLPC2"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        // --- DOM Elements ---
        const loginScreen = document.getElementById('loginScreen');
        const googleSignInBtn = document.getElementById('googleSignInBtn');
        const guestSignInBtn = document.getElementById('guestSignInBtn');
        const mainAppContainer = document.getElementById('mainAppContainer');
        // const userInfoDiv = document.getElementById('userInfo'); // REMOVED - Using mainAppUserInfo instead
        const signOutBtn = document.getElementById('signOutBtn');
        const addExpenseBtn = document.getElementById('addExpenseBtn');
        const expenseDateInput = document.getElementById('expenseDate');
        const expenseCategoryInput = document.getElementById('expenseCategory');
        const expenseDescriptionInput = document.getElementById('expenseDescription');
        const expenseAmountInput = document.getElementById('expenseAmount');
        const paymentMethodInput = document.getElementById('paymentMethod');
        const paidByInput = document.getElementById('paidBy');
        const hasBillInput = document.getElementById('hasBill');
        const billTypeContainer = document.getElementById('billTypeContainer');
        const billTypeInput = document.getElementById('billType');
        const expenseTableBody = document.getElementById('expenseTableBody');
        const totalExpenditureSpan = document.getElementById('totalExpenditureSpan');
        const monthlyChartCanvas = document.getElementById('monthlyChart');
        const categoryChartCanvas = document.getElementById('categoryChart');
        const profileButton = document.getElementById('profileButton');
        const profileDropdownContent = document.getElementById('profileDropdownContent');
        const profilePicture = document.getElementById('profilePicture');
        const profileIconText = document.getElementById('profileIconText');
        const mainAppUserInfo = document.getElementById('mainAppUserInfo');
        const avatarPicture = document.getElementById('avatarPicture');
        const avatarInitial = document.getElementById('avatarInitial');
        const settingsLink = document.getElementById('settingsLink');
        const settingsModal = document.getElementById('settingsModal');
        const closeSettingsModalBtn = document.getElementById('closeSettingsModal');
        const defaultCurrencySelect = document.getElementById('defaultCurrencySelect');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const messageContainer = document.getElementById('messageContainer');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingMessage = document.getElementById('loadingMessage');
        const exportAllDataBtn = document.getElementById('exportAllDataBtn');
        const downloadExcelBtn = document.getElementById('downloadExcelBtn');
        const monthSelect = document.getElementById('monthSelect');
        const excelUploadInput = document.getElementById('excelUploadInput');
        const uploadExcelBtn = document.getElementById('uploadExcelBtn');
        const uploadStatus = document.getElementById('uploadStatus');

        // Filter Elements
        const filterCategorySelect = document.getElementById('filterCategory');
        const filterPaymentMethodSelect = document.getElementById('filterPaymentMethod');
        const clearFiltersBtn = document.getElementById('clearFiltersBtn');
        const dataSourceFilterRadios = document.querySelectorAll('input[name="dataSourceFilter"]');

        // Dataset Management Elements
        const currentDatasetSelect = document.getElementById('currentDatasetSelect');
        const manageDatasetsBtn = document.getElementById('manageDatasetsBtn');
        const currentDatasetDescription = document.getElementById('currentDatasetDescription');
        const datasetModal = document.getElementById('datasetModal');
        const closeDatasetModal = document.getElementById('closeDatasetModal');
        const newDatasetNameInput = document.getElementById('newDatasetName');
        const newDatasetDescriptionInput = document.getElementById('newDatasetDescription');
        const createDatasetBtn = document.getElementById('createDatasetBtn');
        const datasetsList = document.getElementById('datasetsList');
        const noDatasetsMessage = document.getElementById('noDatasetsMessage');
        const doneDatasetBtn = document.getElementById('doneDatasetBtn');

        // --- Global Variables ---
        let currentUserId = null;
        let expenses = [];
        let unsubscribeFromExpenses = null; // To manage Firestore listener
        let monthlyChartInstance = null;
        let categoryChartInstance = null;

        // Exchange rates (example, update as needed)
        const EXCHANGE_RATE_CAD_TO_AED = 2.67;
        const EXCHANGE_RATE_CAD_TO_INR = 61.27;

        // User Settings (default)
        let userSettings = {
            defaultCurrency: 'CAD'
        };

        // Filter state
        let currentFilterCategory = '';
        let currentFilterPaymentMethod = '';
        let currentDataSourceFilter = '';

        // Dataset state
        let currentDatasetId = null;
        let datasets = [];
        let currentDatasetInfo = null;

        // --- Utility Functions ---

        function showMessage(msg, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${type}`;
            messageDiv.textContent = msg;
            messageContainer.appendChild(messageDiv);

            setTimeout(() => {
                messageDiv.classList.add('show');
            }, 10); // Small delay to trigger CSS transition

            setTimeout(() => {
                messageDiv.classList.remove('show');
                messageDiv.addEventListener('transitionend', () => {
                    messageDiv.remove();
                });
            }, 5000); // Message disappears after 5 seconds
        }

        function showLoading(msg = "Loading...") {
            loadingMessage.textContent = msg;
            loadingOverlay.classList.remove('hidden');
        }

        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }

        // --- Firebase Auth Functions ---

        googleSignInBtn.addEventListener('click', async () => {
            showLoading("Signing in with Google...");
            try {
                await signInWithPopup(auth, googleProvider);
            } catch (error) {
                console.error("Google Sign-In Error:", error);
                showMessage(`Sign-in failed: ${error.message}`, "error");
            } finally {
                hideLoading();
            }
        });

        guestSignInBtn.addEventListener('click', async () => {
            showLoading("Signing in as Guest...");
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Guest Sign-In Error:", error);
                showMessage(`Guest sign-in failed: ${error.message}`, "error");
            } finally {
                hideLoading();
            }
        });

        signOutBtn.addEventListener('click', async () => {
            showLoading("Signing out...");
            try {
                await signOut(auth);
                showMessage('Signed out successfully!', 'info');
            } catch (error) {
                console.error("Sign-Out Error:", error);
                showMessage(`Sign-out failed: ${error.message}`, "error");
            } finally {
                hideLoading();
            }
        });

        // --- User Settings Management ---

        function loadUserSettings() {
            const storedSettings = localStorage.getItem('userSettings');
            if (storedSettings) {
                userSettings = JSON.parse(storedSettings);
            }
            defaultCurrencySelect.value = userSettings.defaultCurrency;
        }

        function saveUserSettings() {
            userSettings.defaultCurrency = defaultCurrencySelect.value;
            localStorage.setItem('userSettings', JSON.stringify(userSettings));
            showMessage('Settings saved!', 'success');
            renderExpenses(); // Re-render to apply new currency
        }

        settingsLink.addEventListener('click', (event) => {
            event.preventDefault();
            profileDropdownContent.classList.remove('show'); // Close profile dropdown
            settingsModal.classList.remove('hidden');
            defaultCurrencySelect.value = userSettings.defaultCurrency; // Ensure current setting is displayed
        });

        closeSettingsModalBtn.addEventListener('click', () => {
            settingsModal.classList.add('hidden');
        });

        settingsModal.addEventListener('click', (event) => {
            if (event.target === settingsModal) {
                settingsModal.classList.add('hidden');
            }
        });

        saveSettingsBtn.addEventListener('click', saveUserSettings);

        // --- Dataset Management ---

        async function loadAndSetInitialDataset() {
            showLoading("Loading your datasets...");
            try {
                const q = query(collection(db, `users/${currentUserId}/datasets`));
                // Use onSnapshot to get real-time updates for datasets themselves
                const unsubscribeDatasets = onSnapshot(q, (snapshot) => {
                    const fetchedDatasets = [];
                    snapshot.forEach((doc) => {
                        fetchedDatasets.push({ id: doc.id, ...doc.data() });
                    });
                    datasets = fetchedDatasets;
                    populateDatasetSelect();
                    renderDatasetsList(); // Update modal list

                    const storedDatasetId = localStorage.getItem('currentDatasetId');
                    let foundDataset = null;

                    if (storedDatasetId) {
                        foundDataset = datasets.find(d => d.id === storedDatasetId);
                    }

                    if (foundDataset) {
                        switchDataset(foundDataset.id, foundDataset.name, foundDataset.description);
                    } else if (datasets.length > 0) {
                        // If stored ID not found or no stored ID, pick the first dataset
                        const firstDataset = datasets[0];
                        switchDataset(firstDataset.id, firstDataset.name, firstDataset.description);
                    } else {
                        // No datasets exist, prompt to create one
                        currentDatasetId = null;
                        currentDatasetInfo = null;
                        if (unsubscribeFromExpenses) {
                            unsubscribeFromExpenses();
                            unsubscribeFromExpenses = null;
                        }
                        expenses = []; // Clear expenses if no dataset
                        renderExpenses(); // Render empty table
                        updateDatasetUI();
                        showMessage("Welcome! Please create your first dataset to start tracking expenses.", "info");
                        manageDatasetsBtn.click(); // Automatically open dataset modal
                    }
                    hideLoading();
                }, (error) => {
                    console.error("Error fetching datasets:", error);
                    showMessage("Error loading datasets. Please try again.", "error");
                    hideLoading();
                });
                // Note: We don't need to return unsubscribeDatasets here, as the auth state change will handle clearing the main expense listener.
                // This listener ensures the dataset dropdown and modal list are always up-to-date.
            } catch (e) {
                console.error("Error loading and setting initial dataset:", e);
                showMessage("Failed to load initial dataset.", "error");
                hideLoading();
            }
        }

        function populateDatasetSelect() {
            currentDatasetSelect.innerHTML = '';
            if (datasets.length === 0) {
                currentDatasetSelect.innerHTML = '<option value="">No Datasets</option>';
                currentDatasetSelect.disabled = true;
            } else {
                currentDatasetSelect.disabled = false;
                datasets.forEach(dataset => {
                    const option = document.createElement('option');
                    option.value = dataset.id;
                    option.textContent = dataset.name;
                    currentDatasetSelect.appendChild(option);
                });
                if (currentDatasetId) {
                    currentDatasetSelect.value = currentDatasetId;
                }
            }
        }

        function renderDatasetsList() {
            datasetsList.innerHTML = '';
            if (datasets.length === 0) {
                noDatasetsMessage.classList.remove('hidden');
            } else {
                noDatasetsMessage.classList.add('hidden');
                datasets.forEach(dataset => {
                    const li = document.createElement('li');
                    li.className = 'p-3 bg-white rounded-lg shadow-sm flex items-center justify-between text-gray-800';
                    li.innerHTML = `
                        <div>
                            <p class="font-semibold">${dataset.name}</p>
                            <p class="text-sm text-gray-500">${dataset.description || 'No description'}</p>
                        </div>
                        <button data-id="${dataset.id}" class="delete-dataset-btn text-red-500 hover:text-red-700 ml-4">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    `;
                    datasetsList.appendChild(li);
                });
            }
        }

        function switchDataset(id, name, description) {
            if (currentDatasetId === id) return; // Already on this dataset

            currentDatasetId = id;
            currentDatasetInfo = { id, name, description };
            localStorage.setItem('currentDatasetId', id); // Persist selection

            updateDatasetUI(); // Update display
            
            // Stop listening to old expenses and start listening to new ones
            if (unsubscribeFromExpenses) {
                unsubscribeFromExpenses();
                unsubscribeFromExpenses = null;
            }
            listenToExpenses(currentUserId); // Restart listener for the new dataset
            showMessage(`Switched to dataset: "${name}"`, 'info');
        }

        function updateDatasetUI() {
            if (currentDatasetInfo) {
                currentDatasetSelect.value = currentDatasetInfo.id;
                currentDatasetDescription.textContent = currentDatasetInfo.description || '';
                currentDatasetDescription.classList.remove('hidden');
            } else {
                currentDatasetSelect.innerHTML = '<option value="">No Dataset Selected</option>';
                currentDatasetSelect.disabled = true;
                currentDatasetDescription.textContent = 'Please create a new dataset.';
                currentDatasetDescription.classList.remove('hidden');
            }
        }

        manageDatasetsBtn.addEventListener('click', () => {
            profileDropdownContent.classList.remove('show'); // Close main dropdown
            datasetModal.classList.remove('hidden');
            renderDatasetsList(); // Ensure list is fresh
        });

        closeDatasetModal.addEventListener('click', () => {
            datasetModal.classList.add('hidden');
        });
        doneDatasetBtn.addEventListener('click', () => {
            datasetModal.classList.add('hidden');
        });
        datasetModal.addEventListener('click', (event) => {
            if (event.target === datasetModal) {
                datasetModal.classList.add('hidden');
            }
        });

        createDatasetBtn.addEventListener('click', async () => {
            if (!currentUserId) {
                showMessage("Please sign in to create datasets.", "error");
                return;
            }
            const name = newDatasetNameInput.value.trim();
            const description = newDatasetDescriptionInput.value.trim();

            if (!name) {
                showMessage("Dataset name cannot be empty.", "error");
                return;
            }

            showLoading("Creating dataset...");
            try {
                const docRef = await addDoc(collection(db, `users/${currentUserId}/datasets`), {
                    name,
                    description,
                    createdAt: new Date()
                });
                showMessage(`Dataset "${name}" created successfully!`, 'success');
                newDatasetNameInput.value = '';
                newDatasetDescriptionInput.value = '';
                // Automatically switch to the newly created dataset
                switchDataset(docRef.id, name, description);
            } catch (e) {
                console.error("Error creating dataset:", e);
                showMessage("Error creating dataset. Please try again.", "error");
            } finally {
                hideLoading();
            }
        });

        currentDatasetSelect.addEventListener('change', (event) => {
            const selectedDatasetId = event.target.value;
            const selectedDataset = datasets.find(d => d.id === selectedDatasetId);
            if (selectedDataset) {
                switchDataset(selectedDataset.id, selectedDataset.name, selectedDataset.description);
            }
        });

        datasetsList.addEventListener('click', async (event) => {
            if (event.target.closest('.delete-dataset-btn')) {
                const btn = event.target.closest('.delete-dataset-btn');
                const datasetIdToDelete = btn.dataset.id;
                const datasetNameToDelete = datasets.find(d => d.id === datasetIdToDelete)?.name || 'this dataset';

                if (confirm(`Are you sure you want to delete the dataset "${datasetNameToDelete}" and ALL its expenses? This action cannot be undone.`)) {
                    showLoading(`Deleting "${datasetNameToDelete}"...`);
                    try {
                        // Delete the dataset document itself
                        await deleteDoc(doc(db, `users/${currentUserId}/datasets`, datasetIdToDelete));
                        // IMPORTANT: Firestore does NOT automatically delete subcollections.
                        // The expenses themselves will remain in Firebase but won't be accessible via this UI
                        // once the parent dataset document is gone.
                        // For a complete cleanup, a Firebase Cloud Function would be needed.
                        
                        showMessage(`Dataset "${datasetNameToDelete}" deleted.`, 'success');

                        // If the current dataset was deleted, switch to another or prompt for new
                        if (currentDatasetId === datasetIdToDelete) {
                            localStorage.removeItem('currentDatasetId');
                            await loadAndSetInitialDataset(); // Reload datasets and pick new active
                        } else {
                            renderDatasetsList(); // Just refresh the list
                        }

                    } catch (e) {
                        console.error("Error deleting dataset:", e);
                        showMessage("Error deleting dataset. Please try again.", "error");
                    } finally {
                        hideLoading();
                    }
                }
            }
        });

        // --- Core Expense Functions (MODIFIED FOR DATASETS) ---

        function listenToExpenses(userId) {
            if (unsubscribeFromExpenses) {
                unsubscribeFromExpenses(); // Stop listening to old expenses
            }

            if (!currentDatasetId) {
                expenses = []; // Clear expenses if no dataset is active
                renderExpenses();
                return;
            }
            
            showLoading(`Loading expenses for "${currentDatasetInfo.name}"...`);
            // Ensure the path includes the currentDatasetId
            const expensesCollectionRef = collection(db, `users/${userId}/datasets/${currentDatasetId}/expenses`);
            const q = query(expensesCollectionRef, orderBy('date', 'desc')); // Order by date, newest first
            
            unsubscribeFromExpenses = onSnapshot(q, (snapshot) => {
                const fetchedExpenses = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    fetchedExpenses.push({
                        id: doc.id,
                        date: data.date,
                        category: data.category,
                        description: data.description,
                        amount: data.amount,
                        paymentMethod: data.paymentMethod,
                        paidBy: data.paidBy,
                        hasBill: data.hasBill,
                        billType: data.billType,
                        source: data.source || 'manual' // Default to manual if old data without source field
                    });
                });
                expenses = fetchedExpenses;
                renderExpenses(); // Render and update charts
                hideLoading();
                showMessage(`Expenses for "${currentDatasetInfo.name}" synchronized!`, 'success');
            }, (error) => {
                console.error("Error fetching Firestore expenses:", error);
                showMessage("Error loading expenses for this dataset. Check console for details.", "error");
                hideLoading();
            });
        }

        function renderExpenses() {
            expenseTableBody.innerHTML = '';
            let totalExpenditure = 0;

            // Filter expenses based on current selections
            const filteredExpenses = expenses.filter(expense => {
                const matchesCategory = currentFilterCategory === '' || expense.category === currentFilterCategory;
                const matchesPaymentMethod = currentFilterPaymentMethod === '' || expense.paymentMethod === currentFilterPaymentMethod;
                const matchesSource = currentDataSourceFilter === '' || expense.source === currentDataSourceFilter;
                return matchesCategory && matchesPaymentMethod && matchesSource;
            });

            // No need to sort again here, as `listenToExpenses` already sorts by date.

            filteredExpenses.forEach(expense => {
                const amountCad = parseFloat(expense.amount);
                totalExpenditure += amountCad;

                const amountAED = (amountCad * EXCHANGE_RATE_CAD_TO_AED).toFixed(2);
                const amountINR = (amountCad * EXCHANGE_RATE_CAD_TO_INR).toFixed(2);

                let displayAmount;
                switch(userSettings.defaultCurrency) {
                    case 'AED':
                        displayAmount = `AED ${amountAED}`;
                        break;
                    case 'INR':
                        displayAmount = `INR ${amountINR}`;
                        break;
                    case 'CAD':
                    default:
                        displayAmount = `C$${amountCad.toFixed(2)}`;
                        break;
                }

                const row = expenseTableBody.insertRow();
                row.innerHTML = `
                    <td class="whitespace-nowrap">${expense.date}</td>
                    <td class="whitespace-nowrap">${expense.category}</td>
                    <td class="whitespace-nowrap">${expense.description}</td>
                    <td class="whitespace-nowrap">C$${amountCad.toFixed(2)}</td>
                    <td class="whitespace-nowrap">AED ${amountAED}</td>
                    <td class="whitespace-nowrap">INR ${amountINR}</td>
                    <td class="whitespace-nowrap">${expense.paymentMethod || 'N/A'}</td>
                    <td class="whitespace-nowrap">${expense.paidBy || 'N/A'}</td>
                    <td class="whitespace-nowrap">${expense.hasBill ? 'Yes' : 'No'}</td>
                    <td class="whitespace-nowrap">${expense.hasBill ? (expense.billType || 'N/A') : 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button data-id="${expense.id}" class="text-red-600 hover:text-red-900 ml-2 delete-btn">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
            });

            totalExpenditureSpan.textContent = `C$${totalExpenditure.toFixed(2)}`;
            
            // Charts will always display all data from the current dataset, not just filtered table data
            const allMonthlyExpenses = {};
            const allCategoryExpenses = {};
            expenses.forEach(expense => {
                const amountCad = parseFloat(expense.amount);
                const monthYear = new Date(expense.date).toLocaleString('en-US', { month: 'short', year: 'numeric' });
                allMonthlyExpenses[monthYear] = (allMonthlyExpenses[monthYear] || 0) + amountCad;
                const category = expense.category || 'Uncategorized';
                allCategoryExpenses[category] = (allCategoryExpenses[category] || 0) + amountCad;
            });

            updateCharts(allMonthlyExpenses, allCategoryExpenses);
            populateMonthSelect();
            populateFilterDropdowns();
        }

        addExpenseBtn.addEventListener('click', async () => {
            if (!currentUserId || !currentDatasetId) {
                showMessage("Please select or create a dataset to add expenses.", "error");
                return;
            }

            const date = expenseDateInput.value;
            const category = expenseCategoryInput.value.trim();
            const description = expenseDescriptionInput.value.trim();
            const amount = parseFloat(expenseAmountInput.value);
            const paymentMethod = paymentMethodInput.value;
            const paidBy = paidByInput.value.trim();
            const hasBill = hasBillInput.checked;
            const billType = hasBill ? billTypeInput.value : '';

            if (!date || !category || !description || isNaN(amount) || amount <= 0 || !paymentMethod || !paidBy || (hasBill && !billType)) {
                showMessage('Please fill in all required fields and ensure the amount is a positive number.', 'error');
                return;
            }

            showLoading("Adding expense...");
            try {
                await addDoc(collection(db, `users/${currentUserId}/datasets/${currentDatasetId}/expenses`), {
                    date,
                    category,
                    description,
                    amount,
                    paymentMethod,
                    paidBy,
                    hasBill,
                    billType,
                    source: 'manual', // Set source as 'manual'
                    timestamp: new Date()
                });
                showMessage('Expense added successfully!', 'success');
                expenseDateInput.value = '';
                expenseCategoryInput.value = '';
                expenseDescriptionInput.value = '';
                expenseAmountInput.value = '';
                paymentMethodInput.value = '';
                paidByInput.value = '';
                hasBillInput.checked = false;
                billTypeInput.value = '';
                billTypeContainer.style.display = 'none';
            } catch (e) {
                console.error("Error adding document: ", e);
                showMessage('Error adding expense. Please try again.', 'error');
            } finally {
                hideLoading();
            }
        });

        expenseTableBody.addEventListener('click', async (event) => {
            if (event.target.classList.contains('delete-btn') || event.target.closest('.delete-btn')) {
                if (!currentUserId || !currentDatasetId) {
                    showMessage("Please select a dataset to delete expenses.", "error");
                    return;
                }
                const btn = event.target.closest('.delete-btn');
                const expenseId = btn.dataset.id;
                if (confirm('Are you sure you want to delete this expense?')) {
                    showLoading("Deleting expense...");
                    try {
                        await deleteDoc(doc(db, `users/${currentUserId}/datasets/${currentDatasetId}/expenses`, expenseId));
                        showMessage('Expense deleted successfully!', 'success');
                    } catch (e) {
                        console.error("Error deleting document: ", e);
                        showMessage('Error deleting expense. Please try again.', 'error');
                    } finally {
                        hideLoading();
                    }
                }
            }
        });

        hasBillInput.addEventListener('change', () => {
            billTypeContainer.style.display = hasBillInput.checked ? 'block' : 'none';
            if (!hasBillInput.checked) {
                billTypeInput.value = ''; // Clear bill type if "Has Bill?" is unchecked
            }
        });

        // --- Charting Functions ---

        function updateCharts(monthlyData, categoryData) {
            // Monthly Chart
            const monthlyLabels = Object.keys(monthlyData).sort((a, b) => new Date(a) - new Date(b));
            const monthlyValues = monthlyLabels.map(label => monthlyData[label]);

            if (monthlyChartInstance) {
                monthlyChartInstance.destroy();
            }
            monthlyChartInstance = new Chart(monthlyChartCanvas, {
                type: 'bar',
                data: {
                    labels: monthlyLabels,
                    datasets: [{
                        label: 'Total CAD Expenditure',
                        data: monthlyValues,
                        backgroundColor: 'rgba(59, 130, 246, 0.6)', // Tailwind blue-500
                        borderColor: 'rgba(37, 99, 235, 1)',    // Tailwind blue-600
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount (CAD)'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Monthly Expenditure'
                        }
                    }
                }
            });

            // Category Chart
            const categoryLabels = Object.keys(categoryData).sort();
            const categoryValues = categoryLabels.map(label => categoryData[label]);

            if (categoryChartInstance) {
                categoryChartInstance.destroy();
            }
            categoryChartInstance = new Chart(categoryChartCanvas, {
                type: 'pie',
                data: {
                    labels: categoryLabels,
                    datasets: [{
                        label: 'Expenses by Category',
                        data: categoryValues,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)', // Red
                            'rgba(54, 162, 235, 0.7)', // Blue
                            'rgba(255, 206, 86, 0.7)', // Yellow
                            'rgba(75, 192, 192, 0.7)', // Green
                            'rgba(153, 102, 255, 0.7)',// Purple
                            'rgba(255, 159, 64, 0.7)', // Orange
                            'rgba(199, 199, 199, 0.7)',// Grey
                            'rgba(83, 102, 255, 0.7)', // Indigo
                            'rgba(170, 204, 0, 0.7)',  // Lime
                            'rgba(0, 153, 153, 0.7)'   // Teal
                        ],
                        borderColor: 'white',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Expenses by Category'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += 'C$' + context.parsed.toFixed(2);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // --- Excel Upload Function ---
        async function handleExcelUpload() {
            if (!currentUserId || !currentDatasetId) {
                showMessage("Please select or create a dataset to upload expenses.", "error");
                return;
            }

            const file = excelUploadInput.files[0];
            if (!file) {
                showMessage('Please select an Excel file to upload.', 'info');
                return;
            }

            uploadStatus.classList.add('hidden'); // Clear previous status
            uploadStatus.classList.remove('message-success', 'message-error', 'message-info');

            showLoading("Processing Excel file...");

            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonExpenses = XLSX.utils.sheet_to_json(worksheet, {
                    raw: false, // Keep raw values, don't try to parse dates/numbers yet
                    defval: '' // Set default value for empty cells
                });

                if (jsonExpenses.length === 0) {
                    showMessage('The selected Excel file contains no data.', 'info');
                    hideLoading();
                    return;
                }

                const validExpenses = [];
                const invalidRows = [];

                // Validate and format data
                jsonExpenses.forEach((row, index) => {
                    const expense = {};
                    let isValid = true;
                    let validationErrors = [];

                    // Mapping and validation
                    expense.date = row.Date; // Assuming 'YYYY-MM-DD' or similar compatible format
                    if (!expense.date || !/^\d{4}-\d{2}-\d{2}$/.test(expense.date)) {
                        isValid = false;
                        validationErrors.push('Invalid Date (expected YYYY-MM-DD)');
                    }

                    expense.category = (row.Category || '').trim();
                    if (!expense.category) {
                        isValid = false;
                        validationErrors.push('Missing Category');
                    }

                    expense.description = (row.Description || '').trim();
                    if (!expense.description) {
                        isValid = false;
                        validationErrors.push('Missing Description');
                    }

                    const amount = parseFloat(row.Amount);
                    if (isNaN(amount) || amount <= 0) {
                        isValid = false;
                        validationErrors.push('Invalid Amount (must be a positive number)');
                    }
                    expense.amount = amount;

                    expense.paymentMethod = (row['Payment Method'] || row['PaymentMethod'] || '').trim(); // Handle variations
                    if (!expense.paymentMethod) {
                        isValid = false;
                        validationErrors.push('Missing Payment Method');
                    }

                    expense.paidBy = (row['Paid By'] || row['PaidBy'] || '').trim(); // Handle variations
                    if (!expense.paidBy) {
                        isValid = false;
                        validationErrors.push('Missing Paid By');
                    }

                    // 'Has Bill?' can be 'Yes'/'No', 'TRUE'/'FALSE', 1/0
                    const hasBillRaw = String(row['Has Bill?'] || row['HasBill?'] || '').toLowerCase();
                    expense.hasBill = ['yes', 'true', '1'].includes(hasBillRaw);
                    
                    expense.billType = (row['Bill Type'] || row['BillType'] || '').trim();
                    if (expense.hasBill && !expense.billType) {
                        isValid = false;
                        validationErrors.push('Bill Type required if Has Bill? is "Yes"');
                    }

                    expense.source = 'uploaded'; // Tag uploaded expenses

                    if (isValid) {
                        validExpenses.push(expense);
                    } else {
                        invalidRows.push({ rowNumber: index + 2, data: row, errors: validationErrors.join(', ') }); // +2 for 1-based index and header row
                    }
                });

                if (validExpenses.length === 0) {
                    uploadStatus.classList.remove('hidden');
                    uploadStatus.classList.add('message-error');
                    uploadStatus.innerHTML = `
                        <p>No valid expenses found in the file.</p>
                        ${invalidRows.length > 0 ? `<p class="mt-2 font-bold">Details for Invalid Rows:</p><ul>${invalidRows.map(r => `<li>Row ${r.rowNumber}: ${JSON.stringify(r.data)} - Errors: ${r.errors}</li>`).join('')}</ul>` : ''}
                    `;
                    hideLoading();
                    return;
                }

                // Batch write to Firestore
                const batch = writeBatch(db); // Use writeBatch from firebase/firestore
                const expensesCollectionRef = collection(db, `users/${currentUserId}/datasets/${currentDatasetId}/expenses`);
                validExpenses.forEach(expense => {
                    const newDocRef = doc(expensesCollectionRef); // Create a new document reference
                    batch.set(newDocRef, { ...expense, timestamp: new Date() }); // Add timestamp
                });

                await batch.commit();

                let successMessage = `Successfully uploaded ${validExpenses.length} expense(s).`;
                if (invalidRows.length > 0) {
                    successMessage += ` However, ${invalidRows.length} row(s) were invalid and skipped.`;
                    uploadStatus.classList.remove('hidden');
                    uploadStatus.classList.add('message-info');
                    uploadStatus.innerHTML = `
                        <p>${successMessage}</p>
                        <p class="mt-2 font-bold">Details for Skipped Rows:</p>
                        <ul class="list-disc list-inside">${invalidRows.map(r => `<li>Row ${r.rowNumber}: ${r.errors}</li>`).join('')}</ul>
                        <p class="mt-2 text-xs text-gray-600">Please check your Excel file for correct column headers and data format.</p>
                    `;
                    showMessage('Excel upload completed with some invalid rows.', 'info');
                } else {
                    showMessage(successMessage, 'success');
                    uploadStatus.classList.remove('hidden');
                    uploadStatus.classList.add('message-success');
                    uploadStatus.innerHTML = `<p>${successMessage}</p>`;
                }
                
                excelUploadInput.value = ''; // Clear the file input
            } catch (error) {
                console.error('Error uploading Excel file:', error);
                showMessage('Error processing Excel file. Please ensure it is a valid .xlsx or .xls file and check console for details.', 'error');
                uploadStatus.classList.remove('hidden');
                uploadStatus.classList.add('message-error');
                uploadStatus.innerHTML = `<p>Failed to upload Excel file: ${error.message}</p>`;
            } finally {
                hideLoading();
            }
        }

        uploadExcelBtn.addEventListener('click', handleExcelUpload);

        // --- Excel Export Functions ---

        exportAllDataBtn.addEventListener('click', () => {
            if (!currentDatasetId) {
                showMessage('No dataset selected to export data from.', 'info');
                return;
            }
            if (expenses.length === 0) {
                showMessage('No data to export in the current dataset!', 'info');
                return;
            }

            // Create a worksheet from the expenses array
            const ws = XLSX.utils.json_to_sheet(expenses.map(expense => ({
                Date: expense.date,
                Category: expense.category,
                Description: expense.description,
                Amount: expense.amount,
                'Payment Method': expense.paymentMethod,
                'Paid By': expense.paidBy,
                'Has Bill?': expense.hasBill ? 'Yes' : 'No',
                'Bill Type': expense.billType,
                Source: expense.source // Include source in export
            })));

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "All Expenses");

            const fileName = `All_Expenses_${currentDatasetInfo.name.replace(/ /g, '_')}_${new Date().toISOString().slice(0,10)}.xlsx`;
            XLSX.writeFile(wb, fileName);
            showMessage('All expenses from current dataset exported to Excel!', 'success');
        });

        function populateMonthSelect() {
            const months = new Set();
            expenses.forEach(expense => {
                const date = new Date(expense.date);
                months.add(date.toLocaleString('en-US', { year: 'numeric', month: 'long' }));
            });

            monthSelect.innerHTML = '<option value="">Select Month</option>';
            Array.from(months).sort((a, b) => new Date(a) - new Date(b)).forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = month;
                monthSelect.appendChild(option);
            });
        }

        downloadExcelBtn.addEventListener('click', () => {
            if (!currentDatasetId) {
                showMessage('No dataset selected to download data from.', 'info');
                return;
            }
            const selectedMonth = monthSelect.value;
            if (!selectedMonth) {
                showMessage('Please select a month to download.', 'info');
                return;
            }

            const filteredByMonth = expenses.filter(expense => {
                const date = new Date(expense.date);
                return date.toLocaleString('en-US', { year: 'numeric', month: 'long' }) === selectedMonth;
            });

            if (filteredByMonth.length === 0) {
                showMessage(`No expenses found for ${selectedMonth} in the current dataset.`, 'info');
                return;
            }

            const ws = XLSX.utils.json_to_sheet(filteredByMonth.map(expense => ({
                Date: expense.date,
                Category: expense.category,
                Description: expense.description,
                Amount: expense.amount,
                'Payment Method': expense.paymentMethod,
                'Paid By': expense.paidBy,
                'Has Bill?': expense.hasBill ? 'Yes' : 'No',
                'Bill Type': expense.billType,
                Source: expense.source
            })));

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, `${selectedMonth} Expenses`);

            const fileName = `Expenses_${currentDatasetInfo.name.replace(/ /g, '_')}_${selectedMonth.replace(/ /g, '_')}.xlsx`;
            XLSX.writeFile(wb, fileName);
            showMessage(`Expenses for ${selectedMonth} from current dataset downloaded as Excel!`, "success");
        });

        // --- Filtering Functions ---

        function populateFilterDropdowns() {
            const categories = new Set();
            const paymentMethods = new Set();

            expenses.forEach(expense => {
                if (expense.category) categories.add(expense.category);
                if (expense.paymentMethod) paymentMethods.add(expense.paymentMethod);
            });

            // Populate Category Filter
            filterCategorySelect.innerHTML = '<option value="">All Categories</option>';
            Array.from(categories).sort().forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                filterCategorySelect.appendChild(option);
            });
            filterCategorySelect.value = currentFilterCategory; // Set selected value

            // Populate Payment Method Filter
            filterPaymentMethodSelect.innerHTML = '<option value="">All Methods</option>';
            Array.from(paymentMethods).sort().forEach(method => {
                const option = document.createElement('option');
                option.value = method;
                option.textContent = method;
                filterPaymentMethodSelect.appendChild(option);
            });
            filterPaymentMethodSelect.value = currentFilterPaymentMethod; // Set selected value
        }

        filterCategorySelect.addEventListener('change', (event) => {
            currentFilterCategory = event.target.value;
            renderExpenses(); // Re-render table with new filter
        });

        filterPaymentMethodSelect.addEventListener('change', (event) => {
            currentFilterPaymentMethod = event.target.value;
            renderExpenses(); // Re-render table with new filter
        });

        dataSourceFilterRadios.forEach(radio => {
            radio.addEventListener('change', (event) => {
                currentDataSourceFilter = event.target.value;
                renderExpenses(); // Re-render table with new source filter
            });
        });

        clearFiltersBtn.addEventListener('click', () => {
            currentFilterCategory = '';
            currentFilterPaymentMethod = '';
            currentDataSourceFilter = ''; // Reset source filter
            filterCategorySelect.value = '';
            filterPaymentMethodSelect.value = '';
            // Reset radio buttons to 'All Sources'
            document.querySelector('input[name="dataSourceFilter"][value=""]').checked = true;
            renderExpenses();
            showMessage('All filters cleared!', 'info');
        });

        // --- Profile Dropdown ---
        profileButton.addEventListener('click', () => {
            profileDropdownContent.classList.toggle('show');
        });

        // Close the dropdown if the user clicks outside of it
        window.addEventListener('click', (event) => {
            if (!event.target.closest('.profile-dropdown-container') && !event.target.closest('#settingsModal')) {
                profileDropdownContent.classList.remove('show');
            }
        });

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            expenseDateInput.value = `${yyyy}-${mm}-${dd}`;

            // Initial chart setup
            updateCharts({}, {}); 

            // Firebase Auth State Listener
            onAuthStateChanged(auth, async (user) => {
                console.log("onAuthStateChanged fired. User:", user);
                if (user) {
                    currentUserId = user.uid;
                    
                    let displayEmail = user.email || 'Guest User';
                    let displayName = user.displayName || 'Guest';
                    let initial = displayName.charAt(0).toUpperCase();

                    if (user.photoURL) {
                        profilePicture.src = user.photoURL;
                        avatarPicture.src = user.photoURL;
                        profilePicture.classList.remove('hidden');
                        avatarPicture.classList.remove('hidden');
                        profileIconText.classList.add('hidden');
                        avatarInitial.classList.add('hidden');
                    } else {
                        profilePicture.classList.add('hidden');
                        avatarPicture.classList.add('hidden');
                        profileIconText.classList.remove('hidden');
                        avatarInitial.classList.remove('hidden');
                    }

                    if (user.isAnonymous) {
                        displayEmail = 'guest@example.com'; 
                        displayName = 'Guest';
                        initial = 'G';
                        // userInfoDiv.textContent = 'Welcome, Guest!'; // REMOVED
                        mainAppUserInfo.textContent = 'Guest User'; // Using mainAppUserInfo instead
                    } else {
                        // userInfoDiv.textContent = `Welcome, ${displayName}!`; // REMOVED
                        // mainAppUserInfo already set to displayEmail below
                    }

                    mainAppUserInfo.textContent = displayEmail; 
                    profileIconText.textContent = initial;      
                    avatarInitial.textContent = initial;        

                    loginScreen.classList.add('hidden');
                    mainAppContainer.classList.remove('hidden');

                    console.log('User signed in:', user.uid, 'Anonymous:', user.isAnonymous);
                    
                    loadUserSettings();
                    await loadAndSetInitialDataset(); // Load and set the active dataset
                    // listenToExpenses will now be called by loadAndSetInitialDataset
                } else {
                    currentUserId = null;
                    currentDatasetId = null; // Clear dataset on sign out
                    datasets = [];
                    currentDatasetInfo = null;
                    updateDatasetUI(); // Clear UI
                    
                    // userInfoDiv.textContent = 'Please sign in to save your data.'; // REMOVED
                    mainAppUserInfo.textContent = ''; 

                    profilePicture.classList.add('hidden');
                    avatarPicture.classList.add('hidden');
                    profileIconText.classList.remove('hidden'); 
                    avatarInitial.classList.remove('hidden');   

                    profileIconText.textContent = 'G'; 
                    avatarInitial.textContent = 'G';    

                    mainAppContainer.classList.add('hidden');
                    loginScreen.classList.remove('hidden');

                    console.log('User signed out.');

                    expenses = [];
                    renderExpenses();
                    if (unsubscribeFromExpenses) {
                        unsubscribeFromExpenses();
                        unsubscribeFromExpenses = null; 
                    }
                    showMessage('Your data will be available when you sign in.', 'info');
                    userSettings = { defaultCurrency: 'CAD' }; 
                    localStorage.removeItem('userSettings'); 
                    localStorage.removeItem('currentDatasetId'); // Clear saved dataset
                }
                console.log("Auth state check complete, hiding loading overlay.");
                hideLoading();
            });
        });

        showLoading("Starting application..."); // Show loading spinner initially
    </script>
</body>
</html>
