<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Expenditure Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- XLSX library import -->
    <script type="module">
        import * as XLSX from "https://unpkg.com/xlsx/xlsx.mjs";
        window.XLSX = XLSX; 
    </script>

    <style>
        /* Minimal, performance-focused styles */
        body {
            font-family: sans-serif;
            margin: 20px;
            background-color: #f0f0f0;
            color: #333;
        }
        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 15px;
            background-color: #fff;
            border: 1px solid #ddd;
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .hidden {
            display: none;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        button {
            padding: 8px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 3px;
            margin-right: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        input[type="text"],
        input[type="number"],
        input[type="date"],
        select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 3px;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .message {
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid transparent;
            border-radius: 3px;
        }
        .message-success {
            background-color: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }
        .message-error {
            background-color: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }
        .message-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border-color: #bee5eb;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            margin-top: 20px;
        }
        .profile-dropdown-container {
            position: relative;
            display: inline-block;
            float: right;
        }
        .profile-toggle-button {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .profile-dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            right: 0;
            padding: 10px;
        }
        .profile-dropdown-content.active {
            display: block;
        }
        .profile-dropdown-content button {
            display: block;
            width: 100%;
            text-align: left;
            margin-bottom: 5px;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 400px;
            position: relative;
        }
        .modal-close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
            color: #888;
        }
        .btn-danger {
            background-color: #dc3545;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <p>Initializing app...</p>
    </div>

    <div id="loginScreen" class="container hidden">
        <h1>Welcome to your Expense Tracker.</h1>
        <p>Sign in with your Google account to effortlessly track your spending, or proceed as a guest.</p>
        <div>
            <button id="authButton">Sign In with Google</button>
            <button id="guestButton">Continue as Guest</button>
        </div>
        <p style="font-size: 0.8em; color: #666; margin-top: 10px;">Guest data is temporary and not permanently stored. Consider signing in with Google for data persistence.</p>
        <div id="userInfo" style="margin-top: 15px; font-size: 0.9em; color: #555;"></div>
    </div>

    <div id="mainAppContainer" class="container hidden">
        <div style="overflow: auto;">
            <h1 style="float: left;">Expense Tracker</h1>
            <div class="profile-dropdown-container">
                <button id="profileToggleButton" class="profile-toggle-button">
                    <span id="profileIconText">G</span>
                </button>
                <div id="profileDropdownContent" class="profile-dropdown-content hidden">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <div style="width: 40px; height: 40px; border-radius: 50%; background-color: #007bff; color: white; display: flex; align-items: center; justify-content: center; font-size: 1.2em; font-weight: bold; margin-right: 10px;">
                            <span id="avatarInitial">G</span>
                        </div>
                        <div id="mainAppUserInfo" style="font-size: 0.9em; color: #333; word-break: break-all;"></div>
                    </div>
                    <button id="settingsButton">Settings</button>
                    <button id="signOutButton">Sign Out</button>
                </div>
            </div>
        </div>

        <hr style="margin: 20px 0;">

        <h2>Add New Expense</h2>
        <div>
            <label for="expenseDate">Date</label>
            <input type="date" id="expenseDate">

            <label for="expenseCategory">Category</label>
            <input type="text" id="expenseCategory" placeholder="e.g., Groceries, Rent">

            <label for="expenseDescription">Description</label>
            <input type="text" id="expenseDescription" placeholder="e.g., Weekly shopping">

            <label for="expenseAmount">Amount (CAD)</label>
            <input type="number" id="expenseAmount" placeholder="e.g., 50.00" step="0.01">
            
            <label for="paymentMethod">Payment Method</label>
            <select id="paymentMethod">
                <option value="">Select Method</option>
                <option value="Credit Card">Credit Card</option>
                <option value="Debit Card">Debit Card</option>
                <option value="Cash">Cash</option>
                <option value="Bank Transfer">Bank Transfer</option>
                <option value="Online Payment">Online Payment</option>
                <option value="Other">Other</option>
            </select>

            <label for="paidBy">Paid By</label>
            <input type="text" id="paidBy" placeholder="e.g., John, Sarah">

            <div style="margin-bottom: 10px;">
                <input type="checkbox" id="hasBill">
                <label for="hasBill">Do you have the bill?</label>
            </div>
            <div id="billTypeContainer" class="hidden">
                <label for="billType">Bill Type</label>
                <select id="billType">
                    <option value="">Select Type</option>
                    <option value="Physical">Physical</option>
                    <option value="Digital">Digital</option>
                </select>
            </div>
        </div>
        <button id="addExpenseBtn" style="width: 100%;">Add Expense</button>

        <hr style="margin: 20px 0;">

        <h2>Your Expenses</h2>
        <!-- New Excel Upload Section -->
        <div id="uploadExcelSection" style="margin-bottom: 15px;">
            <p style="margin-bottom: 5px;">Upload Expenses from Excel File:</p>
            <input type="file" id="uploadExcelInput" accept=".xlsx, .xls" class="hidden">
            <button id="uploadExcelBtn">Upload Excel</button>
            <p style="font-size: 0.8em; color: #666; margin-top: 5px;">
                Expected columns: Date, Category, Description, Amount (CAD), Payment Method, Paid By, Has Bill (Yes/No), Bill Type (Physical/Digital).
            </p>
        </div>
        <!------------------------------->

        <div style="overflow-x: auto;">
            <table id="expenseTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Category</th>
                        <th>Description</th>
                        <th>Amount (CAD)</th>
                        <th>Amount (AED)</th>
                        <th>Payment Method</th>
                        <th>Paid By</th>
                        <th>Bill</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="expenseTableBody">
                    <!-- Expense rows will be inserted here -->
                </tbody>
            </table>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
            <div style="font-weight: bold;">
                Total Expenditure: <span id="totalExpenditure">0.00 CAD</span>
            </div>
            <button id="exportExcelBtn">Export to Excel</button>
        </div>

        <hr style="margin: 20px 0;">

        <h2>Expense Summary by Category</h2>
        <div class="chart-container">
            <canvas id="categoryChart"></canvas>
        </div>

        <hr style="margin: 20px 0;">

        <h2>Expense Summary by Payment Method</h2>
        <div class="chart-container">
            <canvas id="paymentMethodChart"></canvas>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button id="closeSettingsModal" class="modal-close-btn">&times;</button>
            <h2>Settings</h2>
            
            <div>
                <label for="currencyExchangeRate">CAD to AED Exchange Rate</label>
                <input type="number" id="currencyExchangeRate" step="0.0001" placeholder="e.g., 2.70">
                <p style="font-size: 0.8em; color: #666; margin-top: 5px;">
                    Current approximate rate: 1 CAD â‰ˆ 2.68 AED (as of June 2025). Please adjust if needed.
                </p>
            </div>
            
            <div style="margin-top: 15px;">
                <label for="monthlyBudget">Monthly Budget (CAD)</label>
                <input type="number" id="monthlyBudget" step="0.01" placeholder="e.g., 2000.00">
                <p style="font-size: 0.8em; color: #666; margin-top: 5px;">
                    Set your target monthly spending limit.
                </p>
            </div>

            <div style="margin-top: 20px; padding: 10px; border: 1px solid #ccc; background-color: #f9f9f9;">
                <h3 style="margin-top: 0;">Danger Zone</h3>
                <button id="clearAllDataButton" class="btn-danger" style="width: 100%;">
                    Clear All Expense Data
                </button>
                <p style="font-size: 0.8em; color: #666; margin-top: 5px;">
                    This action is irreversible and will delete all your recorded expenses.
                </p>
            </div>

            <div style="margin-top: 20px; text-align: right;">
                <button id="saveSettingsButton">Save Settings</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        // IMPORTANT: Added 'getDoc' here
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // XLSX is already globally available via the script tag in the head, no need to import here again
        // window.XLSX is used directly in the handleExcelUpload function.

        // Initialize Firebase (replace with your actual Firebase config)
        const firebaseConfig = {
            apiKey: "AIzaSyA_x5ENsCsHpcdYxgxi1a3vPs_vUR6Hkts",
  authDomain: "my-expenese-tracker.firebaseapp.com",
  projectId: "my-expenese-tracker",
  storageBucket: "my-expenese-tracker.firebasestorage.app",
  messagingSenderId: "466782350290",
  appId: "466782350290-0cljann4p9h7oqnboark3a5bj6ruilu0.apps.googleusercontent.com",
  measurementId: "G-1CF1ZNLPC2"
        };

        // Check if Firebase config is default (user hasn't replaced it)
        const isDefaultConfig = firebaseConfig.apiKey === "YOUR_API_KEY";

        let app, auth, db;

        if (isDefaultConfig) {
            console.warn("Firebase configuration is not set. Running in guest-only mode. Please update firebaseConfig with your project details for full functionality.");
            // Disable Firebase-related UI elements
            document.getElementById('authButton').style.display = 'none';
        } else {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        }

        const authButton = document.getElementById('authButton');
        const guestButton = document.getElementById('guestButton');
        const loginScreen = document.getElementById('loginScreen');
        const mainAppContainer = document.getElementById('mainAppContainer');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const userInfoDisplay = document.getElementById('userInfo');
        const mainAppUserInfoDisplay = document.getElementById('mainAppUserInfo');
        const profileToggleButton = document.getElementById('profileToggleButton');
        const profileDropdownContent = document.getElementById('profileDropdownContent');
        const profileIconText = document.getElementById('profileIconText');
        const avatarInitial = document.getElementById('avatarInitial');
        const signOutButton = document.getElementById('signOutButton');
        const settingsButton = document.getElementById('settingsButton');
        const settingsModal = document.getElementById('settingsModal');
        const closeSettingsModal = document.getElementById('closeSettingsModal');
        const currencyExchangeRateInput = document.getElementById('currencyExchangeRate');
        const monthlyBudgetInput = document.getElementById('monthlyBudget');
        const saveSettingsButton = document.getElementById('saveSettingsButton');
        const clearAllDataButton = document.getElementById('clearAllDataButton');

        const addExpenseBtn = document.getElementById('addExpenseBtn');
        const expenseTableBody = document.getElementById('expenseTableBody');
        const totalExpenditureSpan = document.getElementById('totalExpenditure');
        const exportExcelBtn = document.getElementById('exportExcelBtn');
        const hasBillCheckbox = document.getElementById('hasBill');
        const billTypeContainer = document.getElementById('billTypeContainer');
        const billTypeSelect = document.getElementById('billType');

        // New Excel Upload Elements
        const uploadExcelInput = document.getElementById('uploadExcelInput');
        const uploadExcelBtn = document.getElementById('uploadExcelBtn');

        let expenses = [];
        let currentUserId = null; // To store Firebase UID or 'guest'
        let isGuestMode = false;
        let categoryChart, paymentMethodChart;

        // Default exchange rate and budget
        let cadToAedRate = 2.68; 
        let monthlyBudget = 0; // 0 means no budget set

        // --- Utility Functions ---
        function showLoading(message = "Loading...") {
            document.querySelector('#loadingOverlay p').textContent = message;
            loadingOverlay.classList.remove('hidden');
        }

        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }

        function showMessage(message, type = 'info') {
            const container = document.createElement('div');
            container.className = `message message-${type}`;
            container.textContent = message;
            document.body.appendChild(container);
            setTimeout(() => {
                container.remove();
            }, 3000);
        }

        function formatCurrency(amount, currency = 'CAD') {
            return new Intl.NumberFormat('en-CA', {
                style: 'currency',
                currency: currency,
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        // --- Data Persistence (Local Storage for Guests, Firestore for Signed-in Users) ---
        async function saveData() {
            showLoading("Saving data...");
            if (isGuestMode) {
                localStorage.setItem('guestExpenses', JSON.stringify(expenses));
                localStorage.setItem('guestSettings', JSON.stringify({ cadToAedRate, monthlyBudget }));
                hideLoading();
                showMessage("Guest data saved locally!", "success");
            } else if (currentUserId && db) {
                try {
                    // Save expenses and settings to the user's document
                    await setDoc(doc(db, "users", currentUserId), { expenses: expenses, settings: { cadToAedRate, monthlyBudget } });
                    hideLoading();
                    showMessage("Data saved to cloud!", "success");
                } catch (e) {
                    console.error("Error saving document: ", e);
                    hideLoading();
                    showMessage("Error saving data!", "error");
                }
            }
        }

        async function loadData() {
            showLoading("Loading data...");
            if (isGuestMode) {
                const storedExpenses = localStorage.getItem('guestExpenses');
                const storedSettings = localStorage.getItem('guestSettings');
                if (storedExpenses) {
                    expenses = JSON.parse(storedExpenses);
                }
                if (storedSettings) {
                    const settings = JSON.parse(storedSettings);
                    cadToAedRate = settings.cadToAedRate || 2.68;
                    monthlyBudget = settings.monthlyBudget || 0;
                }
                hideLoading();
                showMessage("Guest data loaded!", "info");
            } else if (currentUserId && db) {
                try {
                    // Corrected: Directly fetch the user's specific document
                    const docRef = doc(db, "users", currentUserId);
                    const docSnap = await getDoc(docRef); // Use getDoc, not getDocs

                    if (docSnap.exists()) { // Check if the document exists
                        const userData = docSnap.data();
                        expenses = userData.expenses || [];
                        cadToAedRate = userData.settings?.cadToAedRate || 2.68;
                        monthlyBudget = userData.settings?.monthlyBudget || 0;
                        showMessage("Data loaded from cloud!", "success");
                    } else {
                        expenses = []; // No data found for user, start with empty
                        showMessage("No existing data found for your account. Starting fresh!", "info");
                        // Also, save initial empty data to create the document
                        await setDoc(doc(db, "users", currentUserId), { expenses: [], settings: { cadToAedRate, monthlyBudget } });
                    }
                    hideLoading();
                } catch (e) {
                    console.error("Error loading document: ", e);
                    hideLoading();
                    showMessage("Error loading data!", "error");
                }
            }
            updateUI();
        }

        async function clearAllData() {
            // Using a simple confirm dialog as per the previous basic design request
            if (confirm("Are you sure you want to delete ALL your expense data? This action cannot be undone.")) {
                showLoading("Clearing data...");
                expenses = [];
                if (isGuestMode) {
                    localStorage.removeItem('guestExpenses');
                    localStorage.removeItem('guestSettings');
                    hideLoading();
                    showMessage("All guest data cleared!", "success");
                } else if (currentUserId && db) {
                    try {
                        // Overwrite with empty data to clear, rather than deleting the doc,
                        // to maintain the user document for future settings/expenses.
                        await setDoc(doc(db, "users", currentUserId), { expenses: [], settings: { cadToAedRate, monthlyBudget } }); 
                        hideLoading();
                        showMessage("All cloud data cleared!", "success");
                    } catch (e) {
                        console.error("Error clearing data: ", e);
                        hideLoading();
                        showMessage("Error clearing data!", "error");
                    }
                }
                updateUI();
                closeSettingsModal.click(); // Close modal
            }
        }

        // --- UI Update Functions ---
        function updateUI() {
            renderExpenses();
            updateTotals();
            updateCharts();
            updateSettingsModal(); // Refresh settings in modal
        }

        function updateSettingsModal() {
            currencyExchangeRateInput.value = cadToAedRate;
            monthlyBudgetInput.value = monthlyBudget;
        }

        function renderExpenses() {
            expenseTableBody.innerHTML = '';
            if (expenses.length === 0) {
                expenseTableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 10px; color: #555;">No expenses added yet.</td></tr>';
                return;
            }

            expenses.forEach((expense, index) => {
                const row = expenseTableBody.insertRow();
                row.innerHTML = `
                    <td>${expense.date}</td>
                    <td>${expense.category}</td>
                    <td>${expense.description}</td>
                    <td>${formatCurrency(expense.amount, 'CAD')}</td>
                    <td>${formatCurrency(expense.amount * cadToAedRate, 'AED')}</td>
                    <td>${expense.paymentMethod}</td>
                    <td>${expense.paidBy}</td>
                    <td>${expense.hasBill ? (expense.billType || 'Yes') : 'No'}</td>
                    <td>
                        <button onclick="editExpense(${index})" style="background-color: #28a745;"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteExpense(${index})" style="background-color: #dc3545;"><i class="fas fa-trash-alt"></i></button>
                    </td>
                `;
            });
        }

        function updateTotals() {
            const total = expenses.reduce((sum, expense) => sum + expense.amount, 0);
            totalExpenditureSpan.textContent = formatCurrency(total, 'CAD');

            // Budget tracking
            const currentMonthTotal = expenses
                .filter(expense => {
                    const expenseDate = new Date(expense.date);
                    const now = new Date();
                    return expenseDate.getMonth() === now.getMonth() && expenseDate.getFullYear() === now.getFullYear();
                })
                .reduce((sum, expense) => sum + expense.amount, 0);

            if (monthlyBudget > 0) {
                const remaining = monthlyBudget - currentMonthTotal;
                let budgetMessage = `Monthly Budget: ${formatCurrency(monthlyBudget, 'CAD')} | Spent this month: ${formatCurrency(currentMonthTotal, 'CAD')}`;
                if (remaining >= 0) {
                    budgetMessage += ` | Remaining: ${formatCurrency(remaining, 'CAD')}`;
                    totalExpenditureSpan.style.color = '#007bff'; 
                } else {
                    budgetMessage += ` | Over budget by: ${formatCurrency(Math.abs(remaining), 'CAD')}`;
                    totalExpenditureSpan.style.color = '#dc3545'; 
                }
            } else {
                totalExpenditureSpan.style.color = '#333'; /* Default color if no budget */
            }
        }

        function updateCharts() {
            const categories = {};
            const paymentMethods = {};

            expenses.forEach(expense => {
                categories[expense.category] = (categories[expense.category] || 0) + expense.amount;
                paymentMethods[expense.paymentMethod] = (paymentMethods[expense.paymentMethod] || 0) + expense.amount;
            });

            // Category Chart
            if (categoryChart) categoryChart.destroy();
            categoryChart = new Chart(document.getElementById('categoryChart'), {
                type: 'pie',
                data: {
                    labels: Object.keys(categories),
                    datasets: [{
                        data: Object.values(categories),
                        backgroundColor: [
                            '#007bff', '#28a745', '#dc3545', '#ffc107', '#6f42c1', '#20c997', '#fd7e14', '#e83e8c', '#6c757d'
                        ],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        title: {
                            display: true,
                            text: 'Expense Distribution by Category',
                        }
                    }
                }
            });

            // Payment Method Chart
            if (paymentMethodChart) paymentMethodChart.destroy();
            paymentMethodChart = new Chart(document.getElementById('paymentMethodChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(paymentMethods),
                    datasets: [{
                        label: 'Amount (CAD)',
                        data: Object.values(paymentMethods),
                        backgroundColor: '#007bff',
                        borderColor: '#0056b3',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Expense Distribution by Payment Method',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount (CAD)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Payment Method'
                            }
                        }
                    }
                }
            });
        }

        // --- Event Handlers ---
        addExpenseBtn.addEventListener('click', async () => {
            const expenseDate = document.getElementById('expenseDate').value;
            const expenseCategory = document.getElementById('expenseCategory').value.trim();
            const expenseDescription = document.getElementById('expenseDescription').value.trim();
            const expenseAmount = parseFloat(document.getElementById('expenseAmount').value);
            const paymentMethod = document.getElementById('paymentMethod').value;
            const paidBy = document.getElementById('paidBy').value.trim();
            const hasBill = hasBillCheckbox.checked;
            const billType = hasBill ? billTypeSelect.value : '';

            if (!expenseDate || !expenseCategory || !expenseDescription || isNaN(expenseAmount) || expenseAmount <= 0 || !paymentMethod || !paidBy || (hasBill && !billType)) {
                showMessage('Please fill in all required fields correctly, including bill type if checked.', 'error');
                return;
            }

            const newExpense = {
                date: expenseDate,
                category: expenseCategory,
                description: expenseDescription,
                amount: expenseAmount,
                paymentMethod: paymentMethod,
                paidBy: paidBy,
                hasBill: hasBill,
                billType: billType,
                timestamp: new Date().toISOString()
            };

            expenses.push(newExpense);
            await saveData();
            updateUI();

            // Clear form
            document.getElementById('expenseDate').value = '';
            document.getElementById('expenseCategory').value = '';
            document.getElementById('expenseDescription').value = '';
            document.getElementById('expenseAmount').value = '';
            document.getElementById('paymentMethod').value = '';
            document.getElementById('paidBy').value = '';
            hasBillCheckbox.checked = false;
            billTypeContainer.classList.add('hidden');
            billTypeSelect.value = '';

            showMessage('Expense added successfully!', 'success');
        });

        window.deleteExpense = async (index) => {
            if (confirm('Are you sure you want to delete this expense?')) {
                expenses.splice(index, 1);
                await saveData();
                updateUI();
                showMessage('Expense deleted!', 'info');
            }
        };

        window.editExpense = (index) => {
            const expense = expenses[index];
            document.getElementById('expenseDate').value = expense.date;
            document.getElementById('expenseCategory').value = expense.category;
            document.getElementById('expenseDescription').value = expense.description;
            document.getElementById('expenseAmount').value = expense.amount;
            document.getElementById('paymentMethod').value = expense.paymentMethod;
            document.getElementById('paidBy').value = expense.paidBy;
            hasBillCheckbox.checked = expense.hasBill;
            if (expense.hasBill) {
                billTypeContainer.classList.remove('hidden');
                billTypeSelect.value = expense.billType;
            } else {
                billTypeContainer.classList.add('hidden');
                billTypeSelect.value = '';
            }

            // Remove the expense after loading it into the form for editing.
            // It will be re-added when the user clicks 'Add Expense' again.
            expenses.splice(index, 1); 
            updateUI(); // Update UI to reflect immediate deletion from table
            showMessage('Expense loaded for editing. Please modify and add again.', 'info');
        };

        hasBillCheckbox.addEventListener('change', () => {
            billTypeContainer.classList.toggle('hidden', !hasBillCheckbox.checked);
            if (!hasBillCheckbox.checked) {
                billTypeSelect.value = '';
            }
        });

        exportExcelBtn.addEventListener('click', () => {
            if (expenses.length === 0) {
                showMessage("No data to export!", "info");
                return;
            }

            const dataToExport = expenses.map(e => ({
                Date: e.date,
                Category: e.category,
                Description: e.description,
                'Amount (CAD)': e.amount,
                'Amount (AED)': (e.amount * cadToAedRate).toFixed(2),
                'Payment Method': e.paymentMethod,
                'Paid By': e.paidBy,
                'Has Bill': e.hasBill ? 'Yes' : 'No',
                'Bill Type': e.billType || ''
            }));

            const ws = XLSX.utils.json_to_sheet(dataToExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Expenses");
            XLSX.writeFile(wb, "Monthly_Expenses.xlsx");
            showMessage("Expenses exported to Excel!", "success");
        });

        // --- Excel Upload Logic ---
        uploadExcelBtn.addEventListener('click', () => {
            uploadExcelInput.click(); // Trigger the hidden file input
        });

        uploadExcelInput.addEventListener('change', handleExcelUpload);

        async function handleExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            showLoading("Reading Excel file...");
            const reader = new FileReader();

            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    // Ensure XLSX is accessible as a global object
                    const workbook = window.XLSX.read(data, { type: 'array', cellDates: true });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const json = window.XLSX.utils.sheet_to_json(worksheet, { header: 1 }); // Read as array of arrays

                    if (json.length < 2) {
                        showMessage("Excel file is empty or has no data rows.", "error");
                        hideLoading();
                        return;
                    }

                    // Assuming the first row is headers
                    const headers = json[0].map(h => String(h || '').trim()); // Ensure header is string and trim
                    const expectedHeaders = ['Date', 'Category', 'Description', 'Amount (CAD)', 'Payment Method', 'Paid By', 'Has Bill', 'Bill Type'];

                    // Basic header validation
                    const missingHeaders = expectedHeaders.filter(header => !headers.includes(header));
                    if (missingHeaders.length > 0) {
                        showMessage(`Missing expected columns in Excel: ${missingHeaders.join(', ')}. Please ensure your file matches the expected format.`, "error");
                        hideLoading();
                        return;
                    }

                    const newExpenses = [];
                    for (let i = 1; i < json.length; i++) { // Start from the second row for data
                        const row = json[i];
                        const expenseData = {};
                        headers.forEach((header, index) => {
                            expenseData[header] = row[index];
                        });

                        // Map Excel data to our expense object format
                        const dateValue = expenseData['Date'];
                        let formattedDate;
                        if (dateValue instanceof Date) {
                            formattedDate = dateValue.toISOString().split('T')[0];
                        } else if (typeof dateValue === 'string') {
                            // Try to parse string dates, handle common formats
                            try {
                                formattedDate = new Date(dateValue).toISOString().split('T')[0];
                                if (isNaN(new Date(formattedDate).getTime())) { // Check for invalid date
                                     throw new Error("Invalid date string");
                                }
                            } catch (error) {
                                console.warn(`Could not parse date: ${dateValue}. Using current date.`);
                                formattedDate = new Date().toISOString().split('T')[0]; // Fallback to current date
                            }
                        } else if (typeof dateValue === 'number') {
                             // Assume it's a number (Excel date), convert it
                             // Excel dates are numbers representing days since 1900-01-01 (or 1904 for Mac)
                             // 25569 is the difference in days between 1900-01-01 and 1970-01-01
                             formattedDate = new Date(Math.round((dateValue - 25569) * 86400 * 1000)).toISOString().split('T')[0];
                        } else {
                            console.warn(`Invalid date format for value: ${dateValue}. Using current date.`);
                            formattedDate = new Date().toISOString().split('T')[0];
                        }
                        
                        const amount = parseFloat(expenseData['Amount (CAD)']);
                        // Convert 'Yes'/'No' (case-insensitive) to boolean
                        const hasBillBool = String(expenseData['Has Bill'] || '').toLowerCase() === 'yes';

                        if (!formattedDate || isNaN(amount) || amount <= 0 || !expenseData['Category'] || !expenseData['Description'] || !expenseData['Payment Method'] || !expenseData['Paid By']) {
                            console.warn(`Skipping invalid row ${i + 1} due to missing or invalid data:`, expenseData);
                            showMessage(`Skipped row ${i + 1} due to missing or invalid data.`, "error");
                            continue;
                        }

                        newExpenses.push({
                            date: formattedDate,
                            category: String(expenseData['Category'] || '').trim(),
                            description: String(expenseData['Description'] || '').trim(),
                            amount: amount,
                            paymentMethod: String(expenseData['Payment Method'] || '').trim(),
                            paidBy: String(expenseData['Paid By'] || '').trim(),
                            hasBill: hasBillBool,
                            billType: hasBillBool ? String(expenseData['Bill Type'] || '').trim() : '',
                            timestamp: new Date().toISOString()
                        });
                    }

                    if (newExpenses.length === 0) {
                        showMessage("No valid expenses found in the uploaded file.", "info");
                        hideLoading();
                        return;
                    }

                    expenses.push(...newExpenses); // Add new expenses to existing ones
                    await saveData();
                    updateUI();
                    showMessage(`${newExpenses.length} expenses imported successfully from Excel!`, "success");

                } catch (error) {
                    console.error("Error reading or parsing Excel file:", error);
                    showMessage(`Error processing Excel file: ${error.message}. Please check file format and console for details.`, "error");
                } finally {
                    hideLoading();
                    event.target.value = ''; // Clear the file input
                }
            };

            reader.onerror = (error) => {
                console.error("FileReader error:", error);
                showMessage("Failed to read file.", "error");
                hideLoading();
            };

            reader.readAsArrayBuffer(file);
        }
        // --- Authentication & App Flow ---
        authButton.addEventListener('click', () => {
            if (isDefaultConfig) {
                showMessage("Firebase is not configured. Cannot sign in with Google.", "error");
                return;
            }
            showLoading("Signing in...");
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider)
                .then((result) => {
                    currentUserId = result.user.uid;
                    isGuestMode = false;
                    localStorage.removeItem('guestExpenses');
                    localStorage.removeItem('guestSettings');
                    loadData();
                    loginScreen.classList.add('hidden');
                    mainAppContainer.classList.remove('hidden');
                    updateProfileUI(result.user.email, result.user.displayName);
                    hideLoading();
                    showMessage(`Welcome, ${result.user.displayName || result.user.email}!`, "success");
                })
                .catch((error) => {
                    console.error("Google Sign-In Error:", error);
                    hideLoading();
                    showMessage(`Sign-in failed: ${error.message}`, "error");
                });
        });

        guestButton.addEventListener('click', () => {
            currentUserId = 'guest';
            isGuestMode = true;
            loadData();
            loginScreen.classList.add('hidden');
            mainAppContainer.classList.remove('hidden');
            updateProfileUI("guest@example.com", "Guest User");
            hideLoading();
            showMessage("Continuing as guest. Data will be saved locally.", "info");
        });

        if (!isDefaultConfig) {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUserId = user.uid;
                    isGuestMode = false;
                    loadData();
                    loginScreen.classList.add('hidden');
                    mainAppContainer.classList.remove('hidden');
                    updateProfileUI(user.email, user.displayName);
                    hideLoading();
                    showMessage(`Welcome back, ${user.displayName || user.email}!`, "success");
                } else {
                    currentUserId = null;
                    loginScreen.classList.remove('hidden');
                    mainAppContainer.classList.add('hidden');
                    hideLoading();
                }
            });
        } else {
            hideLoading();
            loginScreen.classList.remove('hidden');
            document.getElementById('authButton').style.display = 'none';
        }

        profileToggleButton.addEventListener('click', () => {
            profileDropdownContent.classList.toggle('active');
        });

        window.addEventListener('click', (event) => {
            if (!profileToggleButton.contains(event.target) && !profileDropdownContent.contains(event.target)) {
                profileDropdownContent.classList.remove('active');
            }
        });

        signOutButton.addEventListener('click', async () => {
            if (isGuestMode) {
                currentUserId = null;
                isGuestMode = false;
                expenses = [];
                cadToAedRate = 2.68;
                monthlyBudget = 0;
                updateUI();
                loginScreen.classList.remove('hidden');
                mainAppContainer.classList.add('hidden');
                profileDropdownContent.classList.remove('active');
                showMessage("Signed out of guest mode. Local data cleared.", "info");
            } else if (auth) {
                showLoading("Signing out...");
                try {
                    await signOut(auth);
                    currentUserId = null;
                    isGuestMode = false;
                    expenses = [];
                    cadToAedRate = 2.68;
                    monthlyBudget = 0;
                    updateUI();
                    loginScreen.classList.remove('hidden');
                    mainAppContainer.classList.add('hidden');
                    profileDropdownContent.classList.remove('active');
                    hideLoading();
                    showMessage("Signed out successfully!", "success");
                } catch (error) {
                    console.error("Sign Out Error:", error);
                    hideLoading();
                    showMessage(`Sign-out failed: ${error.message}`, "error");
                }
            }
        });

        function updateProfileUI(email, displayName) {
            const initial = displayName ? displayName.charAt(0).toUpperCase() : (email ? email.charAt(0).toUpperCase() : 'G');
            profileIconText.textContent = initial;
            avatarInitial.textContent = initial;
            mainAppUserInfoDisplay.textContent = email;
            userInfoDisplay.textContent = `You are currently signed in as: ${email}`;
        }

        // --- Settings Modal Logic ---
        settingsButton.addEventListener('click', () => {
            profileDropdownContent.classList.remove('active');
            updateSettingsModal();
            settingsModal.classList.remove('hidden');
        });

        closeSettingsModal.addEventListener('click', () => {
            settingsModal.classList.add('hidden');
        });

        saveSettingsButton.addEventListener('click', async () => {
            const newRate = parseFloat(currencyExchangeRateInput.value);
            const newBudget = parseFloat(monthlyBudgetInput.value);

            if (!isNaN(newRate) && newRate > 0) {
                cadToAedRate = newRate;
            } else if (currencyExchangeRateInput.value !== "") {
                showMessage("Please enter a valid positive number for exchange rate.", "error");
                return;
            } else {
                cadToAedRate = 2.68;
            }

            if (!isNaN(newBudget) && newBudget >= 0) {
                monthlyBudget = newBudget;
            } else if (monthlyBudgetInput.value !== "") {
                showMessage("Please enter a valid non-negative number for monthly budget.", "error");
                return;
            } else {
                monthlyBudget = 0;
            }

            await saveData();
            updateUI();
            settingsModal.classList.add('hidden');
            showMessage("Settings saved successfully!", "success");
        });

        clearAllDataButton.addEventListener('click', clearAllData);

        const today = new Date();
        const currentYear = today.getFullYear();
        const currentMonth = String(today.getMonth() + 1).padStart(2, '0');
        const currentDay = String(today.getDate()).padStart(2, '0');
        document.getElementById('expenseDate').value = `${currentYear}-${currentMonth}-${currentDay}`;
    </script>
</body>
</html>
