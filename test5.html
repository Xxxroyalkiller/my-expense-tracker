<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker - Professional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    </head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div id="loadingOverlay" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex flex-col justify-center items-center z-[1000] text-white text-2xl hidden opacity-0 transition-opacity duration-300">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
        <p id="loadingMessage" class="mt-4">Loading...</p>
    </div>

    <div id="messageContainer" class="fixed top-4 right-4 z-[1001] flex flex-col space-y-2"></div>

    <div id="loginScreen" class="bg-white p-8 rounded-lg shadow-md w-full max-w-md text-center">
        <h1 class="text-3xl font-bold mb-4">Welcome to Expense Tracker</h1>
        <p class="text-gray-600 mb-6">Sign in to manage your expenses.</p>
        <button id="googleSignInBtn" class="w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 flex items-center justify-center gap-2 mb-3">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon" class="w-5 h-5">
            Sign in with Google
        </button>
        <button id="guestSignInBtn" class="w-full bg-gray-200 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-300 flex items-center justify-center gap-2">
            <i class="fas fa-user text-gray-600"></i>
            Continue as Guest
        </button>
    </div>

    <div id="mainAppContainer" class="hidden w-full max-w-6xl mx-auto space-y-6">
        <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between">
            <h1 class="text-3xl font-bold text-gray-800">Expense Tracker</h1>
            
            <div class="relative inline-block text-left">
                <button id="profileButton" class="flex items-center justify-center w-12 h-12 rounded-full bg-blue-100 text-blue-800 font-bold text-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                    <span id="profileIconText">G</span>
                </button>
                <div id="profileDropdownContent" class="hidden origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none">
                    <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="profile-button">
                        <div class="flex items-center px-4 py-2 text-sm text-gray-700">
                            <span id="avatarInitial" class="flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-blue-800 font-bold text-md mr-2">G</span>
                            <span id="mainAppUserInfo" class="font-semibold break-words max-w-[150px] overflow-hidden text-ellipsis">Guest User</span>
                        </div>
                        <a href="#" id="settingsLink" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">
                            <i class="fas fa-sliders-h mr-2"></i> Settings
                        </a>
                        <a href="#" id="signOutBtn" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50" role="menuitem">
                            <i class="fas fa-sign-out-alt mr-2"></i> Sign Out
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-semibold mb-4">Add New Expense</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                <div>
                    <label for="expenseDate" class="block text-sm font-medium text-gray-700">Date</label>
                    <input type="date" id="expenseDate" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
                <div>
                    <label for="expenseCategory" class="block text-sm font-medium text-gray-700">Category</label>
                    <input type="text" id="expenseCategory" placeholder="e.g., Groceries, Transport" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
                <div>
                    <label for="expenseDescription" class="block text-sm font-medium text-gray-700">Description</label>
                    <input type="text" id="expenseDescription" placeholder="e.g., Weekly shopping, Uber ride" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
                <div>
                    <label for="expenseAmount" class="block text-sm font-medium text-gray-700">Amount (CAD)</label>
                    <input type="number" id="expenseAmount" placeholder="e.g., 50.00" step="0.01" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
                <div>
                    <label for="paymentMethod" class="block text-sm font-medium text-gray-700">Payment Method</label>
                    <input type="text" id="paymentMethod" placeholder="e.g., Credit Card, Cash" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
                <div>
                    <label for="paidBy" class="block text-sm font-medium text-gray-700">Paid By</label>
                    <input type="text" id="paidBy" placeholder="e.g., John, Jane" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
                <div class="flex items-center col-span-1 md:col-span-2 lg:col-span-1">
                    <input type="checkbox" id="hasBill" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                    <label for="hasBill" class="ml-2 block text-sm text-gray-900">Has Bill?</label>
                </div>
                <div id="billTypeContainer" class="hidden col-span-1 md:col-span-2 lg:col-span-1">
                    <label for="billType" class="block text-sm font-medium text-gray-700">Bill Type</label>
                    <input type="text" id="billType" placeholder="e.g., Digital, Physical" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
            </div>
            <button id="addExpenseBtn" class="mt-4 w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600">Add Expense</button>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-md grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <h2 class="text-2xl font-semibold mb-4">Monthly Expenditure</h2>
                <div class="relative h-64">
                    <canvas id="monthlyChart"></canvas>
                </div>
                <p id="monthlyChartEmptyState" class="text-gray-500 text-center italic mt-4 hidden">No monthly expense data to display.</p>
            </div>
            <div>
                <h2 class="text-2xl font-semibold mb-4">Expenses by Category</h2>
                <div class="relative h-64">
                    <canvas id="categoryChart"></canvas>
                </div>
                <p id="categoryChartEmptyState" class="text-gray-500 text-center italic mt-4 hidden">No category expense data to display.</p>
            </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-semibold mb-4">Upload Expenses from Excel</h2>
            <p class="text-gray-700 mb-4 text-sm">Upload an Excel file (.xlsx, .xls) containing your expenses. Ensure your file has columns like 'Date', 'Category', 'Description', 'Amount', 'Payment Method', 'Paid By', 'Has Bill?', and 'Bill Type'.</p>
            <div class="flex flex-col md:flex-row items-center gap-4">
                <input type="file" id="excelUploadInput" accept=".xlsx, .xls" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                <button id="uploadExcelBtn" class="mt-2 md:mt-0 bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 w-full md:w-auto">
                    <i class="fas fa-upload mr-2"></i> Upload Expenses
                </button>
            </div>
            <div id="uploadStatus" class="mt-4 p-3 text-sm rounded-md border hidden"></div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-semibold mb-4">Export Data</h2>
            <div class="flex flex-col md:flex-row items-center gap-4">
                <button id="exportAllDataBtn" class="bg-gray-200 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-300 w-full md:w-auto">
                    <i class="fas fa-file-excel mr-2"></i> Export All Data
                </button>
                <select id="monthSelect" class="mt-1 block w-full md:w-auto border border-gray-300 rounded-md shadow-sm p-2 text-gray-700">
                    <option value="">Select Month</option>
                </select>
                <button id="downloadExcelBtn" class="mt-2 md:mt-0 bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 w-full md:w-auto">
                    <i class="fas fa-download mr-2"></i> Download Monthly Data
                </button>
            </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-semibold mb-4">Your Expenses</h2>

            <div class="mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <h3 class="text-lg font-semibold mb-3 text-gray-800"><i class="fas fa-filter mr-2"></i> Filter Expenses</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div>
                        <label for="filterCategory" class="block text-sm font-medium text-gray-700">Filter by Category</label>
                        <select id="filterCategory" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                            <option value="">All Categories</option>
                            </select>
                    </div>
                    <div>
                        <label for="filterPaymentMethod" class="block text-sm font-medium text-gray-700">Filter by Payment Method</label>
                        <select id="filterPaymentMethod" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                            <option value="">All Methods</option>
                            </select>
                    </div>
                    <div class="col-span-full md:col-span-1">
                        <label class="block text-sm font-medium text-gray-700 mb-1">View Data From</label>
                        <div class="flex items-center space-x-4 flex-wrap gap-2">
                            <label class="inline-flex items-center">
                                <input type="radio" name="dataSourceFilter" value="" checked class="form-radio h-4 w-4 text-blue-600 border-gray-300">
                                <span class="ml-2 text-gray-800 text-sm">All Sources</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="dataSourceFilter" value="manual" class="form-radio h-4 w-4 text-blue-600 border-gray-300">
                                <span class="ml-2 text-gray-800 text-sm">Manual Entry</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="dataSourceFilter" value="uploaded" class="form-radio h-4 w-4 text-blue-600 border-gray-300">
                                <span class="ml-2 text-gray-800 text-sm">Uploaded File</span>
                            </label>
                        </div>
                    </div>
                    <div class="col-span-full flex justify-start md:justify-end">
                        <button id="clearFiltersBtn" class="bg-gray-200 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-300 w-full md:w-auto">
                            <i class="fas fa-times-circle mr-2"></i> Clear All Filters
                        </button>
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount (CAD)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount (AED)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount (INR)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Payment Method</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Paid By</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Has Bill?</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bill Type</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="expenseTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
                <p id="expenseTableEmptyState" class="text-gray-500 text-center italic mt-4 hidden">No expenses to display for the current filters.</p>
            </div>
            <div class="mt-4 p-3 bg-blue-50 text-blue-700 font-bold text-lg flex justify-between items-center rounded-md">
                <span>Total Expenditure (CAD):</span>
                <span id="totalExpenditureSpan">C$0.00</span>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex justify-center items-center z-[1000] hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md relative scale-95 opacity-0 transition-all duration-300">
            <button id="closeSettingsModal" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            <h2 class="text-2xl font-semibold mb-4">Settings</h2>
            <div class="mb-4">
                <label for="defaultCurrencySelect" class="block text-sm font-medium text-gray-700">Default Display Currency:</label>
                <select id="defaultCurrencySelect" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    <option value="CAD">CAD - Canadian Dollar</option>
                    <option value="AED">AED - United Arab Emirates Dirham</option>
                    <option value="INR">INR - Indian Rupee</option>
                </select>
            </div>
            <button id="saveSettingsBtn" class="w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600">Save Settings</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, setDoc, getDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Your Firebase configuration
        // !!! IMPORTANT: REPLACE WITH YOUR ACTUAL FIREBASE PROJECT CONFIGURATION !!!
        const firebaseConfig = {
            apiKey: "AIzaSyA_x5ENsCsHpcdYxgxi1a3vPs_vUR6Hkts",
            authDomain: "my-expenese-tracker.firebaseapp.com",
            projectId: "my-expenese-tracker",
            storageBucket: "my-expenese-tracker.firebasestorage.app",
            messagingSenderId: "466782350290",
            appId: "466782350290-0cljann4p9h7oqnboark3a5bj6ruilu0.apps.googleusercontent.com",
            measurementId: "G-1CF1ZNLPC2"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        // --- DOM Elements ---
        const loginScreen = document.getElementById('loginScreen');
        const googleSignInBtn = document.getElementById('googleSignInBtn');
        const guestSignInBtn = document.getElementById('guestSignInBtn');
        const mainAppContainer = document.getElementById('mainAppContainer');
        const signOutBtn = document.getElementById('signOutBtn');
        const addExpenseBtn = document.getElementById('addExpenseBtn');
        const expenseDateInput = document.getElementById('expenseDate');
        const expenseCategoryInput = document.getElementById('expenseCategory');
        const expenseDescriptionInput = document.getElementById('expenseDescription');
        const expenseAmountInput = document.getElementById('expenseAmount');
        const paymentMethodInput = document.getElementById('paymentMethod');
        const paidByInput = document.getElementById('paidBy');
        const hasBillInput = document.getElementById('hasBill');
        const billTypeContainer = document.getElementById('billTypeContainer');
        const billTypeInput = document.getElementById('billType');
        const expenseTableBody = document.getElementById('expenseTableBody');
        const totalExpenditureSpan = document.getElementById('totalExpenditureSpan');
        const monthlyChartCanvas = document.getElementById('monthlyChart');
        const categoryChartCanvas = document.getElementById('categoryChart');
        const profileButton = document.getElementById('profileButton');
        const profileDropdownContent = document.getElementById('profileDropdownContent');
        const profileIconText = document.getElementById('profileIconText');
        const mainAppUserInfo = document.getElementById('mainAppUserInfo');
        const avatarInitial = document.getElementById('avatarInitial');
        const settingsLink = document.getElementById('settingsLink');
        const settingsModal = document.getElementById('settingsModal');
        const closeSettingsModalBtn = document.getElementById('closeSettingsModal');
        const defaultCurrencySelect = document.getElementById('defaultCurrencySelect');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const messageContainer = document.getElementById('messageContainer');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingMessage = document.getElementById('loadingMessage');
        const exportAllDataBtn = document.getElementById('exportAllDataBtn');
        const downloadExcelBtn = document.getElementById('downloadExcelBtn');
        const monthSelect = document.getElementById('monthSelect');
        const excelUploadInput = document.getElementById('excelUploadInput');
        const uploadExcelBtn = document.getElementById('uploadExcelBtn');
        const uploadStatus = document.getElementById('uploadStatus');

        // Filter Elements
        const filterCategorySelect = document.getElementById('filterCategory');
        const filterPaymentMethodSelect = document.getElementById('filterPaymentMethod');
        const clearFiltersBtn = document.getElementById('clearFiltersBtn');
        const dataSourceFilterRadios = document.querySelectorAll('input[name="dataSourceFilter"]');

        // Empty state messages for elements
        const expenseTableEmptyState = document.getElementById('expenseTableEmptyState');
        const monthlyChartEmptyState = document.getElementById('monthlyChartEmptyState');
        const categoryChartEmptyState = document.getElementById('categoryChartEmptyState');


        // --- Global Variables ---
        let currentUserId = null;
        let expenses = [];
        let unsubscribeFromExpenses = null; // To manage Firestore listener
        let monthlyChartInstance = null;
        let categoryChartInstance = null;

        // Exchange rates (example, update as needed)
        const EXCHANGE_RATE_CAD_TO_AED = 2.67;
        const EXCHANGE_RATE_CAD_TO_INR = 61.27;

        // User Settings (default)
        let userSettings = {
            defaultCurrency: 'CAD'
        };

        // Filter state
        let currentFilterCategory = '';
        let currentFilterPaymentMethod = '';
        let currentDataSourceFilter = '';

        // Fixed, default dataset ID
        const DEFAULT_DATASET_ID = 'default';

        // --- Utility Functions ---

        /**
         * Debounce function to limit how often a function can run.
         * Useful for event listeners that fire frequently (e.g., input, scroll).
         * @param {Function} func The function to debounce.
         * @param {number} delay The delay in milliseconds.
         * @returns {Function} The debounced function.
         */
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        function showMessage(msg, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `p-3 rounded-md shadow-md text-white ${
                type === 'success' ? 'bg-green-500' :
                type === 'error' ? 'bg-red-500' :
                'bg-blue-500'
            } opacity-0 transition-opacity duration-300`;
            messageDiv.textContent = msg;
            messageContainer.appendChild(messageDiv);

            setTimeout(() => {
                messageDiv.classList.add('opacity-100');
            }, 10); // Small delay to trigger CSS transition

            setTimeout(() => {
                messageDiv.classList.remove('opacity-100');
                messageDiv.addEventListener('transitionend', () => {
                    messageDiv.remove();
                });
            }, 5000); // Message disappears after 5 seconds
        }

        function showLoading(msg = "Loading...") {
            loadingMessage.textContent = msg;
            loadingOverlay.classList.remove('hidden');
            setTimeout(() => loadingOverlay.classList.add('opacity-100'), 10); // Add visible class for transition
        }

        function hideLoading() {
            loadingOverlay.classList.remove('opacity-100');
            loadingOverlay.addEventListener('transitionend', () => {
                if (!loadingOverlay.classList.contains('opacity-100')) {
                    loadingOverlay.classList.add('hidden');
                }
            }, { once: true });
        }

        function showModal(modalElement) {
            modalElement.classList.remove('hidden');
            setTimeout(() => {
                modalElement.classList.add('opacity-100');
                modalElement.querySelector('.bg-white').classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function hideModal(modalElement) {
            modalElement.classList.remove('opacity-100');
            modalElement.querySelector('.bg-white').classList.remove('scale-100', 'opacity-100');
            modalElement.addEventListener('transitionend', () => {
                if (!modalElement.classList.contains('opacity-100')) {
                    modalElement.classList.add('hidden');
                }
            }, { once: true });
        }


        // --- Firebase Auth Functions ---

        googleSignInBtn.addEventListener('click', async () => {
            showLoading("Signing in with Google...");
            try {
                await signInWithPopup(auth, googleProvider);
            }
            catch (error) {
                console.error("Google Sign-In Error:", error);
                const errorMessage = error.code === 'auth/popup-closed-by-user' ? 'Sign-in cancelled.' : `Sign-in failed: ${error.message}`;
                showMessage(errorMessage, "error");
            } finally {
                hideLoading();
            }
        });

        guestSignInBtn.addEventListener('click', async () => {
            showLoading("Signing in as Guest...");
            try {
                await signInAnonymously(auth);
            }
            catch (error) {
                console.error("Guest Sign-In Error:", error);
                showMessage(`Guest sign-in failed: ${error.message}`, "error");
            } finally {
                hideLoading();
            }
        });

        signOutBtn.addEventListener('click', async () => {
            showLoading("Signing out...");
            try {
                await signOut(auth);
                showMessage('Signed out successfully!', 'info');
            }
            catch (error) {
                console.error("Sign-Out Error:", error);
                showMessage(`Sign-out failed: ${error.message}`, "error");
            } finally {
                hideLoading();
            }
        });

        // --- User Settings Management ---

        function loadUserSettings() {
            const storedSettings = localStorage.getItem('userSettings');
            if (storedSettings) {
                userSettings = JSON.parse(storedSettings);
            }
            defaultCurrencySelect.value = userSettings.defaultCurrency;
        }

        function saveUserSettings() {
            userSettings.defaultCurrency = defaultCurrencySelect.value;
            localStorage.setItem('userSettings', JSON.stringify(userSettings));
            showMessage('Settings saved!', 'success');
            renderExpenses(); // Re-render to apply new currency
            hideModal(settingsModal); // Close modal after saving
        }

        settingsLink.addEventListener('click', (event) => {
            event.preventDefault();
            profileDropdownContent.classList.remove('show'); // Close profile dropdown
            showModal(settingsModal);
            defaultCurrencySelect.value = userSettings.defaultCurrency; // Ensure current setting is displayed
        });

        closeSettingsModalBtn.addEventListener('click', () => {
            hideModal(settingsModal);
        });

        settingsModal.addEventListener('click', (event) => {
            if (event.target === settingsModal) {
                hideModal(settingsModal);
            }
        });

        saveSettingsBtn.addEventListener('click', saveSettings);

        // --- Core Expense Functions (SIMPLIFIED FOR SINGLE DATASET) ---

        function listenToExpenses(userId) {
            if (unsubscribeFromExpenses) {
                unsubscribeFromExpenses(); // Stop listening to old expenses
            }

            if (!userId) {
                expenses = []; // Clear expenses if no user
                renderExpenses();
                hideLoading();
                return;
            }

            showLoading("Loading your expenses...");
            // Direct reference to the 'expenses' subcollection under the 'default' dataset for the current user
            const expensesCollectionRef = collection(db, `users/${userId}/datasets/${DEFAULT_DATASET_ID}/expenses`);
            const q = query(expensesCollectionRef, orderBy('date', 'desc'), orderBy('timestamp', 'desc')); // Order by date then by timestamp for stable sort

            unsubscribeFromExpenses = onSnapshot(q, (snapshot) => {
                const fetchedExpenses = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    fetchedExpenses.push({
                        id: doc.id,
                        date: data.date,
                        category: data.category,
                        description: data.description,
                        amount: data.amount,
                        paymentMethod: data.paymentMethod,
                        paidBy: data.paidBy,
                        hasBill: data.hasBill,
                        billType: data.billType,
                        source: data.source || 'manual' // Default to manual if old data without source field
                    });
                });
                expenses = fetchedExpenses;
                renderExpenses(); // Render and update charts
                hideLoading();
                showMessage(`Expenses synchronized!`, 'success');
            }, (error) => {
                console.error("Error fetching Firestore expenses:", error);
                showMessage("Error loading expenses. Check console for details.", "error");
                hideLoading();
            });
        }

        function renderExpenses() {
            // Create a document fragment to build table rows efficiently
            const fragment = document.createDocumentFragment();
            let totalExpenditure = 0;

            // Filter expenses based on current selections
            const filteredExpenses = expenses.filter(expense => {
                const matchesCategory = currentFilterCategory === '' || expense.category === currentFilterCategory;
                const matchesPaymentMethod = currentFilterPaymentMethod === '' || expense.paymentMethod === currentFilterPaymentMethod;
                const matchesSource = currentDataSourceFilter === '' || expense.source === currentDataSourceFilter;
                return matchesCategory && matchesPaymentMethod && matchesSource;
            });

            if (filteredExpenses.length === 0) {
                expenseTableEmptyState.classList.remove('hidden');
            } else {
                expenseTableEmptyState.classList.add('hidden');
            }

            filteredExpenses.forEach(expense => {
                const amountCad = parseFloat(expense.amount);
                totalExpenditure += amountCad;

                const amountAED = (amountCad * EXCHANGE_RATE_CAD_TO_AED).toFixed(2);
                const amountINR = (amountCad * EXCHANGE_RATE_CAD_TO_INR).toFixed(2);

                let displayAmountCAD = `C$${amountCad.toFixed(2)}`;
                let displayAmountAED = `AED ${amountAED}`;
                let displayAmountINR = `INR ${amountINR}`;

                const row = document.createElement('tr'); // Create tr element
                row.className = 'hover:bg-gray-50'; // Add hover effect
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${expense.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${expense.category}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${expense.description}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${displayAmountCAD}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${displayAmountAED}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${displayAmountINR}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${expense.paymentMethod || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${expense.paidBy || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">${expense.hasBill ? '<i class="fas fa-check-circle text-green-500"></i>' : '<i class="fas fa-times-circle text-red-500"></i>'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${expense.hasBill ? (expense.billType || 'N/A') : 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button data-id="${expense.id}" class="text-red-600 hover:text-red-900 ml-2 delete-btn p-1 rounded-full hover:bg-red-50 transition-colors" title="Delete Expense">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                fragment.appendChild(row); // Append to fragment, not directly to DOM
            });

            // Clear the actual table body once
            expenseTableBody.innerHTML = '';
            // Append the entire fragment to the table body in a single DOM operation
            expenseTableBody.appendChild(fragment);


            totalExpenditureSpan.textContent = `C$${totalExpenditure.toFixed(2)}`;

            const allMonthlyExpenses = {};
            const allCategoryExpenses = {};
            if (expenses.length > 0) {
                expenses.forEach(expense => {
                    const amountCad = parseFloat(expense.amount);
                    const monthYear = new Date(expense.date).toLocaleString('en-US', { month: 'short', year: 'numeric' });
                    allMonthlyExpenses[monthYear] = (allMonthlyExpenses[monthYear] || 0) + amountCad;
                    const category = expense.category || 'Uncategorized';
                    allCategoryExpenses[category] = (allCategoryExpenses[category] || 0) + amountCad;
                });
                monthlyChartEmptyState.classList.add('hidden');
                categoryChartEmptyState.classList.add('hidden');
            } else {
                monthlyChartEmptyState.classList.remove('hidden');
                categoryChartEmptyState.classList.add('hidden');
            }


            updateCharts(allMonthlyExpenses, allCategoryExpenses);
            populateMonthSelect();
            populateFilterDropdowns();
        }

        addExpenseBtn.addEventListener('click', async () => {
            if (!currentUserId) {
                showMessage("Please sign in to add expenses.", "error");
                return;
            }

            const date = expenseDateInput.value;
            const category = expenseCategoryInput.value.trim();
            const description = expenseDescriptionInput.value.trim();
            const amount = parseFloat(expenseAmountInput.value);
            const paymentMethod = paymentMethodInput.value.trim();
            const paidBy = paidByInput.value.trim();
            const hasBill = hasBillInput.checked;
            const billType = hasBill ? billTypeInput.value.trim() : '';

            if (!date || !category || !description || isNaN(amount) || amount <= 0 || !paymentMethod || !paidBy || (hasBill && !billType)) {
                showMessage('Please fill in all required fields and ensure the amount is a positive number.', 'error');
                return;
            }

            showLoading("Adding expense...");
            try {
                // Use the fixed DEFAULT_DATASET_ID
                await addDoc(collection(db, `users/${currentUserId}/datasets/${DEFAULT_DATASET_ID}/expenses`), {
                    date,
                    category,
                    description,
                    amount,
                    paymentMethod,
                    paidBy,
                    hasBill,
                    billType,
                    source: 'manual', // Mark as manual entry
                    timestamp: new Date().toISOString() // Use ISO string for consistent sorting
                });
                showMessage('Expense added successfully!', 'success');
                // Clear inputs and reset UI
                expenseDateInput.value = new Date().toISOString().slice(0, 10); // Reset to today
                expenseCategoryInput.value = '';
                expenseDescriptionInput.value = '';
                expenseAmountInput.value = '';
                paymentMethodInput.value = '';
                paidByInput.value = '';
                hasBillInput.checked = false;
                billTypeInput.value = '';
                billTypeContainer.classList.add('hidden');
                expenseCategoryInput.focus(); // Focus back to category for quick entry
            }
            catch (e) {
                console.error("Error adding document: ", e);
                showMessage('Error adding expense. Please try again.', 'error');
            } finally {
                hideLoading();
            }
        });

        expenseTableBody.addEventListener('click', async (event) => {
            if (event.target.classList.contains('delete-btn') || event.target.closest('.delete-btn')) {
                if (!currentUserId) {
                    showMessage("Please sign in to delete expenses.", "error");
                    return;
                }
                const btn = event.target.closest('.delete-btn');
                const expenseId = btn.dataset.id;
                if (confirm('Are you sure you want to delete this expense?')) {
                    showLoading("Deleting expense...");
                    try {
                        // Use the fixed DEFAULT_DATASET_ID
                        await deleteDoc(doc(db, `users/${currentUserId}/datasets/${DEFAULT_DATASET_ID}/expenses`, expenseId));
                        showMessage('Expense deleted successfully!', 'success');
                    }
                    catch (e) {
                        console.error("Error deleting document: ", e);
                        showMessage('Error deleting expense. Please try again.', 'error');
                    } finally {
                        hideLoading();
                    }
                }
            }
        });

        hasBillInput.addEventListener('change', () => {
            billTypeContainer.classList.toggle('hidden', !hasBillInput.checked);
            if (!hasBillInput.checked) {
                billTypeInput.value = '';
            } else {
                billTypeInput.focus();
            }
        });

        // --- Charting Functions ---

        function updateCharts(monthlyData, categoryData) {
            // Monthly Chart
            const monthlyLabels = Object.keys(monthlyData).sort((a, b) => new Date(a) - new Date(b));
            const monthlyValues = monthlyLabels.map(label => monthlyData[label]);

            if (monthlyChartInstance) {
                monthlyChartInstance.destroy();
            }
            monthlyChartInstance = new Chart(monthlyChartCanvas, {
                type: 'bar',
                data: {
                    labels: monthlyLabels,
                    datasets: [{
                        label: 'Total CAD Expenditure',
                        data: monthlyValues,
                        backgroundColor: 'rgba(59, 130, 246, 0.5)', /* blue-500 */
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // Category Chart
            const categoryLabels = Object.keys(categoryData).sort();
            const categoryValues = categoryLabels.map(label => categoryData[label]);

            if (categoryChartInstance) {
                categoryChartInstance.destroy();
            }
            categoryChartInstance = new Chart(categoryChartCanvas, {
                type: 'pie',
                data: {
                    labels: categoryLabels,
                    datasets: [{
                        label: 'Expenses by Category',
                        data: categoryValues,
                        backgroundColor: [
                            '#4299E1', '#48BB78', '#F6E05E', '#ED8936', '#9F7AEA',
                            '#ECC94B', '#63B3ED', '#FC8181', '#A0AEC0', '#48BB78'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += 'C$' + context.parsed.toFixed(2);
                                        const total = context.dataset.data.reduce((acc, val) => acc + val, 0);
                                        const percentage = ((context.parsed / total) * 100).toFixed(1);
                                        label += ` (${percentage}%)`;
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // --- Excel Upload Function ---
        async function handleExcelUpload() {
            if (!currentUserId) {
                showMessage("Please sign in to upload expenses.", "error");
                return;
            }

            const file = excelUploadInput.files[0];
            if (!file) {
                showMessage('Please select an Excel file to upload.', 'info');
                return;
            }

            // Clear previous status and prepare for new
            uploadStatus.classList.add('hidden');
            uploadStatus.classList.remove('border-green-300', 'border-red-300', 'border-blue-300');
            uploadStatus.innerHTML = '';


            showLoading("Processing Excel file...");

            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonExpenses = XLSX.utils.sheet_to_json(worksheet, {
                    raw: false, // Keep raw values, don't try to parse dates/numbers yet
                    defval: '' // Set default value for empty cells
                });

                if (jsonExpenses.length === 0) {
                    showMessage('The selected Excel file contains no data.', 'info');
                    uploadStatus.classList.remove('hidden');
                    uploadStatus.classList.add('border-blue-300', 'text-blue-700');
                    uploadStatus.innerHTML = '<p>The selected Excel file contains no data.</p>';
                    hideLoading();
                    return;
                }

                const validExpenses = [];
                const invalidRows = [];

                // Define expected headers and their mapping with possible variations
                const headerMap = {
                    date: ['Date', 'Expense Date', 'Transaction Date'],
                    category: ['Category', 'Expense Category'],
                    description: ['Description', 'Expense Description', 'Details'],
                    amount: ['Amount', 'Expense Amount', 'Total Amount'],
                    paymentMethod: ['Payment Method', 'PaymentMethod', 'Method of Payment'],
                    paidBy: ['Paid By', 'PaidBy', 'Payer'],
                    hasBill: ['Has Bill?', 'HasBill', 'Bill Available'],
                    billType: ['Bill Type', 'BillType', 'Type of Bill']
                };

                // Helper to find column value by trying multiple header names
                const findColumnValue = (row, possibleHeaders) => {
                    for (const header of possibleHeaders) {
                        if (row[header] !== undefined) {
                            return String(row[header]).trim();
                        }
                    }
                    return ''; // Return empty string if no header matches
                };

                // Helper to convert Excel date number to YYYY-MM-DD
                const excelDateToISODate = (excelDateNumber) => {
                    // Excel's epoch for 1900-based date system (most common)
                    const excelEpoch = new Date(1899, 11, 30); // Dec 30, 1899
                    const date = new Date(excelEpoch.getTime() + excelDateNumber * 24 * 60 * 60 * 1000);
                    // Handle potential time zone issues by getting UTC values
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                };


                jsonExpenses.forEach((row, index) => {
                    const expense = {};
                    let isValid = true;
                    let validationErrors = [];

                    // Extract and validate each field using the headerMap
                    // Date
                    const dateRaw = findColumnValue(row, headerMap.date);
                    if (!dateRaw) {
                        isValid = false;
                        validationErrors.push('Missing Date');
                    } else {
                        let parsedDate = '';
                        // Find which specific header was used and get its raw value for type checking
                        const actualDateHeader = headerMap.date.find(h => row[h] !== undefined);
                        if (typeof row[actualDateHeader] === 'number') {
                            // It's an Excel numeric date
                            try {
                                parsedDate = excelDateToISODate(row[actualDateHeader]);
                            } catch (e) {
                                isValid = false;
                                validationErrors.push('Invalid Date format (numeric)');
                            }
                        } else if (/^\d{4}-\d{2}-\d{2}$/.test(dateRaw)) {
                            parsedDate = dateRaw; // Already in YYYY-MM-DD
                        } else {
                            // Try parsing other common date formats
                            const d = new Date(dateRaw);
                            if (!isNaN(d.getTime())) {
                                parsedDate = d.toISOString().slice(0, 10);
                            } else {
                                isValid = false;
                                validationErrors.push('Invalid Date format (expected YYYY-MM-DD or readable date string)');
                            }
                        }
                        expense.date = parsedDate;
                    }

                    // Category
                    expense.category = findColumnValue(row, headerMap.category);
                    if (!expense.category) {
                        isValid = false;
                        validationErrors.push('Missing Category');
                    }

                    // Description
                    expense.description = findColumnValue(row, headerMap.description);
                    if (!expense.description) {
                        isValid = false;
                        validationErrors.push('Missing Description');
                    }

                    // Amount
                    const amountRaw = findColumnValue(row, headerMap.amount);
                    const amount = parseFloat(amountRaw);
                    if (isNaN(amount) || amount <= 0) {
                        isValid = false;
                        validationErrors.push('Invalid Amount (must be a positive number)');
                    }
                    expense.amount = amount;

                    // Payment Method
                    expense.paymentMethod = findColumnValue(row, headerMap.paymentMethod);
                    if (!expense.paymentMethod) {
                        isValid = false;
                        validationErrors.push('Missing Payment Method');
                    }

                    // Paid By
                    expense.paidBy = findColumnValue(row, headerMap.paidBy);
                    if (!expense.paidBy) {
                        isValid = false;
                        validationErrors.push('Missing Paid By');
                    }

                    // Has Bill?
                    const hasBillRaw = findColumnValue(row, headerMap.hasBill).toLowerCase();
                    expense.hasBill = ['yes', 'true', '1'].includes(hasBillRaw);

                    // Bill Type
                    expense.billType = findColumnValue(row, headerMap.billType);
                    if (expense.hasBill && !expense.billType) {
                        isValid = false;
                        validationErrors.push('Bill Type required if Has Bill? is "Yes"');
                    }

                    expense.source = 'uploaded'; // Tag uploaded expenses
                    expense.timestamp = new Date().toISOString(); // Add timestamp for order

                    if (isValid) {
                        validExpenses.push(expense);
                    } else {
                        invalidRows.push({ rowNumber: index + 2, data: row, errors: validationErrors.join('; ') }); // +2 for 1-based index and header row
                    }
                });

                if (validExpenses.length === 0) {
                    uploadStatus.classList.remove('hidden');
                    uploadStatus.classList.add('border-red-300', 'text-red-700');
                    uploadStatus.innerHTML = `
                        <p class="font-bold">No valid expenses found in the file.</p>
                        ${invalidRows.length > 0 ? `<p class="mt-2 text-sm font-semibold">Details for Invalid Rows (${invalidRows.length}):</p><ul class="list-disc list-inside text-xs max-h-24 overflow-y-auto">${invalidRows.map(r => `<li>Row ${r.rowNumber}: ${r.errors}</li>`).join('')}</ul>` : ''}
                        <p class="mt-2 text-xs text-gray-600">Please check your Excel file for correct column headers and data format.</p>
                    `;
                    showMessage('Excel upload failed: No valid expenses.', 'error');
                    hideLoading();
                    return;
                }

                // Batch write to Firestore
                const batch = writeBatch(db);
                // Use the fixed DEFAULT_DATASET_ID for the collection path
                const expensesCollectionRef = collection(db, `users/${currentUserId}/datasets/${DEFAULT_DATASET_ID}/expenses`);
                validExpenses.forEach(expense => {
                    const newDocRef = doc(expensesCollectionRef);
                    batch.set(newDocRef, expense);
                });

                await batch.commit();

                let messageType = 'success';
                let messageText = '';
                if (invalidRows.length > 0) {
                    messageType = 'info';
                    messageText = `Successfully uploaded ${validExpenses.length} expense(s). However, ${invalidRows.length} row(s) were invalid and skipped.`;
                    uploadStatus.classList.remove('hidden');
                    uploadStatus.classList.add('border-blue-300', 'text-blue-700');
                    uploadStatus.innerHTML = `
                        <p class="font-bold">${messageText}</p>
                        <p class="mt-2 text-sm font-semibold">Details for Skipped Rows (${invalidRows.length}):</p>
                        <ul class="list-disc list-inside text-xs max-h-24 overflow-y-auto">${invalidRows.map(r => `<li>Row ${r.rowNumber}: ${r.errors}</li>`).join('')}</ul>
                        <p class="mt-2 text-xs text-gray-600">Please check your Excel file for correct column headers and data format.</p>
                    `;
                } else {
                    messageText = `Successfully uploaded ${validExpenses.length} expense(s)!`;
                    uploadStatus.classList.remove('hidden');
                    uploadStatus.classList.add('border-green-300', 'text-green-700');
                    uploadStatus.innerHTML = `<p class="font-bold">${messageText}</p>`;
                }

                showMessage(messageText, messageType);
                excelUploadInput.value = ''; // Clear the file input
            }
            catch (error) {
                console.error('Error uploading Excel file:', error);
                showMessage('Error processing Excel file. Please ensure it is a valid .xlsx or .xls file and check console for details.', 'error');
                uploadStatus.classList.remove('hidden');
                uploadStatus.classList.add('border-red-300', 'text-red-700');
                uploadStatus.innerHTML = `<p class="font-bold">Failed to upload Excel file: ${error.message}</p>`;
            } finally {
                hideLoading();
            }
        }

        uploadExcelBtn.addEventListener('click', handleExcelUpload);

        // --- Excel Export Functions ---

        exportAllDataBtn.addEventListener('click', () => {
            if (!currentUserId) {
                showMessage('Please sign in to export data.', 'info');
                return;
            }
            if (expenses.length === 0) {
                showMessage('No data to export!', 'info');
                return;
            }

            const dataToExport = expenses.map(expense => ({
                Date: expense.date,
                Category: expense.category,
                Description: expense.description,
                Amount: expense.amount,
                'Payment Method': expense.paymentMethod,
                'Paid By': expense.paidBy,
                'Has Bill?': expense.hasBill ? 'Yes' : 'No',
                'Bill Type': expense.billType,
                Source: expense.source
            }));

            const ws = XLSX.utils.json_to_sheet(dataToExport);

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "All Expenses");

            const fileName = `All_Expenses_${new Date().toISOString().slice(0, 10)}.xlsx`;
            XLSX.writeFile(wb, fileName);
            showMessage('All expenses exported to Excel!', 'success');
        });

        function populateMonthSelect() {
            const months = new Set();
            expenses.forEach(expense => {
                // Ensure date is a valid string for Date constructor
                const date = new Date(expense.date);
                if (!isNaN(date.getTime())) { // Check if date is valid
                    months.add(date.toLocaleString('en-US', { year: 'numeric', month: 'long' }));
                }
            });

            monthSelect.innerHTML = '<option value="">Select Month</option>';
            Array.from(months).sort((a, b) => new Date(a) - new Date(b)).forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = month;
                monthSelect.appendChild(option);
            });
            // Keep the previously selected month if it exists
            const currentSelectedMonth = monthSelect.value;
            if (currentSelectedMonth && months.has(currentSelectedMonth)) {
                monthSelect.value = currentSelectedMonth;
            } else {
                monthSelect.value = ''; // Reset if previously selected month is no longer available
            }
        }

        downloadExcelBtn.addEventListener('click', () => {
            if (!currentUserId) {
                showMessage('Please sign in to download data.', 'info');
                return;
            }
            const selectedMonth = monthSelect.value;
            if (!selectedMonth) {
                showMessage('Please select a month to download.', 'info');
                return;
            }

            const filteredByMonth = expenses.filter(expense => {
                const date = new Date(expense.date);
                // Ensure date is valid before comparing
                return !isNaN(date.getTime()) && date.toLocaleString('en-US', { year: 'numeric', month: 'long' }) === selectedMonth;
            });

            if (filteredByMonth.length === 0) {
                showMessage(`No expenses found for ${selectedMonth}.`, 'info');
                return;
            }

            const dataToExport = filteredByMonth.map(expense => ({
                Date: expense.date,
                Category: expense.category,
                Description: expense.description,
                Amount: expense.amount,
                'Payment Method': expense.paymentMethod,
                'Paid By': expense.paidBy,
                'Has Bill?': expense.hasBill ? 'Yes' : 'No',
                'Bill Type': expense.billType,
                Source: expense.source
            }));

            const ws = XLSX.utils.json_to_sheet(dataToExport);

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, `${selectedMonth} Expenses`);

            const fileName = `Expenses_${selectedMonth.replace(/ /g, '_')}.xlsx`;
            XLSX.writeFile(wb, fileName);
            showMessage(`Expenses for ${selectedMonth} downloaded as Excel!`, "success");
        });

        // --- Filtering Functions ---

        function populateFilterDropdowns() {
            const categories = new Set();
            const paymentMethods = new Set();

            expenses.forEach(expense => {
                if (expense.category) categories.add(expense.category);
                if (expense.paymentMethod) paymentMethods.add(expense.paymentMethod);
            });

            // Populate Category Filter
            filterCategorySelect.innerHTML = '<option value="">All Categories</option>';
            Array.from(categories).sort().forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                filterCategorySelect.appendChild(option);
            });
            filterCategorySelect.value = currentFilterCategory; // Set selected value

            // Populate Payment Method Filter
            filterPaymentMethodSelect.innerHTML = '<option value="">All Methods</option>';
            Array.from(paymentMethods).sort().forEach(method => {
                const option = document.createElement('option');
                option.value = method;
                option.textContent = method;
                filterPaymentMethodSelect.appendChild(option);
            });
            filterPaymentMethodSelect.value = currentFilterPaymentMethod; // Set selected value
        }

        // Debounced version of renderExpenses for filters
        const debouncedRenderExpenses = debounce(renderExpenses, 300); // 300ms debounce

        filterCategorySelect.addEventListener('change', (event) => {
            currentFilterCategory = event.target.value;
            debouncedRenderExpenses();
        });

        filterPaymentMethodSelect.addEventListener('change', (event) => {
            currentFilterPaymentMethod = event.target.value;
            debouncedRenderExpenses();
        });

        dataSourceFilterRadios.forEach(radio => {
            radio.addEventListener('change', (event) => {
                currentDataSourceFilter = event.target.value;
                debouncedRenderExpenses();
            });
        });

        clearFiltersBtn.addEventListener('click', () => {
            currentFilterCategory = '';
            currentFilterPaymentMethod = '';
            currentDataSourceFilter = ''; // Reset source filter
            filterCategorySelect.value = '';
            filterPaymentMethodSelect.value = '';
            // Reset radio buttons to 'All Sources'
            document.querySelector('input[name="dataSourceFilter"][value=""]').checked = true;
            renderExpenses(); // Call directly as it's a single click action
            showMessage('All filters cleared!', 'info');
        });

        // --- Profile Dropdown ---
        profileButton.addEventListener('click', (event) => {
            event.stopPropagation(); // Prevent document click from closing it immediately
            profileDropdownContent.classList.toggle('hidden'); // Toggle hidden class
        });

        // Close the dropdown if the user clicks outside of it
        window.addEventListener('click', (event) => {
            if (!event.target.closest('#profileDropdownContent') && !event.target.closest('#profileButton')) {
                profileDropdownContent.classList.add('hidden');
            }
        });

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            expenseDateInput.value = `${yyyy}-${mm}-${dd}`;

            // Initial chart setup to prevent errors before data loads
            updateCharts({}, {});

            // Firebase Auth State Listener
            onAuthStateChanged(auth, async (user) => {
                console.log("onAuthStateChanged fired. User:", user);
                if (user) {
                    currentUserId = user.uid;

                    let displayEmail = user.email || (user.isAnonymous ? 'Guest User' : 'Unknown User');
                    let displayName = user.displayName || 'Guest';
                    let initial = displayName.charAt(0).toUpperCase();

                    // Always show the initial/fallback icon
                    profileIconText.textContent = initial;
                    avatarInitial.textContent = initial;

                    mainAppUserInfo.textContent = displayEmail;
                    // In this simplified styling, profileIconText and avatarInitial don't have 'hidden' to remove
                    // They are always visible as the profile button content.

                    loginScreen.classList.add('hidden');
                    mainAppContainer.classList.remove('hidden');

                    console.log('User signed in:', user.uid, 'Anonymous:', user.isAnonymous);

                    loadUserSettings();
                    listenToExpenses(currentUserId); // Directly start listening to expenses
                } else {
                    currentUserId = null;

                    mainAppUserInfo.textContent = '';

                    // Always show the 'G' for guest/signed out
                    profileIconText.textContent = 'G';
                    avatarInitial.textContent = 'G';

                    mainAppContainer.classList.add('hidden');
                    loginScreen.classList.remove('hidden');

                    console.log('User signed out.');

                    expenses = [];
                    renderExpenses();
                    if (unsubscribeFromExpenses) {
                        unsubscribeFromExpenses();
                        unsubscribeFromExpenses = null;
                    }
                    showMessage('Your data will be available when you sign in.', 'info');
                    userSettings = { defaultCurrency: 'CAD' };
                    localStorage.removeItem('userSettings');
                }
                console.log("Auth state check complete, hiding loading overlay.");
                hideLoading(); // Ensure loading is hidden after auth check completes
            }, (error) => {
                console.error("Auth state change error:", error);
                showMessage("Authentication error. Please refresh the page.", "error");
                hideLoading();
            });
        });

        // Show loading spinner immediately on page load
        showLoading("Starting application...");
    </script>
</body>
</html>
