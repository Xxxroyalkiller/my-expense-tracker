<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Expenditure Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Import getDoc, setDoc, doc for settings persistence
        import { getFirestore, collection, addDoc, query, onSnapshot, deleteDoc, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your Firebase project configuration (REPLACE THIS WITH YOUR ACTUAL CONFIG)
        const firebaseConfig = {
            apiKey: "AIzaSyA_x5ENsCsHpcdYxgxi1a3vPs_vUR6Hkts",
            authDomain: "my-expenese-tracker.firebaseapp.com",
            projectId: "my-expenese-tracker",
            storageBucket: "my-expenese-tracker.firebasestorage.app",
            messagingSenderId: "466782350290",
            appId: "466782350290-0cljann4p9h7oqnboark3a5bj6ruilu0.apps.googleusercontent.com",
            measurementId: "G-1CF1ZNLPC2"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // Global variables for Firebase instances (accessible by other scripts)
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.googleAuthProvider = provider;

        // Export Firebase functions to make them available globally for use in the main script
        window.onFirebaseAuthChanged = onAuthStateChanged;
        window.firebaseSignInWithPopup = signInWithPopup;
        window.firebaseSignOut = signOut;
        window.firebaseAddDoc = addDoc;
        window.firebaseCollection = collection;
        window.firebaseQuery = query;
        window.firebaseOnSnapshot = onSnapshot;
        window.firebaseDeleteDoc = deleteDoc;
        window.firebaseDoc = doc;
        window.firebaseGetDoc = getDoc; // Export getDoc
        window.firebaseSetDoc = setDoc; // Export setDoc
        window.firebaseSignInAnonymously = signInAnonymously;
    </script>
    <style>
        /* Apple-like font stack (system fonts with fallbacks) */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            background-color: #f5f5f7; /* Very light gray, almost white */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
            color: #333; /* Darker text for better readability */
        }

        /* Custom scrollbar for the table container - subtle grays */
        .table-container::-webkit-scrollbar {
            height: 8px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background-color: #d1d1d6; /* Light gray */
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-track {
            background-color: #e8e8ed; /* Even lighter gray */
        }
        
        /* Chart container styling for responsiveness */
        .chart-container {
            position: relative;
            height: 400px; /* Max height for charts */
            width: 100%;
            margin: auto; /* Center the charts */
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 500px;
            }
        }
        
        /* Loading overlay - clean and simple */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.95); /* More opaque white */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
            gap: 16px;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #007aff; /* Apple blue */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* General button styling for a softer, Apple-like look */
        .btn-primary {
            background-color: #007aff; /* Apple Blue */
            color: white;
            padding: 12px 24px;
            border-radius: 12px; /* More rounded */
            font-weight: 500;
            transition: background-color 0.2s ease, transform 0.1s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Subtle shadow */
        }
        .btn-primary:hover {
            background-color: #0066cc; /* Slightly darker blue on hover */
            transform: translateY(-1px); /* Slight lift */
        }
        .btn-primary:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.5); /* Blue ring focus */
        }

        .btn-secondary {
            background-color: #f0f0f0; /* Light gray background */
            color: #333;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 500;
            transition: background-color 0.2s ease, transform 0.1s ease;
            border: 1px solid #d1d1d6; /* Subtle border */
        }
        .btn-secondary:hover {
            background-color: #e0e0e0;
            transform: translateY(-1px);
        }
        .btn-secondary:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
        }

        .btn-danger {
            background-color: #ff3b30; /* Apple Red */
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 500;
            transition: background-color 0.2s ease, transform 0.1s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn-danger:hover {
            background-color: #cc0000;
            transform: translateY(-1px);
        }
        .btn-danger:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 59, 48, 0.5);
        }

        /* Input field styling */
        .app-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d1d6; /* Light gray border */
            border-radius: 8px; /* Slightly rounded */
            background-color: white;
            color: #333;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .app-input:focus {
            outline: none;
            border-color: #007aff; /* Blue border on focus */
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2); /* Soft blue glow */
        }
        .app-select {
            appearance: none; /* Remove default arrow */
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='currentColor'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem; /* Space for the custom arrow */
        }
        
        /* Card/Container styling */
        .app-card {
            background-color: white;
            border-radius: 18px; /* More pronounced rounding for main cards */
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.05); /* Softer, more diffuse shadow */
            padding: 32px; /* Increased padding */
            margin-bottom: 24px; /* Consistent spacing */
        }

        /* Table styling */
        .app-table {
            border-collapse: separate; /* Allows for rounded corners on cells/rows */
            border-spacing: 0;
            width: 100%;
        }

        .app-table thead {
            background-color: #f8f8fa; /* Very light gray for table header */
        }

        .app-table th {
            padding: 16px 24px;
            text-align: left;
            font-weight: 600; /* Slightly bolder header text */
            font-size: 0.85rem;
            color: #666;
            border-bottom: 1px solid #e0e0e0;
        }

        .app-table td {
            padding: 14px 24px;
            border-bottom: 1px solid #efefef; /* Lighter divider */
            color: #333;
            font-size: 0.95rem;
        }

        .app-table tbody tr:last-child td {
            border-bottom: none; /* No border on the last row */
        }

        .app-table tbody tr:hover {
            background-color: #f9f9f9; /* Subtle hover effect */
        }

        /* Specific overrides for messages and totals */
        .message-success {
            background-color: #e6f7ed; /* Soft green */
            color: #1a6438; /* Dark green text */
            border-color: #8ce1a7;
        }
        .message-error {
            background-color: #ffebe6; /* Soft red */
            color: #b32f2f; /* Dark red text */
            border-color: #ff8c8c;
        }
        .message-info {
            background-color: #e6f0ff; /* Soft blue */
            color: #004d99; /* Dark blue text */
            border-color: #8cbaff;
        }

        #totalExpenditure {
            font-size: 1.6rem; /* Larger total amount */
            font-weight: 700;
            color: #007aff; /* Apple Blue for total */
        }

        .section-header {
            font-size: 1.8rem; /* Larger, bolder headers */
            font-weight: 700;
            color: #333;
            text-align: center;
            margin-bottom: 24px;
        }

        .sub-section-header {
            font-size: 1.4rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 16px;
        }

        /* Profile circle and Settings icon */
        #userProfileCircle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e0e0e0; /* Light gray background */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1rem;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            position: relative;
            transition: background-color 0.2s ease;
        }
        #userProfileCircle:hover {
            background-color: #d1d1d6;
        }
        #userProfileCircle .fa-user {
            font-size: 1.2rem;
            color: #666;
        }
        #userProfileCircle .tooltip-text {
            visibility: hidden;
            width: max-content;
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%; /* Position the tooltip above the text */
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem;
            white-space: nowrap;
        }
        #userProfileCircle:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }


        #settingsButton {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            color: #666;
            font-size: 1.5rem;
            transition: color 0.2s ease;
        }
        #settingsButton:hover {
            color: #333;
        }

        /* Settings Modal */
        #settingsModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4); /* Dark overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
            box-sizing: border-box;
        }

        #settingsModal .modal-content {
            background-color: white;
            border-radius: 18px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 32px;
            width: 100%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        #settingsModal .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            border-bottom: 1px solid #eee;
            padding-bottom: 16px;
        }
        #settingsModal .modal-header h2 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #333;
        }
        #settingsModal .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            color: #666;
            cursor: pointer;
            line-height: 1;
        }
        #settingsModal .modal-section {
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid #f0f0f0;
        }
        #settingsModal .modal-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        #settingsModal .modal-section h3 {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 16px;
        }
        #settingsModal .field-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            padding: 8px 0;
        }
        #settingsModal .field-row .field-label {
            flex-grow: 1;
            color: #555;
            font-size: 0.95rem;
        }
        #settingsModal .field-row .field-actions {
            display: flex;
            gap: 8px;
        }
        #settingsModal .field-row button {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        #settingsModal .field-row .edit-btn {
            background-color: #007aff;
            color: white;
        }
        #settingsModal .field-row .edit-btn:hover {
            background-color: #0066cc;
        }
        #settingsModal .field-row .remove-btn {
            background-color: #ff3b30;
            color: white;
        }
        #settingsModal .field-row .remove-btn:hover {
            background-color: #cc0000;
        }
        #settingsModal .add-field-btn {
            margin-top: 16px;
            padding: 10px 20px;
            background-color: #52c41a; /* Green for add */
            color: white;
            border-radius: 12px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        #settingsModal .add-field-btn:hover {
            background-color: #389e08;
        }

        .settings-input {
            border: 1px solid #d1d1d6;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.95rem;
            color: #333;
            flex-grow: 1; /* Allow inputs to fill space */
        }
        .settings-select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='currentColor'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.2em 1.2em;
            padding-right: 2.5rem;
        }
        .settings-checkbox-container {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
            cursor: pointer;
        }
        .settings-checkbox-container input[type="checkbox"] {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid #d1d1d6;
            cursor: pointer;
            flex-shrink: 0;
        }
        .settings-checkbox-container label {
            font-size: 0.95rem;
            color: #333;
            flex-grow: 1;
            cursor: pointer;
        }
    </style>
</head>
<body class="flex flex-col items-center p-4 min-h-screen">
    <div id="loadingOverlay" class="loading-overlay"> <div class="spinner"></div>
        <p class="text-gray-700 text-lg">Initializing app...</p>
    </div>

    <div id="loginScreen" class="app-card max-w-md w-full text-center hidden">
        <h1 class="text-4xl font-bold text-gray-900 mb-6 section-header">Welcome to your Expense Tracker.</h1>
        <p class="text-gray-600 text-lg mb-8">Sign in with your Google account to effortlessly track your spending, or proceed as a guest.</p>
        <div class="space-y-4">
            <button id="authButton" class="btn-primary w-full">
                Sign In with Google
            </button>
            <button id="guestButton" class="btn-secondary w-full">
                Continue as Guest
            </button>
        </div>
        <p class="text-gray-500 text-xs mt-4">Guest data is temporary and not permanently stored. Consider signing in with Google for data persistence.</p>
        <div id="userInfo" class="text-gray-500 mt-6 text-sm"></div>
    </div>

    <div id="mainAppContainer" class="max-w-4xl w-full space-y-6 hidden">
        <div class="app-card flex flex-col md:flex-row items-center justify-between">
            <h1 class="text-4xl font-bold text-gray-900 mb-4 md:mb-0 section-header md:text-left">Expense Tracker</h1>
            <div class="flex items-center gap-4 mt-4 md:mt-0">
                <div id="userProfileCircle">
                    <i class="fas fa-user"></i>
                    <span class="tooltip-text" id="userEmailTooltip"></span>
                </div>
                <button id="settingsButton" aria-label="Settings">
                    <i class="fas fa-cog"></i>
                </button>
                <button id="signOutButton" class="btn-danger">
                    Sign Out
                </button>
            </div>
        </div>

        <div class="app-card">
            <h2 class="sub-section-header">Add New Expense</h2>
            <div id="expenseInputFormGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div>
                    <label for="expenseDate" class="block text-sm font-medium text-gray-600 mb-1"><span id="label-expenseDate">Date</span><span class="required-asterisk text-red-500 ml-1 hidden">*</span></label>
                    <input type="date" id="expenseDate" class="app-input">
                </div>
                <div>
                    <label for="expenseCategory" class="block text-sm font-medium text-gray-600 mb-1"><span id="label-expenseCategory">Category</span><span class="required-asterisk text-red-500 ml-1 hidden">*</span></label>
                    <input type="text" id="expenseCategory" placeholder="e.g., Groceries, Rent" class="app-input">
                </div>
                <div>
                    <label for="expenseDescription" class="block text-sm font-medium text-gray-600 mb-1"><span id="label-expenseDescription">Description</span><span class="required-asterisk text-red-500 ml-1 hidden">*</span></label>
                    <input type="text" id="expenseDescription" placeholder="e.g., Weekly shopping" class="app-input">
                </div>
                <div>
                    <label for="expenseAmount" class="block text-sm font-medium text-gray-600 mb-1"><span id="label-expenseAmount">Amount (CAD)</span><span class="required-asterisk text-red-500 ml-1 hidden">*</span></label>
                    <input type="number" id="expenseAmount" placeholder="e.g., 50.00" step="0.01" class="app-input">
                </div>
                <div>
                    <label for="paymentMethod" class="block text-sm font-medium text-gray-600 mb-1"><span id="label-paymentMethod">Payment Method</span><span class="required-asterisk text-red-500 ml-1 hidden">*</span></label>
                    <select id="paymentMethod" class="app-input app-select">
                        <option value="">Select Method</option>
                        <option value="Credit Card">Credit Card</option>
                        <option value="Debit Card">Debit Card</option>
                        <option value="Cash">Cash</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                        <option value="Online Payment">Online Payment</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div>
                    <label for="paidBy" class="block text-sm font-medium text-gray-600 mb-1"><span id="label-paidBy">Paid By</span><span class="required-asterisk text-red-500 ml-1 hidden">*</span></label>
                    <input type="text" id="paidBy" placeholder="e.g., John, Sarah" class="app-input">
                </div>
                <div class="col-span-full md:col-span-2 lg:col-span-1 flex items-center mt-3">
                    <input type="checkbox" id="hasBill" class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label for="hasBill" class="ml-2 block text-sm font-medium text-gray-600"><span id="label-hasBill">Do you have the bill?</span><span class="required-asterisk text-red-500 ml-1 hidden">*</span></label>
                </div>
                <div class="col-span-full md:col-span-2 lg:col-span-1" id="billTypeContainer" style="display: none;">
                    <label for="billType" class="block text-sm font-medium text-gray-600 mb-1"><span id="label-billType">Bill Type</span><span class="required-asterisk text-red-500 ml-1 hidden">*</span></label>
                    <select id="billType" class="app-input app-select">
                        <option value="">Select Type</option>
                        <option value="Physical">Physical</option>
                        <option value="Digital">Digital</option>
                    </select>
                </div>
                <div id="customFieldsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:col-span-4 gap-4">
                    </div>
            </div>
            <button id="addExpenseBtn" class="btn-primary w-full">
                Add Expense
            </button>
        </div>

        <div class="app-card">
            <h2 class="sub-section-header">Your Expenses</h2>
            <div class="overflow-x-auto rounded-xl border border-gray-200 table-container">
                <table class="app-table">
                    <thead>
                        <tr>
                            <th scope="col">Date</th>
                            <th scope="col">Category</th>
                            <th scope="col">Description</th>
                            <th scope="col">Amount (CAD)</th>
                            <th scope="col">Amount (AED)</th>
                            <th scope="col">Amount (INR)</th>
                            <th scope="col">Method</th>
                            <th scope="col">Paid By</th>
                            <th scope="col">Has Bill?</th>
                            <th scope="col">Bill Type</th>
                            <th scope="col" id="customFieldHeaders"></th>
                            <th scope="col" class="relative px-6 py-3">
                                <span class="sr-only">Delete</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="expenseTableBody" class="bg-white divide-y divide-gray-100">
                        </tbody>
                </table>
            </div>
        </div>

        <div class="app-card flex justify-end">
            <h2 class="text-xl font-bold text-gray-800">Total Expenditure: <span id="totalExpenditure">C$0.00</span></h2>
        </div>

        <div class="app-card">
            <h2 class="sub-section-header">AI-Powered Insights</h2>
            <button id="getInsightsBtn" class="btn-primary w-full">
                Get Spending Insights ✨
            </button>
            <div id="insightsDisplay" class="mt-6 p-4 bg-gray-50 rounded-lg text-gray-700 border border-gray-200 hidden">
                <p class="font-medium">Analyzing your expenses...</p>
            </div>
        </div>

        <div class="app-card">
            <h2 class="section-header">Spending Visualizations</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <h3 class="sub-section-header text-center mb-4">Spending Distribution by Category</h3>
                    <div class="chart-container">
                        <canvas id="expenseCategoryChart"></canvas>
                    </div>
                    <p class="text-sm text-center text-gray-500 mt-4">This pie chart visualizes how your spending is distributed across different categories.</p>
                </div>
                <div>
                    <h3 class="sub-section-header text-center mb-4">Monthly Total Expenditure</h3>
                    <div class="chart-container">
                        <canvas id="expenseMonthlyChart"></canvas>
                    </div>
                    <p class="text-sm text-center text-gray-500 mt-4">This bar graph shows your total expenditure for each month.</p>
                </div>
            </div>
        </div>

        <div class="app-card">
            <h2 class="sub-section-header">Download Data (CSV)</h2>
            <div class="flex flex-col md:flex-row items-center gap-4">
                <div class="flex-grow w-full md:w-auto">
                    <label for="monthSelect" class="block text-sm font-medium text-gray-600 mb-1">Select Month to Download:</label>
                    <select id="monthSelect" class="app-input app-select">
                        <option value="">Select a month...</option>
                    </select>
                </div>
                <button id="downloadCsvBtn" class="btn-secondary w-full md:w-auto mt-3 md:mt-0">
                    Download CSV
                </button>
            </div>
            <p class="text-sm text-gray-500 mt-3">Select a month to download its expenses as a CSV file, compatible with Excel/Google Sheets.</p>
        </div>
    </div>

    <div id="settingsModal" class="hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>App Settings</h2>
                <button class="modal-close" id="closeSettingsModalBtn">&times;</button>
            </div>

            <div class="modal-section">
                <h3>Required Fields for Expense Entry</h3>
                <p class="text-sm text-gray-600 mb-4">Toggle which core fields are required when adding a new expense.</p>
                <div id="requiredFieldsList">
                    </div>
            </div>

            <div class="modal-section">
                <h3>Custom Expense Fields</h3>
                <p class="text-sm text-gray-600 mb-4">Add, edit, or remove your own custom fields for expenses.</p>
                <div id="customFieldsList">
                    <p id="noCustomFieldsMessage" class="text-gray-500 italic">No custom fields added yet.</p>
                </div>
                <button id="addCustomFieldBtn" class="add-field-btn">
                    Add New Field
                </button>
            </div>

            <div class="mt-8 flex justify-end">
                <button id="saveSettingsBtn" class="btn-primary w-auto">
                    Save Settings
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // Import firebase dependencies that were made global by the first script tag
        const auth = window.firebaseAuth;
        const db = window.firebaseDb;
        const provider = window.googleAuthProvider;
        const signInWithPopup = window.firebaseSignInWithPopup;
        const signOut = window.firebaseSignOut;
        const onAuthStateChanged = window.onFirebaseAuthChanged;
        const addDoc = window.firebaseAddDoc;
        const collection = window.firebaseCollection;
        const query = window.firebaseQuery;
        const onSnapshot = window.firebaseOnSnapshot;
        const deleteDoc = window.firebaseDeleteDoc;
        const docRef = window.firebaseDoc;
        const getDoc = window.firebaseGetDoc; // New
        const setDoc = window.firebaseSetDoc; // New
        const signInAnonymously = window.firebaseSignInAnonymously;

        // DOM element references
        const expenseDateInput = document.getElementById('expenseDate');
        const expenseCategoryInput = document.getElementById('expenseCategory');
        const expenseDescriptionInput = document.getElementById('expenseDescription');
        const expenseAmountInput = document.getElementById('expenseAmount');
        const paymentMethodInput = document.getElementById('paymentMethod');
        const paidByInput = document.getElementById('paidBy');
        const hasBillInput = document.getElementById('hasBill');
        const billTypeContainer = document.getElementById('billTypeContainer');
        const billTypeInput = document.getElementById('billType');
        const addExpenseBtn = document.getElementById('addExpenseBtn');
        const expenseTableBody = document.getElementById('expenseTableBody');
        const totalExpenditureSpan = document.getElementById('totalExpenditure');
        const getInsightsBtn = document.getElementById('getInsightsBtn');
        const insightsDisplay = document.getElementById('insightsDisplay');
        const expenseCategoryChartCtx = document.getElementById('expenseCategoryChart').getContext('2d');
        const expenseMonthlyChartCtx = document.getElementById('expenseMonthlyChart').getContext('2d');
        const monthSelect = document.getElementById('monthSelect');
        const downloadCsvBtn = document.getElementById('downloadCsvBtn');

        const authButton = document.getElementById('authButton');
        const guestButton = document.getElementById('guestButton');
        const userInfoDiv = document.getElementById('userInfo');

        const mainAppContainer = document.getElementById('mainAppContainer');
        const loginScreen = document.getElementById('loginScreen');
        // REMOVED: mainAppUserInfo
        const signOutButton = document.getElementById('signOutButton');

        const loadingOverlay = document.getElementById('loadingOverlay');

        // NEW: Profile and Settings elements
        const userProfileCircle = document.getElementById('userProfileCircle');
        const userEmailTooltip = document.getElementById('userEmailTooltip');
        const settingsButton = document.getElementById('settingsButton');
        const settingsModal = document.getElementById('settingsModal');
        const closeSettingsModalBtn = document.getElementById('closeSettingsModalBtn');
        const requiredFieldsList = document.getElementById('requiredFieldsList');
        const customFieldsList = document.getElementById('customFieldsList');
        const noCustomFieldsMessage = document.getElementById('noCustomFieldsMessage');
        const addCustomFieldBtn = document.getElementById('addCustomFieldBtn');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const expenseInputFormGrid = document.getElementById('expenseInputFormGrid');
        const customFieldsContainer = document.getElementById('customFieldsContainer');
        const customFieldHeaders = document.getElementById('customFieldHeaders');


        // Global state variables
        let expenses = [];
        let currentUserId = null;
        let unsubscribeFromExpenses = null;

        // Exchange rates (CAD as base) - these are hardcoded for simplicity
        const EXCHANGE_RATE_CAD_TO_AED = 2.70;
        const EXCHANGE_RATE_CAD_TO_INR = 61.00;

        // Chart instances
        let expenseCategoryPieChart;
        let expenseMonthlyBarChart;

        // NEW: App Settings State
        const CORE_FIELDS = [
            { id: 'expenseDate', label: 'Date', type: 'date', placeholder: '' },
            { id: 'expenseCategory', label: 'Category', type: 'text', placeholder: 'e.g., Groceries, Rent' },
            { id: 'expenseDescription', label: 'Description', type: 'text', placeholder: 'e.g., Weekly shopping' },
            { id: 'expenseAmount', label: 'Amount (CAD)', type: 'number', placeholder: 'e.g., 50.00' },
            { id: 'paymentMethod', label: 'Payment Method', type: 'select', options: ['Credit Card', 'Debit Card', 'Cash', 'Bank Transfer', 'Online Payment', 'Other'] },
            { id: 'paidBy', label: 'Paid By', type: 'text', placeholder: 'e.g., John, Sarah' },
            { id: 'hasBill', label: 'Do you have the bill?', type: 'checkbox' },
            { id: 'billType', label: 'Bill Type', type: 'select', options: ['Physical', 'Digital'] }
        ];

        let appSettings = {
            requiredFields: { // Default required status for core fields
                expenseDate: true,
                expenseCategory: true,
                expenseDescription: true,
                expenseAmount: true,
                paymentMethod: true,
                paidBy: false,
                hasBill: false,
                billType: false
            },
            customFields: [] // Array to store definitions of custom fields
        };

        // --- Loading Overlay Functions ---
        function showLoading(message = "Loading...") {
            loadingOverlay.classList.remove('hidden');
            loadingOverlay.querySelector('p').textContent = message;
        }

        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }

        // --- Authentication Functions ---
        authButton.addEventListener('click', async () => {
            try {
                showLoading("Signing in with Google...");
                await signInWithPopup(auth, provider);
                showMessage('Signed in successfully with Google!', 'success');
            } catch (error) {
                console.error('Error signing in with Google:', error);
                let errorMessage = 'Failed to sign in with Google.';
                if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = 'Sign-in cancelled by user.';
                } else if (error.message) {
                    errorMessage += ` Error: ${error.message}`;
                }
                showMessage(errorMessage, 'error');
            } finally {
                hideLoading();
            }
        });

        guestButton.addEventListener('click', async () => {
            try {
                showLoading("Signing in as Guest...");
                await signInAnonymously(auth);
                showMessage('Signed in successfully as Guest!', 'success');
            } catch (error) {
                console.error('Error signing in anonymously:', error);
                showMessage('Failed to sign in as guest. Please try again.', 'error');
            } finally {
                hideLoading();
            }
        });

        signOutButton.addEventListener('click', async () => {
            try {
                showLoading("Signing out...");
                await signOut(auth);
                showMessage('Signed out successfully!', 'success');
            } catch (error) {
                console.error('Error signing out:', error);
                showMessage('Error signing out. Please try again.', 'error');
            } finally {
                hideLoading();
            }
        });


        // --- Firebase Auth State Listener ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                
                // Update user info for login screen (will be hidden)
                userInfoDiv.textContent = user.isAnonymous ? 'Welcome, Guest!' : `Welcome, ${user.displayName || user.email}!`;

                // Hide login screen, show main application
                loginScreen.classList.add('hidden');
                mainAppContainer.classList.remove('hidden');

                // NEW: Load settings and render UI
                await loadUserSettings();
                renderUserProfile(user);
                renderExpenseForm(); // Render form based on loaded settings
                
                console.log('User signed in:', user.uid, 'Anonymous:', user.isAnonymous);
                
                listenToExpenses(user.uid);
            } else {
                currentUserId = null;
                userInfoDiv.textContent = 'Please sign in to save your data.';

                mainAppContainer.classList.add('hidden');
                loginScreen.classList.remove('hidden');

                console.log('User signed out.');

                expenses = [];
                renderExpenses(); // Re-render to clear table and charts
                if (unsubscribeFromExpenses) {
                    unsubscribeFromExpenses();
                }
                // Reset settings to default when signed out
                appSettings = {
                    requiredFields: Object.assign({}, appSettings.requiredFields, { // Keep initial core field required status
                        expenseDate: true,
                        expenseCategory: true,
                        expenseDescription: true,
                        expenseAmount: true,
                        paymentMethod: true,
                        paidBy: false,
                        hasBill: false,
                        billType: false
                    }),
                    customFields: []
                };
                renderExpenseForm(); // Re-render form with default settings
                renderUserProfile(null); // Clear profile circle
                showMessage('Your data will be available when you sign in.', 'info');
            }
            hideLoading();
        });

        // NEW: Render User Profile Circle
        function renderUserProfile(user) {
            userProfileCircle.innerHTML = ''; // Clear previous content
            if (user) {
                const initials = (user.displayName || user.email || 'Guest').split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                userProfileCircle.textContent = initials;
                userEmailTooltip.textContent = user.isAnonymous ? 'Guest User' : user.email;
                userProfileCircle.classList.remove('hidden');
            } else {
                userProfileCircle.classList.add('hidden'); // Hide if no user
                userEmailTooltip.textContent = '';
            }
        }

        // --- Firestore Settings Logic ---
        async function loadUserSettings() {
            if (!currentUserId) return;
            showLoading("Loading settings...");
            try {
                const settingsDocRef = docRef(db, `users/${currentUserId}/settings/appConfig`);
                const docSnap = await getDoc(settingsDocRef);

                if (docSnap.exists()) {
                    const loadedSettings = docSnap.data();
                    // Merge loaded settings with default structure to ensure all keys are present
                    appSettings.requiredFields = { ...appSettings.requiredFields, ...loadedSettings.requiredFields };
                    appSettings.customFields = loadedSettings.customFields || [];
                    console.log("Settings loaded:", appSettings);
                    showMessage('Settings loaded!', 'success');
                } else {
                    console.log("No custom settings found for this user, using defaults.");
                    // Save default settings if they don't exist
                    await saveUserSettings();
                }
            } catch (error) {
                console.error("Error loading settings:", error);
                showMessage("Error loading settings.", "error");
            } finally {
                hideLoading();
            }
        }

        async function saveUserSettings() {
            if (!currentUserId) return;
            showLoading("Saving settings...");
            try {
                const settingsDocRef = docRef(db, `users/${currentUserId}/settings/appConfig`);
                await setDoc(settingsDocRef, appSettings, { merge: true }); // Use merge to avoid overwriting other potential settings
                console.log("Settings saved:", appSettings);
                showMessage('Settings saved!', 'success');
            } catch (error) {
                console.error("Error saving settings:", error);
                showMessage("Error saving settings.", "error");
            } finally {
                hideLoading();
            }
        }

        // --- Settings Modal UI & Logic ---
        settingsButton.addEventListener('click', openSettingsModal);
        closeSettingsModalBtn.addEventListener('click', closeSettingsModal);
        saveSettingsBtn.addEventListener('click', saveSettingsAndRefreshUI);
        addCustomFieldBtn.addEventListener('click', promptForNewCustomField);

        function openSettingsModal() {
            settingsModal.classList.remove('hidden');
            renderRequiredFieldsSettings();
            renderCustomFieldsSettings();
        }

        function closeSettingsModal() {
            settingsModal.classList.add('hidden');
        }

        async function saveSettingsAndRefreshUI() {
            closeSettingsModal();
            await saveUserSettings();
            renderExpenseForm(); // Re-render the expense form fields
            renderExpenses(); // Re-render table headers if needed (though not implemented yet for custom fields)
        }

        function renderRequiredFieldsSettings() {
            requiredFieldsList.innerHTML = '';
            CORE_FIELDS.forEach(field => {
                const div = document.createElement('div');
                div.className = 'settings-checkbox-container';
                div.innerHTML = `
                    <input type="checkbox" id="req-${field.id}" data-field-id="${field.id}" ${appSettings.requiredFields[field.id] ? 'checked' : ''} class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label for="req-${field.id}" class="text-gray-700">${field.label}</label>
                `;
                div.querySelector('input').addEventListener('change', (e) => {
                    appSettings.requiredFields[field.id] = e.target.checked;
                });
                requiredFieldsList.appendChild(div);
            });
        }

        function renderCustomFieldsSettings() {
            customFieldsList.innerHTML = '';
            if (appSettings.customFields.length === 0) {
                noCustomFieldsMessage.classList.remove('hidden');
            } else {
                noCustomFieldsMessage.classList.add('hidden');
                appSettings.customFields.forEach((field, index) => {
                    const div = document.createElement('div');
                    div.className = 'field-row';
                    div.innerHTML = `
                        <span class="field-label">${field.label} (${field.type}${field.required ? ', Required' : ''})</span>
                        <div class="field-actions">
                            <button class="edit-btn" data-index="${index}">Edit</button>
                            <button class="remove-btn" data-index="${index}">Remove</button>
                        </div>
                    `;
                    div.querySelector('.edit-btn').addEventListener('click', () => editCustomField(index));
                    div.querySelector('.remove-btn').addEventListener('click', () => removeCustomField(index));
                    customFieldsList.appendChild(div);
                });
            }
        }

        function promptForNewCustomField() {
            const fieldLabel = prompt("Enter a label for the new field (e.g., 'Project Name'):");
            if (!fieldLabel) return;

            const fieldType = prompt("Enter the type of field (text, number, date, select, checkbox):").toLowerCase();
            if (!['text', 'number', 'date', 'select', 'checkbox'].includes(fieldType)) {
                alert("Invalid field type. Please enter 'text', 'number', 'date', 'select', or 'checkbox'.");
                return;
            }

            let fieldOptions = [];
            if (fieldType === 'select') {
                const optionsString = prompt("Enter comma-separated options for the select field (e.g., 'Option1,Option2,Option3'):");
                if (!optionsString) {
                    alert("Select field requires options.");
                    return;
                }
                fieldOptions = optionsString.split(',').map(o => o.trim());
            }

            const isRequired = confirm(`Should "${fieldLabel}" be a required field?`);

            const newField = {
                id: `customField_${Date.now()}`, // Unique ID
                label: fieldLabel,
                type: fieldType,
                placeholder: fieldType === 'text' ? `Enter ${fieldLabel.toLowerCase()}` : '',
                required: isRequired,
                options: fieldOptions.length > 0 ? fieldOptions : undefined
            };

            appSettings.customFields.push(newField);
            renderCustomFieldsSettings();
            showMessage('New custom field added to settings. Click Save Settings to apply.', 'info');
        }

        function editCustomField(index) {
            const field = appSettings.customFields[index];
            if (!field) return;

            const newLabel = prompt(`Edit label for "${field.label}":`, field.label);
            if (newLabel === null) return; // User cancelled

            const newRequired = confirm(`Should "${newLabel}" be a required field? (Currently ${field.required ? 'Yes' : 'No'})`);

            // For simplicity, I'm not allowing changing type or options here.
            // A more complex UI would be needed for that.

            field.label = newLabel;
            field.required = newRequired;
            renderCustomFieldsSettings();
            showMessage('Custom field updated in settings. Click Save Settings to apply.', 'info');
        }

        function removeCustomField(index) {
            if (confirm(`Are you sure you want to remove the field "${appSettings.customFields[index].label}"? This will also remove any data associated with it from future expense entries.`)) {
                appSettings.customFields.splice(index, 1);
                renderCustomFieldsSettings();
                showMessage('Custom field removed from settings. Click Save Settings to apply.', 'info');
            }
        }


        // --- Dynamic Expense Form Rendering ---
        function renderExpenseForm() {
            // Update required asterisks for CORE_FIELDS
            CORE_FIELDS.forEach(field => {
                const labelSpan = document.getElementById(`label-${field.id}`);
                const asterisk = labelSpan ? labelSpan.nextElementSibling : null; // Get the asterisk
                if (asterisk) {
                    if (appSettings.requiredFields[field.id]) {
                        asterisk.classList.remove('hidden');
                    } else {
                        asterisk.classList.add('hidden');
                    }
                }
            });

            // Render custom fields
            customFieldsContainer.innerHTML = '';
            appSettings.customFields.forEach(field => {
                const div = document.createElement('div');
                let inputHtml = '';
                let isRequired = field.required ? 'required' : '';
                let asteriskHtml = field.required ? '<span class="required-asterisk text-red-500 ml-1">*</span>' : '';

                switch (field.type) {
                    case 'text':
                    case 'number':
                    case 'date':
                        inputHtml = `<input type="${field.type}" id="${field.id}" placeholder="${field.placeholder || ''}" class="app-input" ${isRequired}>`;
                        break;
                    case 'select':
                        inputHtml = `<select id="${field.id}" class="app-input app-select" ${isRequired}>
                            <option value="">Select ${field.label}</option>
                            ${field.options.map(option => `<option value="${option}">${option}</option>`).join('')}
                        </select>`;
                        break;
                    case 'checkbox':
                        inputHtml = `<input type="checkbox" id="${field.id}" class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500" ${isRequired}>`;
                        // For checkbox, label and input might be different
                        div.className = "col-span-full md:col-span-2 lg:col-span-1 flex items-center mt-3";
                        div.innerHTML = `
                            ${inputHtml}
                            <label for="${field.id}" class="ml-2 block text-sm font-medium text-gray-600">${field.label}${asteriskHtml}</label>
                        `;
                        customFieldsContainer.appendChild(div);
                        return; // Skip default append below
                    default:
                        inputHtml = `<input type="text" id="${field.id}" placeholder="${field.placeholder || ''}" class="app-input" ${isRequired}>`;
                }

                div.innerHTML = `
                    <label for="${field.id}" class="block text-sm font-medium text-gray-600 mb-1">${field.label}${asteriskHtml}</label>
                    ${inputHtml}
                `;
                customFieldsContainer.appendChild(div);
            });
            // Ensure the main form grid knows about the new custom field container
            expenseInputFormGrid.appendChild(customFieldsContainer);
            
            // Update table headers for custom fields
            renderCustomFieldHeaders();
        }

        function renderCustomFieldHeaders() {
            // Clear existing custom headers (if any were added)
            customFieldHeaders.innerHTML = ''; 
            const newHeaders = document.createDocumentFragment();
            appSettings.customFields.forEach(field => {
                const th = document.createElement('th');
                th.setAttribute('scope', 'col');
                th.textContent = field.label;
                newHeaders.appendChild(th);
            });
            customFieldHeaders.appendChild(newHeaders);
        }
        
        function getExpenseFormData() {
            const formData = {
                date: expenseDateInput.value,
                category: expenseCategoryInput.value.trim(),
                description: expenseDescriptionInput.value.trim(),
                amount: parseFloat(expenseAmountInput.value),
                paymentMethod: paymentMethodInput.value,
                paidBy: paidByInput.value.trim(),
                hasBill: hasBillInput.checked,
                billType: hasBillInput.checked ? billTypeInput.value : ''
            };

            // Collect custom field values
            appSettings.customFields.forEach(field => {
                const element = document.getElementById(field.id);
                if (element) {
                    if (field.type === 'checkbox') {
                        formData[field.id] = element.checked;
                    } else if (field.type === 'number') {
                        formData[field.id] = parseFloat(element.value) || 0; // Handle empty/invalid numbers
                    } else {
                        formData[field.id] = element.value.trim();
                    }
                }
            });
            return formData;
        }

        function clearForm() {
            expenseDateInput.value = new Date().toISOString().split('T')[0]; // Reset to today
            expenseCategoryInput.value = '';
            expenseDescriptionInput.value = '';
            expenseAmountInput.value = '';
            paymentMethodInput.value = '';
            paidByInput.value = '';
            hasBillInput.checked = false;
            billTypeContainer.style.display = 'none';
            billTypeInput.value = '';

            // Clear custom fields
            appSettings.customFields.forEach(field => {
                const element = document.getElementById(field.id);
                if (element) {
                    if (field.type === 'checkbox') {
                        element.checked = false;
                    } else {
                        element.value = '';
                    }
                }
            });
        }

        // --- Core Expense Logic (modified for dynamic validation/data) ---
        async function addExpense() {
            if (!currentUserId) {
                showMessage("Please sign in or continue as guest to add expenses.", "error");
                return;
            }

            const formData = getExpenseFormData();
            const errors = validateExpenseForm(formData);

            if (errors.length > 0) {
                showMessage(`Please correct the following: ${errors.join(', ')}`, "error");
                return;
            }

            try {
                showLoading("Adding expense...");
                await addDoc(collection(db, `users/${currentUserId}/expenses`), {
                    ...formData, // Spread all form data, including custom fields
                    timestamp: new Date()
                });
                showMessage("Expense added successfully!", "success");
                clearForm();
            } catch (e) {
                console.error("Error adding document: ", e);
                showMessage("Failed to add expense. Please try again.", "error");
            } finally {
                hideLoading();
            }
        }

        function validateExpenseForm(formData) {
            const errors = [];

            // Validate core fields based on appSettings.requiredFields
            CORE_FIELDS.forEach(field => {
                const isRequired = appSettings.requiredFields[field.id];
                let value = formData[field.id];

                if (isRequired) {
                    if (field.type === 'number') {
                        if (isNaN(value) || value <= 0) {
                            errors.push(`${field.label} must be a positive number`);
                        }
                    } else if (field.type === 'checkbox') {
                        if (!value) { // If checkbox is required, it must be checked
                            errors.push(`${field.label} must be checked`);
                        }
                    } else if (!value || String(value).trim() === '') {
                        errors.push(`${field.label} is required`);
                    }
                }
            });

            // Handle special logic for billType if hasBill is checked and billType is required
            if (formData.hasBill && appSettings.requiredFields.billType) {
                if (!formData.billType) {
                    errors.push("Bill Type is required when 'Do you have the bill?' is checked");
                }
            }

            // Validate custom fields based on their definitions
            appSettings.customFields.forEach(field => {
                if (field.required) {
                    let value = formData[field.id];
                    if (field.type === 'number') {
                        if (isNaN(value) || value === '') { // Allow empty string for number if not required, but if required, must be a number
                            errors.push(`${field.label} must be a number`);
                        }
                    } else if (field.type === 'checkbox') {
                        if (!value) {
                            errors.push(`${field.label} must be checked`);
                        }
                    } else if (!value || String(value).trim() === '') {
                        errors.push(`${field.label} is required`);
                    }
                }
            });

            return errors;
        }

        function renderExpenses() {
            expenseTableBody.innerHTML = '';
            let total = 0;

            expenses.sort((a, b) => new Date(b.date) - new Date(a.date));

            expenses.forEach((expense) => {
                const amountCAD = expense.amount;
                const amountAED = (amountCAD * EXCHANGE_RATE_CAD_TO_AED).toFixed(2);
                const amountINR = (amountCAD * EXCHANGE_RATE_CAD_TO_INR).toFixed(2);

                total += amountCAD;

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                let customFieldCells = '';
                appSettings.customFields.forEach(field => {
                    const fieldValue = expense[field.id] !== undefined ? expense[field.id] : 'N/A';
                    let displayValue = fieldValue;
                    if (field.type === 'checkbox') {
                        displayValue = fieldValue ? 'Yes' : 'No';
                    }
                    customFieldCells += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${displayValue}</td>`;
                });

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${expense.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 capitalize">${expense.category}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${expense.description}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">C$${amountCAD.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">AED ${amountAED}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">INR ${amountINR}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${expense.paymentMethod || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${expense.paidBy || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${expense.hasBill ? 'Yes' : 'No'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${expense.hasBill && expense.billType ? expense.billType : 'N/A'}</td>
                    ${customFieldCells}
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button data-id="${expense.id}" class="delete-btn text-red-500 hover:text-red-700 focus:outline-none">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1zm6 10a1 1 0 100-2H7a1 1 0 100 2h6z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </td>
                `;
                expenseTableBody.appendChild(row);
            });

            totalExpenditureSpan.textContent = `C$${total.toFixed(2)}`;
            updateMonthDropdown();
            renderCategoryPieChart();
            renderMonthlyBarChart();

            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => deleteExpense(e.currentTarget.dataset.id));
            });
        }

        async function deleteExpense(expenseId) {
            if (!currentUserId) {
                showMessage("You must be signed in or continued as guest to delete expenses.", "error");
                return;
            }

            if (confirm("Are you sure you want to delete this expense?")) {
                try {
                    showLoading("Deleting expense...");
                    await deleteDoc(docRef(db, `users/${currentUserId}/expenses`, expenseId));
                    showMessage("Expense deleted successfully!", "success");
                } catch (e) {
                    console.error("Error deleting document: ", e);
                    showMessage("Failed to delete expense. Please try again.", "error");
                } finally {
                    hideLoading();
                }
            }
        }

        function showMessage(message, type) {
            const existingMessage = document.getElementById('appMessage');
            if (existingMessage) {
                existingMessage.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.id = 'appMessage';
            messageDiv.textContent = message;
            messageDiv.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-lg text-white font-medium text-sm z-50 transition-all duration-300 ease-in-out transform translate-y-0`;

            if (type === 'success') {
                messageDiv.classList.add('bg-green-500', 'message-success');
            } else if (type === 'error') {
                messageDiv.classList.add('bg-red-500', 'message-error');
            } else if (type === 'info') {
                messageDiv.classList.add('bg-blue-500', 'message-info');
            } else {
                messageDiv.classList.add('bg-gray-700');
            }
            
            document.body.appendChild(messageDiv);

            setTimeout(() => {
                messageDiv.classList.add('translate-y-full', 'opacity-0');
                messageDiv.addEventListener('transitionend', () => messageDiv.remove());
            }, 3000);
        }

        // --- Chart Rendering (no changes needed) ---
        function generateColors(numColors) { /* ... (unchanged) ... */ return [ 'rgb(0, 122, 255)', 'rgb(52, 199, 89)', 'rgb(175, 82, 222)', 'rgb(255, 149, 0)', 'rgb(255, 59, 48)', 'rgb(88, 86, 214)', 'rgb(94, 92, 230)', 'rgb(0, 199, 190)', ]; }
        function renderCategoryPieChart() { /* ... (unchanged) ... */ }
        function renderMonthlyBarChart() { /* ... (unchanged) ... */ }

        // --- Insights (Gemini API Call) ---
        getInsightsBtn.addEventListener('click', async () => {
            if (expenses.length === 0) {
                insightsDisplay.textContent = "Add some expenses first to get insights!";
                insightsDisplay.classList.remove('hidden');
                insightsDisplay.classList.add('bg-orange-100', 'text-orange-800', 'border-orange-300');
                return;
            }

            insightsDisplay.classList.remove('hidden', 'bg-orange-100', 'text-orange-800', 'border-orange-300', 'bg-red-100', 'text-red-800', 'border-red-300');
            insightsDisplay.classList.add('bg-purple-100', 'text-purple-800', 'border-purple-300');
            insightsDisplay.innerHTML = '<p class="font-medium">Analyzing your expenses...</p>';

            const expensesForGemini = expenses.map(e => {
                const baseData = {
                    date: e.date,
                    category: e.category,
                    amount: e.amount,
                    description: e.description
                };
                // Include custom fields in the data sent to Gemini
                appSettings.customFields.forEach(field => {
                    if (e[field.id] !== undefined) {
                        baseData[field.label] = e[field.id]; // Use label for clarity in prompt
                    }
                });
                return baseData;
            });

            const prompt = `Analyze the following monthly expenses and provide key insights, trends, or advice.
            Focus on categories where spending is highest, potential areas for savings, and any unusual patterns.
            Consider that the user lives in Ontario, Canada, and amounts are in CAD.
            
            Expenses:
            ${JSON.stringify(expensesForGemini, null, 2)}`;

            try {
                const response = await fetch('http://localhost:3000/generate-content', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ prompt: prompt })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                insightsDisplay.innerHTML = `<p class="font-medium">${data}</p>`;
                insightsDisplay.classList.remove('hidden');
                insightsDisplay.classList.remove('bg-purple-100', 'text-purple-800', 'border-purple-300');
                insightsDisplay.classList.add('bg-green-50', 'text-green-800', 'border-green-200');
            } catch (error) {
                console.error('Error fetching insights from Gemini API:', error);
                insightsDisplay.innerHTML = '<p class="font-medium">Failed to fetch insights. Please ensure your Gemini API proxy server is running and accessible.</p>';
                insightsDisplay.classList.remove('hidden', 'bg-purple-100', 'text-purple-800', 'border-purple-300');
                insightsDisplay.classList.add('bg-red-100', 'text-red-800', 'border-red-300');
            }
        });

        // --- Download CSV (modified for custom fields) ---
        function updateMonthDropdown() { /* ... (unchanged) ... */
            monthSelect.innerHTML = '<option value="">Select a month...</option>';
            const uniqueMonths = new Set();
            expenses.forEach(expense => {
                const date = new Date(expense.date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                const monthName = new Date(date.getFullYear(), date.getMonth(), 1).toLocaleString('en-CA', { month: 'long', year: 'numeric' });
                uniqueMonths.add(`${monthKey}|${monthName}`);
            });

            Array.from(uniqueMonths).sort().forEach(item => {
                const [value, text] = item.split('|');
                const option = document.createElement('option');
                option.value = value;
                option.textContent = text;
                monthSelect.appendChild(option);
            });
        }

        downloadCsvBtn.addEventListener('click', () => {
            const selectedMonthKey = monthSelect.value;
            if (!selectedMonthKey) {
                showMessage("Please select a month to download.", "info");
                return;
            }

            const filteredExpenses = expenses.filter(expense => {
                const date = new Date(expense.date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                return monthKey === selectedMonthKey;
            });

            if (filteredExpenses.length === 0) {
                showMessage("No expenses found for the selected month.", "info");
                return;
            }

            // CSV Headers
            let headers = ["Date", "Category", "Description", "Amount (CAD)", "Amount (AED)", "Amount (INR)", "Payment Method", "Paid By", "Has Bill?", "Bill Type"];
            appSettings.customFields.forEach(field => {
                headers.push(field.label); // Add custom field labels to headers
            });
            let csvContent = headers.map(h => `"${h.replace(/"/g, '""')}"`).join(',') + "\n";

            // CSV Rows
            filteredExpenses.forEach(expense => {
                const amountCAD = expense.amount.toFixed(2);
                const amountAED = (expense.amount * EXCHANGE_RATE_CAD_TO_AED).toFixed(2);
                const amountINR = (expense.amount * EXCHANGE_RATE_CAD_TO_INR).toFixed(2);
                const hasBillText = expense.hasBill ? 'Yes' : 'No';
                const billTypeText = expense.hasBill && expense.billType ? expense.billType : '';

                let rowData = [
                    expense.date,
                    expense.category,
                    expense.description,
                    amountCAD,
                    amountAED,
                    amountINR,
                    expense.paymentMethod,
                    expense.paidBy,
                    hasBillText,
                    billTypeText
                ];

                // Add custom field values
                appSettings.customFields.forEach(field => {
                    const fieldValue = expense[field.id] !== undefined ? expense[field.id] : '';
                    let displayValue = fieldValue;
                    if (field.type === 'checkbox') {
                        displayValue = fieldValue ? 'Yes' : 'No';
                    }
                    rowData.push(displayValue);
                });

                csvContent += rowData.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',') + "\n";
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const monthNameForFile = new Date(selectedMonthKey.split('-')[0], parseInt(selectedMonthKey.split('-')[1]) - 1, 1).toLocaleString('en-CA', { month: 'long', year: 'numeric' });
            link.setAttribute('href', url);
            link.setAttribute('download', `expenses_${monthNameForFile.replace(/\s/g, '_')}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showMessage(`Expenses for ${monthNameForFile} downloaded!`, 'success');
        });


        // Initialize current date input with today's date
        expenseDateInput.value = new Date().toISOString().split('T')[0];

        // Initial setup for the loading overlay (ensure it's shown before auth check completes)
        showLoading("Initializing app...");
    </script>
</body>
</html>
