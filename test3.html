<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 30px auto;
            background-color: #fff;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden; /* Clear floats for content */
        }

        h1, h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }

        .app-input {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .app-input:focus {
            border-color: #4CAF50;
            outline: none;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
        }

        .btn-primary {
            background-color: #4CAF50; /* Green */
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s ease, transform 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary:hover {
            background-color: #45a049;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: #f0f0f0;
            color: #555;
            padding: 12px 25px;
            border: 1px solid #ccc;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s ease, transform 0.2s ease, border-color 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-secondary:hover {
            background-color: #e0e0e0;
            transform: translateY(-2px);
            border-color: #bbb;
        }

        .btn-danger {
            background-color: #e74c3c; /* Red */
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .btn-danger:hover {
            background-color: #c0392b;
            transform: translateY(-1px);
        }

        .btn-info {
            background-color: #3498db;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s ease;
        }

        .btn-info:hover {
            background-color: #2980b9;
        }

        .expense-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #fdfdfd;
            border: 1px solid #eee;
            padding: 12px 20px;
            margin-bottom: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .expense-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
        }

        .expense-item span {
            flex-grow: 1;
            color: #555;
        }

        .expense-item .amount {
            font-weight: bold;
            color: #2c3e50;
            margin-left: 20px;
            white-space: nowrap; /* Prevent amount from wrapping */
        }

        .total-expenses {
            text-align: right;
            font-size: 1.3rem;
            font-weight: bold;
            color: #2c3e50;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px solid #eee;
        }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        /* --- Loading Spinner --- */
        #loadingSpinner {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1001;
            display: none; /* Hidden by default */
            border: 6px solid #f3f3f3; /* Light grey */
            border-top: 6px solid #4CAF50; /* Blue */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* --- Message Display (Toast) --- */
        /* Ensure message container has appropriate z-index and is well-defined */
        #messageContainer {
            position: fixed;
            bottom: 20px; /* Slightly higher from bottom */
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000; /* High z-index to be on top */
            display: flex; /* Use flex to center messages if needed */
            flex-direction: column;
            align-items: center;
            pointer-events: none; /* Allows clicks to pass through if no message */
        }

        .app-message {
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 500;
            margin-bottom: 8px; /* Space between multiple messages if they stack */
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            max-width: 90%; /* Max width to prevent overflow on small screens */
            text-align: center;
        }

        .app-message.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto; /* Allow interaction when active */
        }

        .message-success {
            background-color: #e6ffe6; /* Light green */
            color: #28a745; /* Darker green */
            border: 1px solid #28a745;
        }

        .message-error {
            background-color: #ffe6e6; /* Light red */
            color: #dc3545; /* Darker red */
            border: 1px solid #dc3545;
        }

        .message-info {
            background-color: #e6f7ff; /* Light blue */
            color: #007bff; /* Darker blue */
            border: 1px solid #007bff;
        }

        /* --- Header/Profile Dropdown --- */
        header {
            background-color: #ffffff;
            padding: 15px 25px;
            border-bottom: 1px solid #eee;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .profile-container {
            position: relative;
        }

        .profile-button {
            background-color: #f0f2f5;
            border: 1px solid #ddd;
            padding: 8px 15px;
            border-radius: 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            font-weight: 500;
            gap: 8px;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }

        .profile-button:hover {
            background-color: #e0e0e0;
            border-color: #ccc;
        }

        .profile-picture {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #ccc; /* Placeholder background */
            object-fit: cover;
        }

        .profile-dropdown-content {
            position: absolute;
            top: 100%; /* Position below the button */
            right: 0;
            background-color: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            min-width: 200px;
            z-index: 50;
            padding: 10px 0;
            display: none; /* Hidden by default */
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        .profile-dropdown-content.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .profile-dropdown-content button {
            display: block;
            width: 100%;
            padding: 10px 15px;
            text-align: left;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
            color: #333;
            transition: background-color 0.2s ease;
        }

        .profile-dropdown-content button:hover {
            background-color: #f5f5f5;
        }

        /* --- List Management --- */
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #fdfdfd;
            border: 1px solid #eee;
            padding: 10px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }

        .list-item:hover {
            background-color: #f5f5f5;
            border-color: #ddd;
        }

        .list-item.active-list {
            background-color: #e6ffe6; /* Light green for active list */
            border-color: #4CAF50;
            font-weight: 600;
        }

        .list-item span {
            flex-grow: 1;
            color: #444;
        }

        .list-actions {
            display: flex;
            gap: 5px;
            margin-left: 10px;
        }

        /* --- Splash Screen --- */
        .splash-screen-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200; /* Higher than modals */
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .splash-screen-container.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none; /* Allow clicks to pass through when hidden */
        }

        .welcome-card {
            background-color: #fff;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 500px;
            text-align: center;
        }

        /* Class to hide main app content initially */
        .hidden-app-content {
            display: none;
        }
    </style>
</head>
<body>
    <div id="splashScreen" class="splash-screen-container">
        <div class="welcome-card">
            <h1 class="text-3xl font-bold mb-6 text-center">Welcome to your Expense Tracker.</h1>
            <p class="text-gray-600 text-center mb-8">
                Sign in with your Google account to effortlessly track your spending, or proceed as a guest.
            </p>
            <button id="splashSignInButton" class="btn-primary w-full mb-4">Sign In with Google</button>
            <button id="splashGuestButton" class="btn-secondary w-full">Continue as Guest</button>
            <p class="text-gray-500 text-center text-sm mt-6">
                Guest data is temporary and not permanently stored. Consider signing in with Google for data persistence.
            </p>
            <p id="splashMessage" class="text-center text-sm text-blue-600 mt-4 hidden"></p>
        </div>
    </div>

    <div id="mainAppContent" class="hidden-app-content">
        <header>
            <div class="flex items-center">
                <h2 class="text-xl font-semibold mr-4">Expense Tracker</h2>
                <span id="currentListNameDisplay" class="text-gray-600 text-md">Loading...</span>
            </div>
            <div class="profile-container">
                <button id="profileButton" class="profile-button">
                    <img id="profilePicture" class="profile-picture" src="https://via.placeholder.com/32" alt="Profile">
                    <span id="profileDisplayName">Guest</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
                <div id="profileDropdownContent" class="profile-dropdown-content hidden">
                    <button id="createNewListButton">Create New List</button>
                    <button id="loadExistingListButton">Load Existing List</button>
                    <button id="deleteCurrentListButton" class="text-red-600 hover:bg-red-50">Delete Current List</button>
                    <button id="signOutButton">Sign Out</button>
                </div>
            </div>
        </header>

        <div class="container">
            <h2 class="text-2xl font-bold mb-6">Add New Expense</h2>
            <div class="mb-4">
                <input type="text" id="expenseDescription" class="app-input" placeholder="Expense description" required>
                <input type="number" id="expenseAmount" class="app-input" placeholder="Amount" step="0.01" required>
                <button id="addExpenseBtn" class="btn-primary w-full">Add Expense</button>
            </div>

            <h2 class="text-2xl font-bold mb-4">Your Expenses</h2>
            <div id="expensesList" class="space-y-3">
                <p id="noExpensesMessage" class="text-gray-500 text-center py-4">No expenses added yet. Start by adding one above!</p>
            </div>

            <div class="total-expenses">
                Total: <span id="totalAmount">0.00</span>
            </div>
        </div>
    </div>

    <div id="createNewListModal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="mb-4">Create New List</h2>
            <label for="newListNameInput" class="block text-sm font-medium text-gray-600 mb-1">List Name</label>
            <input type="text" id="newListNameInput" class="app-input mb-4" placeholder="e.g., Household Expenses, Vacation 2024">
            <div class="flex gap-4">
                <button id="createListConfirmBtn" class="btn-primary flex-grow">Create List</button>
                <button id="cancelCreateListBtn" class="btn-secondary flex-grow">Cancel</button>
            </div>
        </div>
    </div>

    <div id="loadExistingListModal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="mb-4">Load Existing List</h2>
            <div id="existingListsContainer" class="max-h-60 overflow-y-auto pr-2">
                <p id="noExistingListsMessage" class="text-gray-500 text-center py-4">No other lists found. Create a new one!</p>
            </div>
            <div class="flex justify-end mt-4">
                <button id="cancelLoadListBtn" class="btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <div id="loadingSpinner" style="display: none;"></div>

    <div id="messageContainer"></div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, deleteDoc, doc, setDoc, getDoc, getDocs, limit } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA_x5ENsCsHpcdYxgxi1a3vPs_vUR6Hkts",
  authDomain: "my-expenese-tracker.firebaseapp.com",
  projectId: "my-expenese-tracker",
  storageBucket: "my-expenese-tracker.firebasestorage.app",
  messagingSenderId: "466782350290",
  appId: "1:466782350290:web:3547d88edfc0969b23b60b",
  measurementId: "G-1CF1ZNLPC2"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // --- Global Variables ---
        let currentUserId = null;
        let currentListId = null;
        let currentListName = 'Default List';
        let expenses = [];
        let unsubscribeFromExpenses = null; // To manage Firestore subscription

        // --- DOM Elements ---
        const profileButton = document.getElementById('profileButton');
        const profileDisplayName = document.getElementById('profileDisplayName');
        const profilePicture = document.getElementById('profilePicture');
        const profileDropdownContent = document.getElementById('profileDropdownContent');
        // const authButton = document.getElementById('authButton'); // Removed: login now on splash screen
        const signOutButton = document.getElementById('signOutButton');
        const createNewListButton = document.getElementById('createNewListButton');
        const loadExistingListButton = document.getElementById('loadExistingListButton');
        const deleteCurrentListButton = document.getElementById('deleteCurrentListButton');

        const currentListNameDisplay = document.getElementById('currentListNameDisplay');
        const expenseDescriptionInput = document.getElementById('expenseDescription');
        const expenseAmountInput = document.getElementById('expenseAmount');
        const addExpenseBtn = document.getElementById('addExpenseBtn');
        const expensesList = document.getElementById('expensesList');
        const totalAmountSpan = document.getElementById('totalAmount');
        const noExpensesMessage = document.getElementById('noExpensesMessage');

        // --- Modals ---
        const createNewListModal = document.getElementById('createNewListModal');
        const newListNameInput = document.getElementById('newListNameInput');
        const createListConfirmBtn = document.getElementById('createListConfirmBtn');
        const cancelCreateListBtn = document.getElementById('cancelCreateListBtn');

        const loadExistingListModal = document.getElementById('loadExistingListModal');
        const existingListsContainer = document.getElementById('existingListsContainer');
        const noExistingListsMessage = document.getElementById('noExistingListsMessage');
        const cancelLoadListBtn = document.getElementById('cancelLoadListBtn');

        const loadingSpinner = document.getElementById('loadingSpinner');
        const messageContainer = document.getElementById('messageContainer');

        // --- Splash Screen Elements ---
        const splashScreen = document.getElementById('splashScreen');
        const splashSignInButton = document.getElementById('splashSignInButton');
        const splashGuestButton = document.getElementById('splashGuestButton');
        const splashMessage = document.getElementById('splashMessage');
        const mainAppContent = document.getElementById('mainAppContent');


        // --- Utility Functions ---

        function showLoading(message = "Loading...") {
            loadingSpinner.style.display = 'block';
            // Optionally, you could display the message near the spinner or in the console
            console.log(message);
        }

        function hideLoading() {
            loadingSpinner.style.display = 'none';
        }

        function showMessage(message, type = 'info') {
            // Clear any existing messages before showing a new one
            messageContainer.innerHTML = ''; 

            const messageElement = document.createElement('div');
            messageElement.textContent = message;
            messageElement.className = `app-message ${
                type === 'success' ? 'message-success' :
                type === 'error' ? 'message-error' :
                'message-info'
            }`;
            
            messageContainer.appendChild(messageElement);

            // Trigger reflow to ensure transition works
            messageElement.offsetHeight; 

            messageElement.classList.add('active');

            setTimeout(() => {
                messageElement.classList.remove('active');
                messageElement.addEventListener('transitionend', () => messageElement.remove(), { once: true });
            }, 3000); // Message disappears after 3 seconds
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }

        function updateCurrentListNameDisplay() {
            currentListNameDisplay.textContent = `List: ${currentListName}`;
        }

        // --- Authentication ---

        profileButton.addEventListener('click', () => {
            profileDropdownContent.classList.toggle('hidden');
            profileDropdownContent.classList.toggle('active');
        });

        // Close dropdown if clicked outside
        window.addEventListener('click', (e) => {
            if (!profileButton.contains(e.target) && !profileDropdownContent.contains(e.target)) {
                profileDropdownContent.classList.add('hidden');
                profileDropdownContent.classList.remove('active');
            }
        });

        // Sign In from Splash Screen
        splashSignInButton.addEventListener('click', async () => {
            showLoading("Signing in...");
            try {
                await signInWithPopup(auth, provider);
                // onAuthStateChanged will handle UI update and hide splash screen
            } catch (error) {
                console.error("Authentication failed:", error);
                // Display error on splash screen
                splashMessage.textContent = "Sign-in failed. Please try again.";
                splashMessage.classList.remove('hidden');
                showMessage("Sign-in failed. Please try again.", "error"); // Also show toast
            } finally {
                hideLoading();
            }
        });

        // Continue as Guest from Splash Screen
        splashGuestButton.addEventListener('click', () => {
            currentUserId = "guest_" + Date.now(); // Simple unique ID for guest session
            currentListId = "guest_default_" + currentUserId; // Unique list ID for guest
            currentListName = 'Guest List';
            
            // Show main app content
            splashScreen.classList.add('hidden');
            mainAppContent.classList.remove('hidden-app-content');
            
            // Set guest UI state
            profileDisplayName.textContent = 'Guest';
            profilePicture.src = 'https://via.placeholder.com/32';
            signOutButton.classList.remove('hidden'); // Guest can sign out (which takes them back to splash)
            createNewListButton.classList.add('hidden'); // Guest cannot create/load/delete persistent lists
            loadExistingListButton.classList.add('hidden');
            deleteCurrentListButton.classList.add('hidden');

            // Initialize guest experience (no Firestore persistence for true guests)
            expenses = [];
            renderExpenses();
            totalAmountSpan.textContent = formatCurrency(0);
            updateCurrentListNameDisplay();
            showMessage("You are viewing as a Guest. Sign in to save your data.", "info");
            hideLoading(); // If loading was shown
        });


        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                profileDisplayName.textContent = user.displayName || user.email || 'User';
                profilePicture.src = user.photoURL || 'https://via.placeholder.com/32';
                signOutButton.classList.remove('hidden');
                createNewListButton.classList.remove('hidden');
                loadExistingListButton.classList.remove('hidden');
                deleteCurrentListButton.classList.remove('hidden');
                
                // Hide splash screen and show main app
                splashScreen.classList.add('hidden');
                mainAppContent.classList.remove('hidden-app-content');

                await ensureUserHasList(currentUserId);

            } else {
                // User is not logged in (or just signed out)
                currentUserId = null;
                currentListId = null;
                currentListName = 'Default List'; // Reset for fresh state if not logged in
                expenses = [];
                renderExpenses();
                totalAmountSpan.textContent = formatCurrency(0);
                updateCurrentListNameDisplay(); // Update display to 'Default List' if not signed in

                profileDisplayName.textContent = 'Guest';
                profilePicture.src = 'https://via.placeholder.com/32';
                signOutButton.classList.add('hidden'); // Hide sign out button for a not-yet-signed-in state
                createNewListButton.classList.add('hidden'); 
                loadExistingListButton.classList.add('hidden');
                deleteCurrentListButton.classList.add('hidden');

                if (unsubscribeFromExpenses) {
                    unsubscribeFromExpenses(); // Detach listener when user signs out
                }
                
                // Show the splash screen
                splashScreen.classList.remove('hidden');
                mainAppContent.classList.add('hidden-app-content');
                splashMessage.textContent = ""; // Clear any previous messages on splash
            }
            hideLoading();
        });

        signOutButton.addEventListener('click', async () => {
            profileDropdownContent.classList.add('hidden');
            profileDropdownContent.classList.remove('active');
            showLoading("Signing out...");
            try {
                await signOut(auth);
                // onAuthStateChanged will handle UI update and show splash screen
                showMessage("Signed out successfully!", "success"); // Provide immediate feedback
            } catch (error) {
                console.error("Sign out failed:", error);
                showMessage("Sign-out failed. Please try again.", "error");
            } finally {
                hideLoading();
            }
        });


        // --- List Management Functions ---

        async function ensureUserHasList(userId) {
            showLoading("Checking your lists...");
            try {
                const q = query(collection(db, `users/${userId}/lists`), orderBy("lastAccessed", "desc"), limit(1));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    console.log("No lists found for user. Creating a default list.");
                    const defaultListName = "My First List";
                    const newListRef = doc(collection(db, `users/${userId}/lists`));
                    await setDoc(newListRef, {
                        name: defaultListName,
                        createdAt: new Date(),
                        lastAccessed: new Date()
                    });
                    
                    currentListId = newListRef.id;
                    currentListName = defaultListName;
                    showMessage(`Created "${defaultListName}" for you!`, "info");
                } else {
                    const lastAccessedList = querySnapshot.docs[0];
                    currentListId = lastAccessedList.id;
                    currentListName = lastAccessedList.data().name;
                    showMessage(`Loading "${currentListName}"...`, "info");
                }
                updateCurrentListNameDisplay();
                listenToExpenses(currentListId);
            } catch (error) {
                console.error("Error ensuring user has a list:", error);
                showMessage("Error managing lists. Please try again.", "error");
                currentListName = 'Default List';
                updateCurrentListNameDisplay();
            } finally {
                hideLoading();
            }
        }

        async function switchToList(listId, listName) {
            showLoading(`Switching to ${listName}...`);
            currentListId = listId;
            currentListName = listName;
            updateCurrentListNameDisplay(); 
            
            try {
                await setDoc(doc(db, `users/${currentUserId}/lists`, currentListId), { lastAccessed: new Date() }, { merge: true });
            } catch (error) {
                console.warn("Could not update lastAccessed for list:", error);
            }

            listenToExpenses(currentListId); 
            
            expenses = [];
            renderExpenses();
            showMessage(`Switched to "${listName}".`, "success");
            hideLoading();
        }

        // --- Create New List Modal Logic ---
        createNewListButton.addEventListener('click', () => {
            profileDropdownContent.classList.add('hidden'); // Hide profile dropdown
            profileDropdownContent.classList.remove('active');
            newListNameInput.value = ''; // Clear previous input
            createNewListModal.classList.add('active');
            newListNameInput.focus();
        });

        cancelCreateListBtn.addEventListener('click', () => {
            createNewListModal.classList.remove('active');
        });

        createListConfirmBtn.addEventListener('click', async () => {
            const listName = newListNameInput.value.trim();
            if (!listName) {
                showMessage("Please enter a list name.", "error");
                return;
            }
            if (!currentUserId) {
                showMessage("Please sign in to create a new list.", "error");
                return;
            }

            showLoading("Creating new list...");
            try {
                const newListRef = doc(collection(db, `users/${currentUserId}/lists`));
                await setDoc(newListRef, {
                    name: listName,
                    createdAt: new Date(),
                    lastAccessed: new Date()
                });
                showMessage(`List "${listName}" created successfully!`, "success");
                createNewListModal.classList.remove('active');
                await switchToList(newListRef.id, listName); // Switch to the newly created list
            } catch (error) {
                console.error("Error creating new list:", error);
                showMessage("Failed to create list. Please try again.", "error");
            } finally {
                hideLoading();
            }
        });

        // --- Load Existing List Modal Logic ---
        loadExistingListButton.addEventListener('click', async () => {
            if (!currentUserId) {
                showMessage("Please sign in to load your lists.", "info");
                return;
            }
            profileDropdownContent.classList.add('hidden'); // Hide profile dropdown
            profileDropdownContent.classList.remove('active');
            await renderExistingLists(); // Populate the list of existing lists
            loadExistingListModal.classList.add('active');
        });

        cancelLoadListBtn.addEventListener('click', () => {
            loadExistingListModal.classList.remove('active');
        });

        async function renderExistingLists() {
            existingListsContainer.innerHTML = '';
            noExistingListsMessage.classList.add('hidden');

            if (!currentUserId) {
                noExistingListsMessage.classList.remove('hidden');
                return;
            }

            showLoading("Loading lists...");
            try {
                const q = query(collection(db, `users/${currentUserId}/lists`), orderBy("lastAccessed", "desc"));
                const querySnapshot = await getDocs(q);


                if (querySnapshot.empty) {
                    noExistingListsMessage.classList.remove('hidden');
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const list = { id: doc.id, ...doc.data() };
                    const listItem = document.createElement('div');
                    listItem.className = `list-item ${list.id === currentListId ? 'active-list' : ''}`;
                    listItem.dataset.listId = list.id;
                    listItem.dataset.listName = list.name;

                    listItem.innerHTML = `
                        <span>${list.name}</span>
                        <button class="btn-secondary text-sm px-3 py-1 ml-2">Load</button>
                    `;
                    listItem.querySelector('button').addEventListener('click', async () => {
                        await switchToList(list.id, list.name);
                        loadExistingListModal.classList.remove('active');
                    });
                    listItem.addEventListener('click', async (e) => {
                        if (e.target.tagName !== 'BUTTON') {
                             await switchToList(list.id, list.name);
                             loadExistingListModal.classList.remove('active');
                        }
                    });

                    existingListsContainer.appendChild(listItem);
                });
                showMessage("Lists loaded!", "info");
            } catch (error) {
                console.error("Error loading existing lists:", error);
                showMessage("Failed to load existing lists.", "error");
                noExistingListsMessage.classList.remove('hidden');
            } finally {
                hideLoading();
            }
        }

        // --- Delete Current List Logic ---
        deleteCurrentListButton.addEventListener('click', async () => {
            if (!currentUserId || !currentListId) {
                showMessage("No list is selected to delete.", "info");
                return;
            }

            // Confirm with user
            if (confirm(`Are you sure you want to delete the list "${currentListName}" and all its expenses? This action cannot be undone.`)) {
                showLoading(`Deleting "${currentListName}"...`);
                try {
                    // Delete all expenses in the list first
                    const expensesQuery = query(collection(db, `users/${currentUserId}/lists/${currentListId}/expenses`));
                    const expensesSnapshot = await getDocs(expensesQuery);
                    const deleteExpensePromises = [];
                    expensesSnapshot.forEach((expDoc) => {
                        deleteExpensePromises.push(deleteDoc(doc(db, `users/${currentUserId}/lists/${currentListId}/expenses`, expDoc.id)));
                    });
                    await Promise.all(deleteExpensePromises);

                    // Then delete the list document itself
                    await deleteDoc(doc(db, `users/${currentUserId}/lists`, currentListId));

                    showMessage(`List "${currentListName}" deleted successfully!`, "success");

                    // After deletion, re-evaluate user's lists and potentially load a new default
                    currentListId = null; // Clear current list context
                    await ensureUserHasList(currentUserId); // This will create a new default if no other lists exist or load another

                } catch (error) {
                    console.error("Error deleting list:", error);
                    showMessage("Failed to delete list. Please try again.", "error");
                } finally {
                    hideLoading();
                }
            }
            profileDropdownContent.classList.add('hidden'); // Hide profile dropdown
            profileDropdownContent.classList.remove('active');
        });


        // --- Expense Tracking Functions ---

        addExpenseBtn.addEventListener('click', async () => {
            if (!currentUserId || !currentListId) {
                showMessage("Please sign in and ensure a list is selected.", "info");
                return;
            }

            const description = expenseDescriptionInput.value.trim();
            const amount = parseFloat(expenseAmountInput.value);

            if (description === '' || isNaN(amount) || amount <= 0) {
                showMessage('Please enter a valid description and a positive amount.', 'error');
                return;
            }

            showLoading("Adding expense...");
            try {
                await addDoc(collection(db, `users/${currentUserId}/lists/${currentListId}/expenses`), {
                    description: description,
                    amount: amount,
                    timestamp: new Date() // Store timestamp for ordering
                });
                expenseDescriptionInput.value = '';
                expenseAmountInput.value = '';
                // showMessage('Expense added successfully!', 'success'); // onSnapshot will trigger message
            } catch (e) {
                console.error("Error adding document: ", e);
                showMessage('Failed to add expense. Please try again.', 'error');
            } finally {
                hideLoading();
            }
        });

        // Function to listen to expenses in real-time
        function listenToExpenses(listId) {
            if (unsubscribeFromExpenses) {
                unsubscribeFromExpenses(); // Detach old listener
            }
            
            if (!currentUserId || !listId) {
                console.warn("Cannot listen to expenses: currentUserId or listId is missing.");
                expenses = [];
                renderExpenses(); // Clear table
                return;
            }

            showLoading(`Loading expenses for ${currentListName}...`);
            const q = query(collection(db, `users/${currentUserId}/lists/${listId}/expenses`), orderBy("timestamp", "desc"));
            
            unsubscribeFromExpenses = onSnapshot(q, (snapshot) => {
                const fetchedExpenses = [];
                let total = 0;
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    fetchedExpenses.push({ id: doc.id, ...data });
                    total += data.amount;
                });
                expenses = fetchedExpenses;
                renderExpenses();
                totalAmountSpan.textContent = formatCurrency(total);
                hideLoading();
                showMessage('Expenses synchronized from cloud!', 'success');
            }, (error) => {
                console.error("Error fetching Firestore expenses:", error);
                showMessage("Error loading expenses. Check console for details.", "error");
                hideLoading();
            });
        }

        // Function to render expenses to the UI
        function renderExpenses() {
            expensesList.innerHTML = '';
            if (expenses.length === 0) {
                noExpensesMessage.classList.remove('hidden');
            } else {
                noExpensesMessage.classList.add('hidden');
                expenses.forEach(expense => {
                    const expenseItem = document.createElement('div');
                    expenseItem.className = 'expense-item';
                    expenseItem.innerHTML = `
                        <span>${expense.description}</span>
                        <span class="amount">${formatCurrency(expense.amount)}</span>
                        <button class="btn-danger ml-4" data-id="${expense.id}">Delete</button>
                    `;
                    expensesList.appendChild(expenseItem);
                });

                // Add event listeners to delete buttons
                document.querySelectorAll('.btn-danger').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const expenseId = e.target.dataset.id;
                        if (confirm('Are you sure you want to delete this expense?')) {
                            showLoading("Deleting expense...");
                            try {
                                if (currentUserId && currentListId) {
                                    await deleteDoc(doc(db, `users/${currentUserId}/lists/${currentListId}/expenses`, expenseId));
                                    // showMessage('Expense deleted successfully!', 'success'); // onSnapshot will trigger message
                                } else {
                                    showMessage("Cannot delete: not signed in or no list selected.", "error");
                                }
                            } catch (error) {
                                console.error("Error deleting expense:", error);
                                showMessage('Failed to delete expense. Please try again.', 'error');
                            } finally {
                                hideLoading();
                            }
                        }
                    });
                });
            }
        }

        // Initial call to update current list name display
        // This will be overridden by onAuthStateChanged, but good for initial setup.
        updateCurrentListNameDisplay();
    </script>
</body>
</html>
